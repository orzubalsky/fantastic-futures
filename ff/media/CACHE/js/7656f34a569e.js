(function(b,f){b.fn.jPlayer=function(a){var c="string"===typeof a,d=Array.prototype.slice.call(arguments,1),e=this,a=!c&&d.length?b.extend.apply(null,[!0,a].concat(d)):a;if(c&&"_"===a.charAt(0))return e;c?this.each(function(){var c=b.data(this,"jPlayer"),h=c&&b.isFunction(c[a])?c[a].apply(c,d):c;if(h!==c&&h!==f)return e=h,!1}):this.each(function(){var c=b.data(this,"jPlayer");c?c.option(a||{}):b.data(this,"jPlayer",new b.jPlayer(a,this))});return e};b.jPlayer=function(a,c){if(arguments.length){this.element=b(c);this.options=b.extend(!0,{},this.options,a);var d=this;this.element.bind("remove.jPlayer",function(){d.destroy()});this._init()}};b.jPlayer.emulateMethods="load play pause";b.jPlayer.emulateStatus="src readyState networkState currentTime duration paused ended playbackRate";b.jPlayer.emulateOptions="muted volume";b.jPlayer.reservedEvent="ready flashreset resize repeat error warning";b.jPlayer.event={ready:"jPlayer_ready",flashreset:"jPlayer_flashreset",resize:"jPlayer_resize",repeat:"jPlayer_repeat",click:"jPlayer_click",error:"jPlayer_error",warning:"jPlayer_warning",loadstart:"jPlayer_loadstart",progress:"jPlayer_progress",suspend:"jPlayer_suspend",abort:"jPlayer_abort",emptied:"jPlayer_emptied",stalled:"jPlayer_stalled",play:"jPlayer_play",pause:"jPlayer_pause",loadedmetadata:"jPlayer_loadedmetadata",loadeddata:"jPlayer_loadeddata",waiting:"jPlayer_waiting",playing:"jPlayer_playing",canplay:"jPlayer_canplay",canplaythrough:"jPlayer_canplaythrough",seeking:"jPlayer_seeking",seeked:"jPlayer_seeked",timeupdate:"jPlayer_timeupdate",ended:"jPlayer_ended",ratechange:"jPlayer_ratechange",durationchange:"jPlayer_durationchange",volumechange:"jPlayer_volumechange"};b.jPlayer.htmlEvent="loadstart abort emptied stalled loadedmetadata loadeddata canplay canplaythrough ratechange".split(" ");b.jPlayer.pause=function(){b.each(b.jPlayer.prototype.instances,function(a,c){c.data("jPlayer").status.srcSet&&c.jPlayer("pause")})};b.jPlayer.timeFormat={showHour:!1,showMin:!0,showSec:!0,padHour:!1,padMin:!0,padSec:!0,sepHour:":",sepMin:":",sepSec:""};b.jPlayer.convertTime=function(a){var c=new Date(1E3*a),d=c.getUTCHours(),a=c.getUTCMinutes(),c=c.getUTCSeconds(),d=b.jPlayer.timeFormat.padHour&&10>d?"0"+d:d,a=b.jPlayer.timeFormat.padMin&&10>a?"0"+a:a,c=b.jPlayer.timeFormat.padSec&&10>c?"0"+c:c;return(b.jPlayer.timeFormat.showHour?d+b.jPlayer.timeFormat.sepHour:"")+(b.jPlayer.timeFormat.showMin?a+b.jPlayer.timeFormat.sepMin:"")+(b.jPlayer.timeFormat.showSec?c+b.jPlayer.timeFormat.sepSec:"")};b.jPlayer.uaBrowser=function(a){var a=a.toLowerCase(),c=/(opera)(?:.*version)?[ \/]([\w.]+)/,b=/(msie) ([\w.]+)/,e=/(mozilla)(?:.*? rv:([\w.]+))?/,a=/(webkit)[ \/]([\w.]+)/.exec(a)||c.exec(a)||b.exec(a)||0>a.indexOf("compatible")&&e.exec(a)||[];return{browser:a[1]||"",version:a[2]||"0"}};b.jPlayer.uaPlatform=function(a){var b=a.toLowerCase(),d=/(android)/,e=/(mobile)/,a=/(ipad|iphone|ipod|android|blackberry|playbook|windows ce|webos)/.exec(b)||[],b=/(ipad|playbook)/.exec(b)||!e.exec(b)&&d.exec(b)||[];a[1]&&(a[1]=a[1].replace(/\s/g,"_"));return{platform:a[1]||"",tablet:b[1]||""}};b.jPlayer.browser={};b.jPlayer.platform={};var i=b.jPlayer.uaBrowser(navigator.userAgent);i.browser&&(b.jPlayer.browser[i.browser]=!0,b.jPlayer.browser.version=i.version);i=b.jPlayer.uaPlatform(navigator.userAgent);i.platform&&(b.jPlayer.platform[i.platform]=!0,b.jPlayer.platform.mobile=!i.tablet,b.jPlayer.platform.tablet=!!i.tablet);b.jPlayer.prototype={count:0,version:{script:"2.2.0",needFlash:"2.2.0",flash:"unknown"},options:{swfPath:"js",solution:"html, flash",supplied:"mp3",preload:"metadata",volume:0.8,muted:!1,wmode:"opaque",backgroundColor:"#000000",cssSelectorAncestor:"#jp_container_1",cssSelector:{videoPlay:".jp-video-play",play:".jp-play",pause:".jp-pause",stop:".jp-stop",seekBar:".jp-seek-bar",playBar:".jp-play-bar",mute:".jp-mute",unmute:".jp-unmute",volumeBar:".jp-volume-bar",volumeBarValue:".jp-volume-bar-value",volumeMax:".jp-volume-max",currentTime:".jp-current-time",duration:".jp-duration",fullScreen:".jp-full-screen",restoreScreen:".jp-restore-screen",repeat:".jp-repeat",repeatOff:".jp-repeat-off",gui:".jp-gui",noSolution:".jp-no-solution"},fullScreen:!1,autohide:{restored:!1,full:!0,fadeIn:200,fadeOut:600,hold:1E3},loop:!1,repeat:function(a){a.jPlayer.options.loop?b(this).unbind(".jPlayerRepeat").bind(b.jPlayer.event.ended+".jPlayer.jPlayerRepeat",function(){b(this).jPlayer("play")}):b(this).unbind(".jPlayerRepeat")},nativeVideoControls:{},noFullScreen:{msie:/msie [0-6]/,ipad:/ipad.*?os [0-4]/,iphone:/iphone/,ipod:/ipod/,android_pad:/android [0-3](?!.*?mobile)/,android_phone:/android.*?mobile/,blackberry:/blackberry/,windows_ce:/windows ce/,webos:/webos/},noVolume:{ipad:/ipad/,iphone:/iphone/,ipod:/ipod/,android_pad:/android(?!.*?mobile)/,android_phone:/android.*?mobile/,blackberry:/blackberry/,windows_ce:/windows ce/,webos:/webos/,playbook:/playbook/},verticalVolume:!1,idPrefix:"jp",noConflict:"jQuery",emulateHtml:!1,errorAlerts:!1,warningAlerts:!1},optionsAudio:{size:{width:"0px",height:"0px",cssClass:""},sizeFull:{width:"0px",height:"0px",cssClass:""}},optionsVideo:{size:{width:"480px",height:"270px",cssClass:"jp-video-270p"},sizeFull:{width:"100%",height:"100%",cssClass:"jp-video-full"}},instances:{},status:{src:"",media:{},paused:!0,format:{},formatType:"",waitForPlay:!0,waitForLoad:!0,srcSet:!1,video:!1,seekPercent:0,currentPercentRelative:0,currentPercentAbsolute:0,currentTime:0,duration:0,readyState:0,networkState:0,playbackRate:1,ended:0},internal:{ready:!1},solution:{html:!0,flash:!0},format:{mp3:{codec:'audio/mpeg; codecs="mp3"',flashCanPlay:!0,media:"audio"},m4a:{codec:'audio/mp4; codecs="mp4a.40.2"',flashCanPlay:!0,media:"audio"},oga:{codec:'audio/ogg; codecs="vorbis"',flashCanPlay:!1,media:"audio"},wav:{codec:'audio/wav; codecs="1"',flashCanPlay:!1,media:"audio"},webma:{codec:'audio/webm; codecs="vorbis"',flashCanPlay:!1,media:"audio"},fla:{codec:"audio/x-flv",flashCanPlay:!0,media:"audio"},rtmpa:{codec:'audio/rtmp; codecs="rtmp"',flashCanPlay:!0,media:"audio"},m4v:{codec:'video/mp4; codecs="avc1.42E01E, mp4a.40.2"',flashCanPlay:!0,media:"video"},ogv:{codec:'video/ogg; codecs="theora, vorbis"',flashCanPlay:!1,media:"video"},webmv:{codec:'video/webm; codecs="vorbis, vp8"',flashCanPlay:!1,media:"video"},flv:{codec:"video/x-flv",flashCanPlay:!0,media:"video"},rtmpv:{codec:'video/rtmp; codecs="rtmp"',flashCanPlay:!0,media:"video"}},_init:function(){var a=this;this.element.empty();this.status=b.extend({},this.status);this.internal=b.extend({},this.internal);this.internal.domNode=this.element.get(0);this.formats=[];this.solutions=[];this.require={};this.htmlElement={};this.html={};this.html.audio={};this.html.video={};this.flash={};this.css={};this.css.cs={};this.css.jq={};this.ancestorJq=[];this.options.volume=this._limitValue(this.options.volume,0,1);b.each(this.options.supplied.toLowerCase().split(","),function(c,d){var e=d.replace(/^\s+|\s+$/g,"");if(a.format[e]){var f=false;b.each(a.formats,function(a,b){if(e===b){f=true;return false}});f||a.formats.push(e)}});b.each(this.options.solution.toLowerCase().split(","),function(c,d){var e=d.replace(/^\s+|\s+$/g,"");if(a.solution[e]){var f=false;b.each(a.solutions,function(a,b){if(e===b){f=true;return false}});f||a.solutions.push(e)}});this.internal.instance="jp_"+this.count;this.instances[this.internal.instance]=this.element;this.element.attr("id")||this.element.attr("id",this.options.idPrefix+"_jplayer_"+this.count);this.internal.self=b.extend({},{id:this.element.attr("id"),jq:this.element});this.internal.audio=b.extend({},{id:this.options.idPrefix+"_audio_"+this.count,jq:f});this.internal.video=b.extend({},{id:this.options.idPrefix+"_video_"+this.count,jq:f});this.internal.flash=b.extend({},{id:this.options.idPrefix+"_flash_"+this.count,jq:f,swf:this.options.swfPath+(this.options.swfPath.toLowerCase().slice(-4)!==".swf"?(this.options.swfPath&&this.options.swfPath.slice(-1)!=="/"?"/":"")+"Jplayer.swf":"")});this.internal.poster=b.extend({},{id:this.options.idPrefix+"_poster_"+this.count,jq:f});b.each(b.jPlayer.event,function(b,c){if(a.options[b]!==f){a.element.bind(c+".jPlayer",a.options[b]);a.options[b]=f}});this.require.audio=false;this.require.video=false;b.each(this.formats,function(b,c){a.require[a.format[c].media]=true});this.options=this.require.video?b.extend(true,{},this.optionsVideo,this.options):b.extend(true,{},this.optionsAudio,this.options);this._setSize();this.status.nativeVideoControls=this._uaBlocklist(this.options.nativeVideoControls);this.status.noFullScreen=this._uaBlocklist(this.options.noFullScreen);this.status.noVolume=this._uaBlocklist(this.options.noVolume);this._restrictNativeVideoControls();this.htmlElement.poster=document.createElement("img");this.htmlElement.poster.id=this.internal.poster.id;this.htmlElement.poster.onload=function(){(!a.status.video||a.status.waitForPlay)&&a.internal.poster.jq.show()};this.element.append(this.htmlElement.poster);this.internal.poster.jq=b("#"+this.internal.poster.id);this.internal.poster.jq.css({width:this.status.width,height:this.status.height});this.internal.poster.jq.hide();this.internal.poster.jq.bind("click.jPlayer",function(){a._trigger(b.jPlayer.event.click)});this.html.audio.available=false;if(this.require.audio){this.htmlElement.audio=document.createElement("audio");this.htmlElement.audio.id=this.internal.audio.id;this.html.audio.available=!!this.htmlElement.audio.canPlayType&&this._testCanPlayType(this.htmlElement.audio)}this.html.video.available=false;if(this.require.video){this.htmlElement.video=document.createElement("video");this.htmlElement.video.id=this.internal.video.id;this.html.video.available=!!this.htmlElement.video.canPlayType&&this._testCanPlayType(this.htmlElement.video)}this.flash.available=this._checkForFlash(10);this.html.canPlay={};this.flash.canPlay={};b.each(this.formats,function(b,c){a.html.canPlay[c]=a.html[a.format[c].media].available&&""!==a.htmlElement[a.format[c].media].canPlayType(a.format[c].codec);a.flash.canPlay[c]=a.format[c].flashCanPlay&&a.flash.available});this.html.desired=false;this.flash.desired=false;b.each(this.solutions,function(c,d){if(c===0)a[d].desired=true;else{var e=false,f=false;b.each(a.formats,function(b,c){a[a.solutions[0]].canPlay[c]&&(a.format[c].media==="video"?f=true:e=true)});a[d].desired=a.require.audio&&!e||a.require.video&&!f}});this.html.support={};this.flash.support={};b.each(this.formats,function(b,c){a.html.support[c]=a.html.canPlay[c]&&a.html.desired;a.flash.support[c]=a.flash.canPlay[c]&&a.flash.desired});this.html.used=false;this.flash.used=false;b.each(this.solutions,function(c,d){b.each(a.formats,function(b,c){if(a[d].support[c]){a[d].used=true;return false}})});this._resetActive();this._resetGate();this._cssSelectorAncestor(this.options.cssSelectorAncestor);if(!this.html.used&&!this.flash.used){this._error({type:b.jPlayer.error.NO_SOLUTION,context:"{solution:'"+this.options.solution+"', supplied:'"+this.options.supplied+"'}",message:b.jPlayer.errorMsg.NO_SOLUTION,hint:b.jPlayer.errorHint.NO_SOLUTION});this.css.jq.noSolution.length&&this.css.jq.noSolution.show()}else this.css.jq.noSolution.length&&this.css.jq.noSolution.hide();if(this.flash.used){var c,d="jQuery="+encodeURI(this.options.noConflict)+"&id="+encodeURI(this.internal.self.id)+"&vol="+this.options.volume+"&muted="+this.options.muted;if(b.jPlayer.browser.msie&&Number(b.jPlayer.browser.version)<=8){d=['<param name="movie" value="'+this.internal.flash.swf+'" />','<param name="FlashVars" value="'+d+'" />','<param name="allowScriptAccess" value="always" />','<param name="bgcolor" value="'+this.options.backgroundColor+'" />','<param name="wmode" value="'+this.options.wmode+'" />'];c=document.createElement('<object id="'+this.internal.flash.id+'" classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000" width="0" height="0"></object>');for(var e=0;e<d.length;e++)c.appendChild(document.createElement(d[e]))}else{e=function(a,b,c){var d=document.createElement("param");d.setAttribute("name",b);d.setAttribute("value",c);a.appendChild(d)};c=document.createElement("object");c.setAttribute("id",this.internal.flash.id);c.setAttribute("data",this.internal.flash.swf);c.setAttribute("type","application/x-shockwave-flash");c.setAttribute("width","1");c.setAttribute("height","1");e(c,"flashvars",d);e(c,"allowscriptaccess","always");e(c,"bgcolor",this.options.backgroundColor);e(c,"wmode",this.options.wmode)}this.element.append(c);this.internal.flash.jq=b(c)}if(this.html.used){if(this.html.audio.available){this._addHtmlEventListeners(this.htmlElement.audio,this.html.audio);this.element.append(this.htmlElement.audio);this.internal.audio.jq=b("#"+this.internal.audio.id)}if(this.html.video.available){this._addHtmlEventListeners(this.htmlElement.video,this.html.video);this.element.append(this.htmlElement.video);this.internal.video.jq=b("#"+this.internal.video.id);this.status.nativeVideoControls?this.internal.video.jq.css({width:this.status.width,height:this.status.height}):this.internal.video.jq.css({width:"0px",height:"0px"});this.internal.video.jq.bind("click.jPlayer",function(){a._trigger(b.jPlayer.event.click)})}}this.options.emulateHtml&&this._emulateHtmlBridge();this.html.used&&!this.flash.used&&setTimeout(function(){a.internal.ready=true;a.version.flash="n/a";a._trigger(b.jPlayer.event.repeat);a._trigger(b.jPlayer.event.ready)},100);this._updateNativeVideoControls();this._updateInterface();this._updateButtons(false);this._updateAutohide();this._updateVolume(this.options.volume);this._updateMute(this.options.muted);this.css.jq.videoPlay.length&&this.css.jq.videoPlay.hide();b.jPlayer.prototype.count++},destroy:function(){this.clearMedia();this._removeUiClass();this.css.jq.currentTime.length&&this.css.jq.currentTime.text("");this.css.jq.duration.length&&this.css.jq.duration.text("");b.each(this.css.jq,function(a,b){b.length&&b.unbind(".jPlayer")});this.internal.poster.jq.unbind(".jPlayer");this.internal.video.jq&&this.internal.video.jq.unbind(".jPlayer");this.options.emulateHtml&&this._destroyHtmlBridge();this.element.removeData("jPlayer");this.element.unbind(".jPlayer");this.element.empty();delete this.instances[this.internal.instance]},enable:function(){},disable:function(){},_testCanPlayType:function(a){try{a.canPlayType(this.format.mp3.codec);return true}catch(b){return false}},_uaBlocklist:function(a){var c=navigator.userAgent.toLowerCase(),d=false;b.each(a,function(a,b){if(b&&b.test(c)){d=true;return false}});return d},_restrictNativeVideoControls:function(){if(this.require.audio&&this.status.nativeVideoControls){this.status.nativeVideoControls=false;this.status.noFullScreen=true}},_updateNativeVideoControls:function(){if(this.html.video.available&&this.html.used){this.htmlElement.video.controls=this.status.nativeVideoControls;this._updateAutohide();if(this.status.nativeVideoControls&&this.require.video){this.internal.poster.jq.hide();this.internal.video.jq.css({width:this.status.width,height:this.status.height})}else if(this.status.waitForPlay&&this.status.video){this.internal.poster.jq.show();this.internal.video.jq.css({width:"0px",height:"0px"})}}},_addHtmlEventListeners:function(a,c){var d=this;a.preload=this.options.preload;a.muted=this.options.muted;a.volume=this.options.volume;a.addEventListener("progress",function(){if(c.gate){d._getHtmlStatus(a);d._updateInterface();d._trigger(b.jPlayer.event.progress)}},false);a.addEventListener("timeupdate",function(){if(c.gate){d._getHtmlStatus(a);d._updateInterface();d._trigger(b.jPlayer.event.timeupdate)}},false);a.addEventListener("durationchange",function(){if(c.gate){d._getHtmlStatus(a);d._updateInterface();d._trigger(b.jPlayer.event.durationchange)}},false);a.addEventListener("play",function(){if(c.gate){d._updateButtons(true);d._html_checkWaitForPlay();d._trigger(b.jPlayer.event.play)}},false);a.addEventListener("playing",function(){if(c.gate){d._updateButtons(true);d._seeked();d._trigger(b.jPlayer.event.playing)}},false);a.addEventListener("pause",function(){if(c.gate){d._updateButtons(false);d._trigger(b.jPlayer.event.pause)}},false);a.addEventListener("waiting",function(){if(c.gate){d._seeking();d._trigger(b.jPlayer.event.waiting)}},false);a.addEventListener("seeking",function(){if(c.gate){d._seeking();d._trigger(b.jPlayer.event.seeking)}},false);a.addEventListener("seeked",function(){if(c.gate){d._seeked();d._trigger(b.jPlayer.event.seeked)}},false);a.addEventListener("volumechange",function(){if(c.gate){d.options.volume=a.volume;d.options.muted=a.muted;d._updateMute();d._updateVolume();d._trigger(b.jPlayer.event.volumechange)}},false);a.addEventListener("suspend",function(){if(c.gate){d._seeked();d._trigger(b.jPlayer.event.suspend)}},false);a.addEventListener("ended",function(){if(c.gate){if(!b.jPlayer.browser.webkit)d.htmlElement.media.currentTime=0;d.htmlElement.media.pause();d._updateButtons(false);d._getHtmlStatus(a,true);d._updateInterface();d._trigger(b.jPlayer.event.ended)}},false);a.addEventListener("error",function(){if(c.gate){d._updateButtons(false);d._seeked();if(d.status.srcSet){clearTimeout(d.internal.htmlDlyCmdId);d.status.waitForLoad=true;d.status.waitForPlay=true;d.status.video&&!d.status.nativeVideoControls&&d.internal.video.jq.css({width:"0px",height:"0px"});d._validString(d.status.media.poster)&&!d.status.nativeVideoControls&&d.internal.poster.jq.show();d.css.jq.videoPlay.length&&d.css.jq.videoPlay.show();d._error({type:b.jPlayer.error.URL,context:d.status.src,message:b.jPlayer.errorMsg.URL,hint:b.jPlayer.errorHint.URL})}}},false);b.each(b.jPlayer.htmlEvent,function(e,g){a.addEventListener(this,function(){c.gate&&d._trigger(b.jPlayer.event[g])},false)})},_getHtmlStatus:function(a,b){var d=0,e=0,g=0,f=0;if(isFinite(a.duration))this.status.duration=a.duration;d=a.currentTime;e=this.status.duration>0?100*d/this.status.duration:0;if(typeof a.seekable==="object"&&a.seekable.length>0){g=this.status.duration>0?100*a.seekable.end(a.seekable.length-1)/this.status.duration:100;f=this.status.duration>0?100*a.currentTime/a.seekable.end(a.seekable.length-1):0}else{g=100;f=e}if(b)e=f=d=0;this.status.seekPercent=g;this.status.currentPercentRelative=f;this.status.currentPercentAbsolute=e;this.status.currentTime=d;this.status.readyState=a.readyState;this.status.networkState=a.networkState;this.status.playbackRate=a.playbackRate;this.status.ended=a.ended},_resetStatus:function(){this.status=b.extend({},this.status,b.jPlayer.prototype.status)},_trigger:function(a,c,d){a=b.Event(a);a.jPlayer={};a.jPlayer.version=b.extend({},this.version);a.jPlayer.options=b.extend(true,{},this.options);a.jPlayer.status=b.extend(true,{},this.status);a.jPlayer.html=b.extend(true,{},this.html);a.jPlayer.flash=b.extend(true,{},this.flash);if(c)a.jPlayer.error=b.extend({},c);if(d)a.jPlayer.warning=b.extend({},d);this.element.trigger(a)},jPlayerFlashEvent:function(a,c){if(a===b.jPlayer.event.ready)if(this.internal.ready){if(this.flash.gate){if(this.status.srcSet){var d=this.status.currentTime,e=this.status.paused;this.setMedia(this.status.media);d>0&&(e?this.pause(d):this.play(d))}this._trigger(b.jPlayer.event.flashreset)}}else{this.internal.ready=true;this.internal.flash.jq.css({width:"0px",height:"0px"});this.version.flash=c.version;this.version.needFlash!==this.version.flash&&this._error({type:b.jPlayer.error.VERSION,context:this.version.flash,message:b.jPlayer.errorMsg.VERSION+this.version.flash,hint:b.jPlayer.errorHint.VERSION});this._trigger(b.jPlayer.event.repeat);this._trigger(a)}if(this.flash.gate)switch(a){case b.jPlayer.event.progress:this._getFlashStatus(c);this._updateInterface();this._trigger(a);break;case b.jPlayer.event.timeupdate:this._getFlashStatus(c);this._updateInterface();this._trigger(a);break;case b.jPlayer.event.play:this._seeked();this._updateButtons(true);this._trigger(a);break;case b.jPlayer.event.pause:this._updateButtons(false);this._trigger(a);break;case b.jPlayer.event.ended:this._updateButtons(false);this._trigger(a);break;case b.jPlayer.event.click:this._trigger(a);break;case b.jPlayer.event.error:this.status.waitForLoad=true;this.status.waitForPlay=true;this.status.video&&this.internal.flash.jq.css({width:"0px",height:"0px"});this._validString(this.status.media.poster)&&this.internal.poster.jq.show();this.css.jq.videoPlay.length&&this.status.video&&this.css.jq.videoPlay.show();this.status.video?this._flash_setVideo(this.status.media):this._flash_setAudio(this.status.media);this._updateButtons(false);this._error({type:b.jPlayer.error.URL,context:c.src,message:b.jPlayer.errorMsg.URL,hint:b.jPlayer.errorHint.URL});break;case b.jPlayer.event.seeking:this._seeking();this._trigger(a);break;case b.jPlayer.event.seeked:this._seeked();this._trigger(a);break;case b.jPlayer.event.ready:break;default:this._trigger(a)}return false},_getFlashStatus:function(a){this.status.seekPercent=a.seekPercent;this.status.currentPercentRelative=a.currentPercentRelative;this.status.currentPercentAbsolute=a.currentPercentAbsolute;this.status.currentTime=a.currentTime;this.status.duration=a.duration;this.status.readyState=4;this.status.networkState=0;this.status.playbackRate=1;this.status.ended=false},_updateButtons:function(a){if(a!==f){this.status.paused=!a;if(this.css.jq.play.length&&this.css.jq.pause.length)if(a){this.css.jq.play.hide();this.css.jq.pause.show()}else{this.css.jq.play.show();this.css.jq.pause.hide()}}if(this.css.jq.restoreScreen.length&&this.css.jq.fullScreen.length)if(this.status.noFullScreen){this.css.jq.fullScreen.hide();this.css.jq.restoreScreen.hide()}else if(this.options.fullScreen){this.css.jq.fullScreen.hide();this.css.jq.restoreScreen.show()}else{this.css.jq.fullScreen.show();this.css.jq.restoreScreen.hide()}if(this.css.jq.repeat.length&&this.css.jq.repeatOff.length)if(this.options.loop){this.css.jq.repeat.hide();this.css.jq.repeatOff.show()}else{this.css.jq.repeat.show();this.css.jq.repeatOff.hide()}},_updateInterface:function(){this.css.jq.seekBar.length&&this.css.jq.seekBar.width(this.status.seekPercent+"%");this.css.jq.playBar.length&&this.css.jq.playBar.width(this.status.currentPercentRelative+"%");this.css.jq.currentTime.length&&this.css.jq.currentTime.text(b.jPlayer.convertTime(this.status.currentTime));this.css.jq.duration.length&&this.css.jq.duration.text(b.jPlayer.convertTime(this.status.duration))},_seeking:function(){this.css.jq.seekBar.length&&this.css.jq.seekBar.addClass("jp-seeking-bg")},_seeked:function(){this.css.jq.seekBar.length&&this.css.jq.seekBar.removeClass("jp-seeking-bg")},_resetGate:function(){this.html.audio.gate=false;this.html.video.gate=false;this.flash.gate=false},_resetActive:function(){this.html.active=false;this.flash.active=false},setMedia:function(a){var c=this,d=false,e=this.status.media.poster!==a.poster;this._resetMedia();this._resetGate();this._resetActive();b.each(this.formats,function(e,f){var i=c.format[f].media==="video";b.each(c.solutions,function(b,e){if(c[e].support[f]&&c._validString(a[f])){var g=e==="html";if(i){if(g){c.html.video.gate=true;c._html_setVideo(a);c.html.active=true}else{c.flash.gate=true;c._flash_setVideo(a);c.flash.active=true}c.css.jq.videoPlay.length&&c.css.jq.videoPlay.show();c.status.video=true}else{if(g){c.html.audio.gate=true;c._html_setAudio(a);c.html.active=true}else{c.flash.gate=true;c._flash_setAudio(a);c.flash.active=true}c.css.jq.videoPlay.length&&c.css.jq.videoPlay.hide();c.status.video=false}d=true;return false}});if(d)return false});if(d){if((!this.status.nativeVideoControls||!this.html.video.gate)&&this._validString(a.poster))e?this.htmlElement.poster.src=a.poster:this.internal.poster.jq.show();this.status.srcSet=true;this.status.media=b.extend({},a);this._updateButtons(false);this._updateInterface()}else this._error({type:b.jPlayer.error.NO_SUPPORT,context:"{supplied:'"+this.options.supplied+"'}",message:b.jPlayer.errorMsg.NO_SUPPORT,hint:b.jPlayer.errorHint.NO_SUPPORT})},_resetMedia:function(){this._resetStatus();this._updateButtons(false);this._updateInterface();this._seeked();this.internal.poster.jq.hide();clearTimeout(this.internal.htmlDlyCmdId);this.html.active?this._html_resetMedia():this.flash.active&&this._flash_resetMedia()},clearMedia:function(){this._resetMedia();this.html.active?this._html_clearMedia():this.flash.active&&this._flash_clearMedia();this._resetGate();this._resetActive()},load:function(){this.status.srcSet?this.html.active?this._html_load():this.flash.active&&this._flash_load():this._urlNotSetError("load")},play:function(a){a=typeof a==="number"?a:NaN;this.status.srcSet?this.html.active?this._html_play(a):this.flash.active&&this._flash_play(a):this._urlNotSetError("play")},videoPlay:function(){this.play()},pause:function(a){a=typeof a==="number"?a:NaN;this.status.srcSet?this.html.active?this._html_pause(a):this.flash.active&&this._flash_pause(a):this._urlNotSetError("pause")},pauseOthers:function(){var a=this;b.each(this.instances,function(b,d){a.element!==d&&d.data("jPlayer").status.srcSet&&d.jPlayer("pause")})},stop:function(){this.status.srcSet?this.html.active?this._html_pause(0):this.flash.active&&this._flash_pause(0):this._urlNotSetError("stop")},playHead:function(a){a=this._limitValue(a,0,100);this.status.srcSet?this.html.active?this._html_playHead(a):this.flash.active&&this._flash_playHead(a):this._urlNotSetError("playHead")},_muted:function(a){this.options.muted=a;this.html.used&&this._html_mute(a);this.flash.used&&this._flash_mute(a);if(!this.html.video.gate&&!this.html.audio.gate){this._updateMute(a);this._updateVolume(this.options.volume);this._trigger(b.jPlayer.event.volumechange)}},mute:function(a){a=a===f?true:!!a;this._muted(a)},unmute:function(a){a=a===f?true:!!a;this._muted(!a)},_updateMute:function(a){if(a===f)a=this.options.muted;if(this.css.jq.mute.length&&this.css.jq.unmute.length)if(this.status.noVolume){this.css.jq.mute.hide();this.css.jq.unmute.hide()}else if(a){this.css.jq.mute.hide();this.css.jq.unmute.show()}else{this.css.jq.mute.show();this.css.jq.unmute.hide()}},volume:function(a){a=this._limitValue(a,0,1);this.options.volume=a;this.html.used&&this._html_volume(a);this.flash.used&&this._flash_volume(a);if(!this.html.video.gate&&!this.html.audio.gate){this._updateVolume(a);this._trigger(b.jPlayer.event.volumechange)}},volumeBar:function(a){if(this.css.jq.volumeBar.length){var b=this.css.jq.volumeBar.offset(),d=a.pageX-b.left,e=this.css.jq.volumeBar.width(),a=this.css.jq.volumeBar.height()-
a.pageY+b.top,b=this.css.jq.volumeBar.height();this.options.verticalVolume?this.volume(a/b):this.volume(d/e)}this.options.muted&&this._muted(false)},volumeBarValue:function(a){this.volumeBar(a)},_updateVolume:function(a){if(a===f)a=this.options.volume;a=this.options.muted?0:a;if(this.status.noVolume){this.css.jq.volumeBar.length&&this.css.jq.volumeBar.hide();this.css.jq.volumeBarValue.length&&this.css.jq.volumeBarValue.hide();this.css.jq.volumeMax.length&&this.css.jq.volumeMax.hide()}else{this.css.jq.volumeBar.length&&this.css.jq.volumeBar.show();if(this.css.jq.volumeBarValue.length){this.css.jq.volumeBarValue.show();this.css.jq.volumeBarValue[this.options.verticalVolume?"height":"width"](a*100+"%")}this.css.jq.volumeMax.length&&this.css.jq.volumeMax.show()}},volumeMax:function(){this.volume(1);this.options.muted&&this._muted(false)},_cssSelectorAncestor:function(a){var c=this;this.options.cssSelectorAncestor=a;this._removeUiClass();this.ancestorJq=a?b(a):[];a&&this.ancestorJq.length!==1&&this._warning({type:b.jPlayer.warning.CSS_SELECTOR_COUNT,context:a,message:b.jPlayer.warningMsg.CSS_SELECTOR_COUNT+this.ancestorJq.length+" found for cssSelectorAncestor.",hint:b.jPlayer.warningHint.CSS_SELECTOR_COUNT});this._addUiClass();b.each(this.options.cssSelector,function(a,b){c._cssSelector(a,b)})},_cssSelector:function(a,c){var d=this;if(typeof c==="string")if(b.jPlayer.prototype.options.cssSelector[a]){this.css.jq[a]&&this.css.jq[a].length&&this.css.jq[a].unbind(".jPlayer");this.options.cssSelector[a]=c;this.css.cs[a]=this.options.cssSelectorAncestor+" "+c;this.css.jq[a]=c?b(this.css.cs[a]):[];this.css.jq[a].length&&this.css.jq[a].bind("click.jPlayer",function(c){d[a](c);b(this).blur();return false});c&&this.css.jq[a].length!==1&&this._warning({type:b.jPlayer.warning.CSS_SELECTOR_COUNT,context:this.css.cs[a],message:b.jPlayer.warningMsg.CSS_SELECTOR_COUNT+this.css.jq[a].length+" found for "+a+" method.",hint:b.jPlayer.warningHint.CSS_SELECTOR_COUNT})}else this._warning({type:b.jPlayer.warning.CSS_SELECTOR_METHOD,context:a,message:b.jPlayer.warningMsg.CSS_SELECTOR_METHOD,hint:b.jPlayer.warningHint.CSS_SELECTOR_METHOD});else this._warning({type:b.jPlayer.warning.CSS_SELECTOR_STRING,context:c,message:b.jPlayer.warningMsg.CSS_SELECTOR_STRING,hint:b.jPlayer.warningHint.CSS_SELECTOR_STRING})},seekBar:function(a){if(this.css.jq.seekBar){var b=this.css.jq.seekBar.offset(),a=a.pageX-b.left,b=this.css.jq.seekBar.width();this.playHead(100*a/b)}},playBar:function(a){this.seekBar(a)},repeat:function(){this._loop(true)},repeatOff:function(){this._loop(false)},_loop:function(a){if(this.options.loop!==a){this.options.loop=a;this._updateButtons();this._trigger(b.jPlayer.event.repeat)}},currentTime:function(){},duration:function(){},gui:function(){},noSolution:function(){},option:function(a,c){var d=a;if(arguments.length===0)return b.extend(true,{},this.options);if(typeof a==="string"){var e=a.split(".");if(c===f){for(var d=b.extend(true,{},this.options),g=0;g<e.length;g++)if(d[e[g]]!==f)d=d[e[g]];else{this._warning({type:b.jPlayer.warning.OPTION_KEY,context:a,message:b.jPlayer.warningMsg.OPTION_KEY,hint:b.jPlayer.warningHint.OPTION_KEY});return f}return d}for(var g=d={},h=0;h<e.length;h++)if(h<e.length-1){g[e[h]]={};g=g[e[h]]}else g[e[h]]=c}this._setOptions(d);return this},_setOptions:function(a){var c=this;b.each(a,function(a,b){c._setOption(a,b)});return this},_setOption:function(a,c){var d=this;switch(a){case"volume":this.volume(c);break;case"muted":this._muted(c);break;case"cssSelectorAncestor":this._cssSelectorAncestor(c);break;case"cssSelector":b.each(c,function(a,b){d._cssSelector(a,b)});break;case"fullScreen":if(this.options[a]!==c){this._removeUiClass();this.options[a]=c;this._refreshSize()}break;case"size":!this.options.fullScreen&&this.options[a].cssClass!==c.cssClass&&this._removeUiClass();this.options[a]=b.extend({},this.options[a],c);this._refreshSize();break;case"sizeFull":this.options.fullScreen&&this.options[a].cssClass!==c.cssClass&&this._removeUiClass();this.options[a]=b.extend({},this.options[a],c);this._refreshSize();break;case"autohide":this.options[a]=b.extend({},this.options[a],c);this._updateAutohide();break;case"loop":this._loop(c);break;case"nativeVideoControls":this.options[a]=b.extend({},this.options[a],c);this.status.nativeVideoControls=this._uaBlocklist(this.options.nativeVideoControls);this._restrictNativeVideoControls();this._updateNativeVideoControls();break;case"noFullScreen":this.options[a]=b.extend({},this.options[a],c);this.status.nativeVideoControls=this._uaBlocklist(this.options.nativeVideoControls);this.status.noFullScreen=this._uaBlocklist(this.options.noFullScreen);this._restrictNativeVideoControls();this._updateButtons();break;case"noVolume":this.options[a]=b.extend({},this.options[a],c);this.status.noVolume=this._uaBlocklist(this.options.noVolume);this._updateVolume();this._updateMute();break;case"emulateHtml":if(this.options[a]!==c)(this.options[a]=c)?this._emulateHtmlBridge():this._destroyHtmlBridge()}return this},_refreshSize:function(){this._setSize();this._addUiClass();this._updateSize();this._updateButtons();this._updateAutohide();this._trigger(b.jPlayer.event.resize)},_setSize:function(){if(this.options.fullScreen){this.status.width=this.options.sizeFull.width;this.status.height=this.options.sizeFull.height;this.status.cssClass=this.options.sizeFull.cssClass}else{this.status.width=this.options.size.width;this.status.height=this.options.size.height;this.status.cssClass=this.options.size.cssClass}this.element.css({width:this.status.width,height:this.status.height})},_addUiClass:function(){this.ancestorJq.length&&this.ancestorJq.addClass(this.status.cssClass)},_removeUiClass:function(){this.ancestorJq.length&&this.ancestorJq.removeClass(this.status.cssClass)},_updateSize:function(){this.internal.poster.jq.css({width:this.status.width,height:this.status.height});!this.status.waitForPlay&&this.html.active&&this.status.video||this.html.video.available&&this.html.used&&this.status.nativeVideoControls?this.internal.video.jq.css({width:this.status.width,height:this.status.height}):!this.status.waitForPlay&&(this.flash.active&&this.status.video)&&this.internal.flash.jq.css({width:this.status.width,height:this.status.height})},_updateAutohide:function(){var a=this,b=function(){a.css.jq.gui.fadeIn(a.options.autohide.fadeIn,function(){clearTimeout(a.internal.autohideId);a.internal.autohideId=setTimeout(function(){a.css.jq.gui.fadeOut(a.options.autohide.fadeOut)},a.options.autohide.hold)})};if(this.css.jq.gui.length){this.css.jq.gui.stop(true,true);clearTimeout(this.internal.autohideId);this.element.unbind(".jPlayerAutohide");this.css.jq.gui.unbind(".jPlayerAutohide");if(this.status.nativeVideoControls)this.css.jq.gui.hide();else if(this.options.fullScreen&&this.options.autohide.full||!this.options.fullScreen&&this.options.autohide.restored){this.element.bind("mousemove.jPlayer.jPlayerAutohide",b);this.css.jq.gui.bind("mousemove.jPlayer.jPlayerAutohide",b);this.css.jq.gui.hide()}else this.css.jq.gui.show()}},fullScreen:function(){this._setOption("fullScreen",true)},restoreScreen:function(){this._setOption("fullScreen",false)},_html_initMedia:function(){this.htmlElement.media.src=this.status.src;this.options.preload!=="none"&&this._html_load();this._trigger(b.jPlayer.event.timeupdate)},_html_setAudio:function(a){var c=this;b.each(this.formats,function(b,e){if(c.html.support[e]&&a[e]){c.status.src=a[e];c.status.format[e]=true;c.status.formatType=e;return false}});this.htmlElement.media=this.htmlElement.audio;this._html_initMedia()},_html_setVideo:function(a){var c=this;b.each(this.formats,function(b,e){if(c.html.support[e]&&a[e]){c.status.src=a[e];c.status.format[e]=true;c.status.formatType=e;return false}});if(this.status.nativeVideoControls)this.htmlElement.video.poster=this._validString(a.poster)?a.poster:"";this.htmlElement.media=this.htmlElement.video;this._html_initMedia()},_html_resetMedia:function(){if(this.htmlElement.media){this.htmlElement.media.id===this.internal.video.id&&!this.status.nativeVideoControls&&this.internal.video.jq.css({width:"0px",height:"0px"});this.htmlElement.media.pause()}},_html_clearMedia:function(){if(this.htmlElement.media){this.htmlElement.media.src="";this.htmlElement.media.load()}},_html_load:function(){if(this.status.waitForLoad){this.status.waitForLoad=false;this.htmlElement.media.load()}clearTimeout(this.internal.htmlDlyCmdId)},_html_play:function(a){var b=this;this._html_load();this.htmlElement.media.play();if(!isNaN(a))try{this.htmlElement.media.currentTime=a}catch(d){this.internal.htmlDlyCmdId=setTimeout(function(){b.play(a)},100);return}this._html_checkWaitForPlay()},_html_pause:function(a){var b=this;a>0?this._html_load():clearTimeout(this.internal.htmlDlyCmdId);this.htmlElement.media.pause();if(!isNaN(a))try{this.htmlElement.media.currentTime=a}catch(d){this.internal.htmlDlyCmdId=setTimeout(function(){b.pause(a)},100);return}a>0&&this._html_checkWaitForPlay()},_html_playHead:function(a){var b=this;this._html_load();try{if(typeof this.htmlElement.media.seekable==="object"&&this.htmlElement.media.seekable.length>0)this.htmlElement.media.currentTime=a*this.htmlElement.media.seekable.end(this.htmlElement.media.seekable.length-1)/100;else if(this.htmlElement.media.duration>0&&!isNaN(this.htmlElement.media.duration))this.htmlElement.media.currentTime=a*this.htmlElement.media.duration/100;else throw"e";}catch(d){this.internal.htmlDlyCmdId=setTimeout(function(){b.playHead(a)},100);return}this.status.waitForLoad||this._html_checkWaitForPlay()},_html_checkWaitForPlay:function(){if(this.status.waitForPlay){this.status.waitForPlay=false;this.css.jq.videoPlay.length&&this.css.jq.videoPlay.hide();if(this.status.video){this.internal.poster.jq.hide();this.internal.video.jq.css({width:this.status.width,height:this.status.height})}}},_html_volume:function(a){if(this.html.audio.available)this.htmlElement.audio.volume=a;if(this.html.video.available)this.htmlElement.video.volume=a},_html_mute:function(a){if(this.html.audio.available)this.htmlElement.audio.muted=a;if(this.html.video.available)this.htmlElement.video.muted=a},_flash_setAudio:function(a){var c=this;try{b.each(this.formats,function(b,d){if(c.flash.support[d]&&a[d]){switch(d){case"m4a":case"fla":c._getMovie().fl_setAudio_m4a(a[d]);break;case"mp3":c._getMovie().fl_setAudio_mp3(a[d]);break;case"rtmpa":c._getMovie().fl_setAudio_rtmp(a[d])}c.status.src=a[d];c.status.format[d]=true;c.status.formatType=d;return false}});if(this.options.preload==="auto"){this._flash_load();this.status.waitForLoad=false}}catch(d){this._flashError(d)}},_flash_setVideo:function(a){var c=this;try{b.each(this.formats,function(b,d){if(c.flash.support[d]&&a[d]){switch(d){case"m4v":case"flv":c._getMovie().fl_setVideo_m4v(a[d]);break;case"rtmpv":c._getMovie().fl_setVideo_rtmp(a[d])}c.status.src=a[d];c.status.format[d]=true;c.status.formatType=d;return false}});if(this.options.preload==="auto"){this._flash_load();this.status.waitForLoad=false}}catch(d){this._flashError(d)}},_flash_resetMedia:function(){this.internal.flash.jq.css({width:"0px",height:"0px"});this._flash_pause(NaN)},_flash_clearMedia:function(){try{this._getMovie().fl_clearMedia()}catch(a){this._flashError(a)}},_flash_load:function(){try{this._getMovie().fl_load()}catch(a){this._flashError(a)}this.status.waitForLoad=false},_flash_play:function(a){try{this._getMovie().fl_play(a)}catch(b){this._flashError(b)}this.status.waitForLoad=false;this._flash_checkWaitForPlay()},_flash_pause:function(a){try{this._getMovie().fl_pause(a)}catch(b){this._flashError(b)}if(a>0){this.status.waitForLoad=false;this._flash_checkWaitForPlay()}},_flash_playHead:function(a){try{this._getMovie().fl_play_head(a)}catch(b){this._flashError(b)}this.status.waitForLoad||this._flash_checkWaitForPlay()},_flash_checkWaitForPlay:function(){if(this.status.waitForPlay){this.status.waitForPlay=false;this.css.jq.videoPlay.length&&this.css.jq.videoPlay.hide();if(this.status.video){this.internal.poster.jq.hide();this.internal.flash.jq.css({width:this.status.width,height:this.status.height})}}},_flash_volume:function(a){try{this._getMovie().fl_volume(a)}catch(b){this._flashError(b)}},_flash_mute:function(a){try{this._getMovie().fl_mute(a)}catch(b){this._flashError(b)}},_getMovie:function(){return document[this.internal.flash.id]},_checkForFlash:function(a){var b=false,d;if(window.ActiveXObject)try{new ActiveXObject("ShockwaveFlash.ShockwaveFlash."+a);b=true}catch(e){}else if(navigator.plugins&&navigator.mimeTypes.length>0)(d=navigator.plugins["Shockwave Flash"])&&navigator.plugins["Shockwave Flash"].description.replace(/.*\s(\d+\.\d+).*/,"$1")>=a&&(b=true);return b},_validString:function(a){return a&&typeof a==="string"},_limitValue:function(a,b,d){return a<b?b:a>d?d:a},_urlNotSetError:function(a){this._error({type:b.jPlayer.error.URL_NOT_SET,context:a,message:b.jPlayer.errorMsg.URL_NOT_SET,hint:b.jPlayer.errorHint.URL_NOT_SET})},_flashError:function(a){var c;c=this.internal.ready?"FLASH_DISABLED":"FLASH";this._error({type:b.jPlayer.error[c],context:this.internal.flash.swf,message:b.jPlayer.errorMsg[c]+a.message,hint:b.jPlayer.errorHint[c]});this.internal.flash.jq.css({width:"1px",height:"1px"})},_error:function(a){this._trigger(b.jPlayer.event.error,a);this.options.errorAlerts&&this._alert("Error!"+(a.message?"\n\n"+a.message:"")+(a.hint?"\n\n"+a.hint:"")+"\n\nContext: "+a.context)},_warning:function(a){this._trigger(b.jPlayer.event.warning,f,a);this.options.warningAlerts&&this._alert("Warning!"+(a.message?"\n\n"+a.message:"")+(a.hint?"\n\n"+a.hint:"")+"\n\nContext: "+a.context)},_alert:function(a){alert("jPlayer "+this.version.script+" : id='"+this.internal.self.id+"' : "+a)},_emulateHtmlBridge:function(){var a=this;b.each(b.jPlayer.emulateMethods.split(/\s+/g),function(b,d){a.internal.domNode[d]=function(b){a[d](b)}});b.each(b.jPlayer.event,function(c,d){var e=true;b.each(b.jPlayer.reservedEvent.split(/\s+/g),function(a,b){if(b===c)return e=false});e&&a.element.bind(d+".jPlayer.jPlayerHtml",function(){a._emulateHtmlUpdate();var b=document.createEvent("Event");b.initEvent(c,false,true);a.internal.domNode.dispatchEvent(b)})})},_emulateHtmlUpdate:function(){var a=this;b.each(b.jPlayer.emulateStatus.split(/\s+/g),function(b,d){a.internal.domNode[d]=a.status[d]});b.each(b.jPlayer.emulateOptions.split(/\s+/g),function(b,d){a.internal.domNode[d]=a.options[d]})},_destroyHtmlBridge:function(){var a=this;this.element.unbind(".jPlayerHtml");b.each((b.jPlayer.emulateMethods+" "+b.jPlayer.emulateStatus+" "+b.jPlayer.emulateOptions).split(/\s+/g),function(b,d){delete a.internal.domNode[d]})}};b.jPlayer.error={FLASH:"e_flash",FLASH_DISABLED:"e_flash_disabled",NO_SOLUTION:"e_no_solution",NO_SUPPORT:"e_no_support",URL:"e_url",URL_NOT_SET:"e_url_not_set",VERSION:"e_version"};b.jPlayer.errorMsg={FLASH:"jPlayer's Flash fallback is not configured correctly, or a command was issued before the jPlayer Ready event. Details: ",FLASH_DISABLED:"jPlayer's Flash fallback has been disabled by the browser due to the CSS rules you have used. Details: ",NO_SOLUTION:"No solution can be found by jPlayer in this browser. Neither HTML nor Flash can be used.",NO_SUPPORT:"It is not possible to play any media format provided in setMedia() on this browser using your current options.",URL:"Media URL could not be loaded.",URL_NOT_SET:"Attempt to issue media playback commands, while no media url is set.",VERSION:"jPlayer "+b.jPlayer.prototype.version.script+" needs Jplayer.swf version "+b.jPlayer.prototype.version.needFlash+" but found "};b.jPlayer.errorHint={FLASH:"Check your swfPath option and that Jplayer.swf is there.",FLASH_DISABLED:"Check that you have not display:none; the jPlayer entity or any ancestor.",NO_SOLUTION:"Review the jPlayer options: support and supplied.",NO_SUPPORT:"Video or audio formats defined in the supplied option are missing.",URL:"Check media URL is valid.",URL_NOT_SET:"Use setMedia() to set the media URL.",VERSION:"Update jPlayer files."};b.jPlayer.warning={CSS_SELECTOR_COUNT:"e_css_selector_count",CSS_SELECTOR_METHOD:"e_css_selector_method",CSS_SELECTOR_STRING:"e_css_selector_string",OPTION_KEY:"e_option_key"};b.jPlayer.warningMsg={CSS_SELECTOR_COUNT:"The number of css selectors found did not equal one: ",CSS_SELECTOR_METHOD:"The methodName given in jPlayer('cssSelector') is not a valid jPlayer method.",CSS_SELECTOR_STRING:"The methodCssSelector given in jPlayer('cssSelector') is not a String or is empty.",OPTION_KEY:"The option requested in jPlayer('option') is undefined."};b.jPlayer.warningHint={CSS_SELECTOR_COUNT:"Check your css selector and the ancestor.",CSS_SELECTOR_METHOD:"Check your method name.",CSS_SELECTOR_STRING:"Check your css selector is a string.",OPTION_KEY:"Check your option name."}})(jQuery);(function($){var types=['DOMMouseScroll','mousewheel'];if($.event.fixHooks){for(var i=types.length;i;){$.event.fixHooks[types[--i]]=$.event.mouseHooks;}}
$.event.special.mousewheel={setup:function(){if(this.addEventListener){for(var i=types.length;i;){this.addEventListener(types[--i],handler,false);}}else{this.onmousewheel=handler;}},teardown:function(){if(this.removeEventListener){for(var i=types.length;i;){this.removeEventListener(types[--i],handler,false);}}else{this.onmousewheel=null;}}};$.fn.extend({mousewheel:function(fn){return fn?this.bind("mousewheel",fn):this.trigger("mousewheel");},unmousewheel:function(fn){return this.unbind("mousewheel",fn);}});function handler(event){var orgEvent=event||window.event,args=[].slice.call(arguments,1),delta=0,returnValue=true,deltaX=0,deltaY=0;event=$.event.fix(orgEvent);event.type="mousewheel";if(orgEvent.wheelDelta){delta=orgEvent.wheelDelta/120;}
if(orgEvent.detail){delta=-orgEvent.detail/3;}
deltaY=delta;if(orgEvent.axis!==undefined&&orgEvent.axis===orgEvent.HORIZONTAL_AXIS){deltaY=0;deltaX=-1*delta;}
if(orgEvent.wheelDeltaY!==undefined){deltaY=orgEvent.wheelDeltaY/120;}
if(orgEvent.wheelDeltaX!==undefined){deltaX=-1*orgEvent.wheelDeltaX/120;}
args.unshift(event,delta,deltaX,deltaY);return($.event.dispatch||$.event.handle).apply(this,args);}})(jQuery);;(function($){var $scrollTo=$.scrollTo=function(target,duration,settings){$(window).scrollTo(target,duration,settings);};$scrollTo.defaults={axis:'xy',duration:parseFloat($.fn.jquery)>=1.3?0:1,limit:true};$scrollTo.window=function(scope){return $(window)._scrollable();};$.fn._scrollable=function(){return this.map(function(){var elem=this,isWin=!elem.nodeName||$.inArray(elem.nodeName.toLowerCase(),['iframe','#document','html','body'])!=-1;if(!isWin)
return elem;var doc=(elem.contentWindow||elem).document||elem.ownerDocument||elem;return/webkit/i.test(navigator.userAgent)||doc.compatMode=='BackCompat'?doc.body:doc.documentElement;});};$.fn.scrollTo=function(target,duration,settings){if(typeof duration=='object'){settings=duration;duration=0;}
if(typeof settings=='function')
settings={onAfter:settings};if(target=='max')
target=9e9;settings=$.extend({},$scrollTo.defaults,settings);duration=duration||settings.duration;settings.queue=settings.queue&&settings.axis.length>1;if(settings.queue)
duration/=2;settings.offset=both(settings.offset);settings.over=both(settings.over);return this._scrollable().each(function(){if(!target)return;var elem=this,$elem=$(elem),targ=target,toff,attr={},win=$elem.is('html,body');switch(typeof targ){case'number':case'string':if(/^([+-]=)?\d+(\.\d+)?(px|%)?$/.test(targ)){targ=both(targ);break;}
targ=$(targ,this);if(!targ.length)return;case'object':if(targ.is||targ.style)
toff=(targ=$(targ)).offset();}
$.each(settings.axis.split(''),function(i,axis){var Pos=axis=='x'?'Left':'Top',pos=Pos.toLowerCase(),key='scroll'+Pos,old=elem[key],max=$scrollTo.max(elem,axis);if(toff){attr[key]=toff[pos]+(win?0:old-$elem.offset()[pos]);if(settings.margin){attr[key]-=parseInt(targ.css('margin'+Pos))||0;attr[key]-=parseInt(targ.css('border'+Pos+'Width'))||0;}
attr[key]+=settings.offset[pos]||0;if(settings.over[pos])
attr[key]+=targ[axis=='x'?'width':'height']()*settings.over[pos];}else{var val=targ[pos];attr[key]=val.slice&&val.slice(-1)=='%'?parseFloat(val)/100*max:val;}
if(settings.limit&&/^\d+$/.test(attr[key]))
attr[key]=attr[key]<=0?0:Math.min(attr[key],max);if(!i&&settings.queue){if(old!=attr[key])
animate(settings.onAfterFirst);delete attr[key];}});animate(settings.onAfter);function animate(callback){$elem.animate(attr,duration,settings.easing,callback&&function(){callback.call(this,target,settings);});};}).end();};$scrollTo.max=function(elem,axis){var Dim=axis=='x'?'Width':'Height',scroll='scroll'+Dim;if(!$(elem).is('html,body'))
return elem[scroll]-$(elem)[Dim.toLowerCase()]();var size='client'+Dim,html=elem.ownerDocument.documentElement,body=elem.ownerDocument.body;return Math.max(html[scroll],body[scroll])
-Math.min(html[size],body[size]);};function both(val){return typeof val=='object'?val:{top:val,left:val};};})(jQuery);var qq=qq||{};qq.extend=function(first,second){for(var prop in second){first[prop]=second[prop];}};qq.indexOf=function(arr,elt,from){if(arr.indexOf)return arr.indexOf(elt,from);from=from||0;var len=arr.length;if(from<0)from+=len;for(;from<len;from++){if(from in arr&&arr[from]===elt){return from;}}
return-1;};qq.getUniqueId=(function(){var id=0;return function(){return id++;};})();qq.attach=function(element,type,fn){if(element.addEventListener){element.addEventListener(type,fn,false);}else if(element.attachEvent){element.attachEvent('on'+type,fn);}};qq.detach=function(element,type,fn){if(element.removeEventListener){element.removeEventListener(type,fn,false);}else if(element.attachEvent){element.detachEvent('on'+type,fn);}};qq.preventDefault=function(e){if(e.preventDefault){e.preventDefault();}else{e.returnValue=false;}};qq.insertBefore=function(a,b){b.parentNode.insertBefore(a,b);};qq.remove=function(element){element.parentNode.removeChild(element);};qq.contains=function(parent,descendant){if(parent==descendant)return true;if(parent.contains){return parent.contains(descendant);}else{return!!(descendant.compareDocumentPosition(parent)&8);}};qq.toElement=(function(){var div=document.createElement('div');return function(html){div.innerHTML=html;var element=div.firstChild;div.removeChild(element);return element;};})();qq.css=function(element,styles){if(styles.opacity!=null){if(typeof element.style.opacity!='string'&&typeof(element.filters)!='undefined'){styles.filter='alpha(opacity='+Math.round(100*styles.opacity)+')';}}
qq.extend(element.style,styles);};qq.hasClass=function(element,name){var re=new RegExp('(^| )'+name+'( |$)');return re.test(element.className);};qq.addClass=function(element,name){if(!qq.hasClass(element,name)){element.className+=' '+name;}};qq.removeClass=function(element,name){var re=new RegExp('(^| )'+name+'( |$)');element.className=element.className.replace(re,' ').replace(/^\s+|\s+$/g,"");};qq.setText=function(element,text){element.innerText=text;element.textContent=text;};qq.children=function(element){var children=[],child=element.firstChild;while(child){if(child.nodeType==1){children.push(child);}
child=child.nextSibling;}
return children;};qq.getByClass=function(element,className){if(element.querySelectorAll){return element.querySelectorAll('.'+className);}
var result=[];var candidates=element.getElementsByTagName("*");var len=candidates.length;for(var i=0;i<len;i++){if(qq.hasClass(candidates[i],className)){result.push(candidates[i]);}}
return result;};qq.obj2url=function(obj,temp,prefixDone){var uristrings=[],prefix='&',add=function(nextObj,i){var nextTemp=temp?(/\[\]$/.test(temp))?temp:temp+'['+i+']':i;if((nextTemp!='undefined')&&(i!='undefined')){uristrings.push((typeof nextObj==='object')?qq.obj2url(nextObj,nextTemp,true):(Object.prototype.toString.call(nextObj)==='[object Function]')?encodeURIComponent(nextTemp)+'='+encodeURIComponent(nextObj()):encodeURIComponent(nextTemp)+'='+encodeURIComponent(nextObj));}};if(!prefixDone&&temp){prefix=(/\?/.test(temp))?(/\?$/.test(temp))?'':'&':'?';uristrings.push(temp);uristrings.push(qq.obj2url(obj));}else if((Object.prototype.toString.call(obj)==='[object Array]')&&(typeof obj!='undefined')){for(var i=0,len=obj.length;i<len;++i){add(obj[i],i);}}else if((typeof obj!='undefined')&&(obj!==null)&&(typeof obj==="object")){for(var i in obj){add(obj[i],i);}}else{uristrings.push(encodeURIComponent(temp)+'='+encodeURIComponent(obj));}
return uristrings.join(prefix).replace(/^&/,'').replace(/%20/g,'+');};var qq=qq||{};qq.FileUploaderBasic=function(o){this._options={debug:false,action:'/server/upload',params:{},button:null,multiple:true,maxConnections:3,allowedExtensions:[],sizeLimit:0,minSizeLimit:0,filesLimit:0,onSubmit:function(id,fileName){},onProgress:function(id,fileName,loaded,total){},onComplete:function(id,fileName,responseJSON){},onAllComplete:function(completed_files){},onCancel:function(id,fileName){},messages:{typeError:"{file} has invalid extension. Only {extensions} are allowed.",sizeError:"{file} is too large, maximum file size is {sizeLimit}.",minSizeError:"{file} is too small, minimum file size is {minSizeLimit}.",emptyError:"{file} is empty, please select files again without it.",filesLimitError:"No more than {filesLimit} files are allowed to be uploaded.",onLeave:"The files are being uploaded, if you leave now the upload will be cancelled."},showMessage:function(message){alert(message);}};qq.extend(this._options,o);this._filesInProgress=0;this._handler=this._createUploadHandler();if(this._options.button){this._button=this._createUploadButton(this._options.button);}
this._preventLeaveInProgress();};qq.FileUploaderBasic.prototype={setParams:function(params){this._options.params=params;},getInProgress:function(){return this._filesInProgress;},_createUploadButton:function(element){var self=this;return new qq.UploadButton({element:element,multiple:this._options.multiple&&qq.UploadHandlerXhr.isSupported(),onChange:function(input){self._onInputChange(input);}});},_createUploadHandler:function(){var self=this,handlerClass;if(qq.UploadHandlerXhr.isSupported()){handlerClass='UploadHandlerXhr';}else{handlerClass='UploadHandlerForm';}
var handler=new qq[handlerClass]({debug:this._options.debug,action:this._options.action,maxConnections:this._options.maxConnections,onProgress:function(id,fileName,loaded,total){self._onProgress(id,fileName,loaded,total);self._options.onProgress(id,fileName,loaded,total);},onComplete:function(id,fileName,result){self._onComplete(id,fileName,result);self._options.onComplete(id,fileName,result);},onAllComplete:function(completed_files){self._options.onAllComplete(completed_files);},onCancel:function(id,fileName){self._onCancel(id,fileName);self._options.onCancel(id,fileName);}});return handler;},_preventLeaveInProgress:function(){var self=this;qq.attach(window,'beforeunload',function(e){if(!self._filesInProgress){return;}
var e=e||window.event;e.returnValue=self._options.messages.onLeave;return self._options.messages.onLeave;});},_onSubmit:function(id,fileName){this._filesInProgress++;},_onProgress:function(id,fileName,loaded,total){},_onComplete:function(id,fileName,result){this._filesInProgress--;if(result.error){this._options.showMessage(result.error);}},_onCancel:function(id,fileName){this._filesInProgress--;},_onInputChange:function(input){if(this._handler instanceof qq.UploadHandlerXhr){this._uploadFileList(input.files);}else{if(this._validateFile(input)){this._uploadFile(input);}}
this._button.reset();},_uploadFileList:function(files){var list_length=0;for(var i=0;i<files.length;i++){if(!this._validateFile(files[i],list_length)){return;}
list_length++;}
for(var i=0;i<files.length;i++){this._uploadFile(files[i]);}},_uploadFile:function(fileContainer){var id=this._handler.add(fileContainer);var fileName=this._handler.getName(id);if(this._options.onSubmit(id,fileName)!==false){this._onSubmit(id,fileName);this._handler.upload(id,this._options.params);}},_validateFile:function(file,list_length){var name,size;if(file.value){name=file.value.replace(/.*(\/|\\)/,"");}else{name=file.fileName!=null?file.fileName:file.name;size=file.fileSize!=null?file.fileSize:file.size;}
if(!this._isAllowedExtension(name)){this._error('typeError',name);return false;}else if(size===0){this._error('emptyError',name);return false;}else if(size&&this._options.sizeLimit&&size>this._options.sizeLimit){this._error('sizeError',name);return false;}else if(size&&size<this._options.minSizeLimit){this._error('minSizeError',name);return false;}else if(this._options.filesLimit){if(list_length==undefined||list_length==NaN){var list_length=0;}
if(this._handler._completed_files==undefined||this._handler._completed_files==NaN){var completed_length=0;}else{var completed_length=this._handler._completed_files.length;}
if(this._handler._queue==undefined||this._handler._queue==NaN){var queue_length=0;}else{var queue_length=this._handler._queue.length;}
if(this._options.filesLimit<=(completed_length+queue_length+list_length)){this._error('filesLimitError',name);return false;}}
return true;},_error:function(code,fileName){var message=this._options.messages[code];function r(name,replacement){message=message.replace(name,replacement);}
r('{file}',this._formatFileName(fileName));r('{extensions}',this._options.allowedExtensions.join(', '));r('{sizeLimit}',this._formatSize(this._options.sizeLimit));r('{minSizeLimit}',this._formatSize(this._options.minSizeLimit));r('{filesLimit}',this._options.filesLimit);this._options.showMessage(message);},_formatFileName:function(name){if(name.length>33){name=name.slice(0,19)+'...'+name.slice(-13);}
return name;},_isAllowedExtension:function(fileName){var ext=(-1!==fileName.indexOf('.'))?fileName.replace(/.*[.]/,'').toLowerCase():'';var allowed=this._options.allowedExtensions;if(!allowed.length){return true;}
for(var i=0;i<allowed.length;i++){if(allowed[i].toLowerCase()==ext){return true;}}
return false;},_formatSize:function(bytes){var i=-1;do{bytes=bytes/1024;i++;}while(bytes>99);return Math.max(bytes,0.1).toFixed(1)+['kB','MB','GB','TB','PB','EB'][i];}};qq.FileUploader=function(o){qq.FileUploaderBasic.apply(this,arguments);qq.extend(this._options,{element:null,listElement:null,template:'<div class="qq-uploader">'+'<div class="qq-upload-drop-area"><span>Drop files here to upload</span></div>'+'<div class="qq-upload-button">Upload a file</div>'+'<ul class="qq-upload-list"></ul>'+'</div>',fileTemplate:'<li>'+'<span class="qq-upload-file"></span>'+'<span class="qq-upload-spinner"></span>'+'<span class="qq-upload-size"></span>'+'<a class="qq-upload-cancel" href="#">Cancel</a>'+'<span class="qq-upload-failed-text">Failed</span>'+'</li>',classes:{button:'qq-upload-button',drop:'qq-upload-drop-area',dropActive:'qq-upload-drop-area-active',list:'qq-upload-list',file:'qq-upload-file',spinner:'qq-upload-spinner',size:'qq-upload-size',cancel:'qq-upload-cancel',success:'qq-upload-success',fail:'qq-upload-fail'}});qq.extend(this._options,o);this._element=this._options.element;this._element.innerHTML=this._options.template;this._listElement=this._options.listElement||this._find(this._element,'list');this._classes=this._options.classes;this._button=this._createUploadButton(this._find(this._element,'button'));this._bindCancelEvent();this._setupDragDrop();};qq.extend(qq.FileUploader.prototype,qq.FileUploaderBasic.prototype);qq.extend(qq.FileUploader.prototype,{_find:function(parent,type){var element=qq.getByClass(parent,this._options.classes[type])[0];if(!element){throw new Error('element not found '+type);}
return element;},_setupDragDrop:function(){var self=this,dropArea=this._find(this._element,'drop');var dz=new qq.UploadDropZone({element:dropArea,onEnter:function(e){qq.addClass(dropArea,self._classes.dropActive);e.stopPropagation();},onLeave:function(e){e.stopPropagation();},onLeaveNotDescendants:function(e){qq.removeClass(dropArea,self._classes.dropActive);},onDrop:function(e){dropArea.style.display='none';qq.removeClass(dropArea,self._classes.dropActive);if(!self.multiple&&e.dataTransfer.files.length>1)
alert("Multiple file uploads are disabled.");else
self._uploadFileList(e.dataTransfer.files);}});dropArea.style.display='none';qq.attach(document,'dragenter',function(e){if(!dz._isValidFileDrag(e))return;dropArea.style.display='block';});qq.attach(document,'dragleave',function(e){if(!dz._isValidFileDrag(e))return;var relatedTarget=document.elementFromPoint(e.clientX,e.clientY);if(!relatedTarget||relatedTarget.nodeName=="HTML"){dropArea.style.display='none';}});},_onSubmit:function(id,fileName){qq.FileUploaderBasic.prototype._onSubmit.apply(this,arguments);this._addToList(id,fileName);},_onProgress:function(id,fileName,loaded,total){qq.FileUploaderBasic.prototype._onProgress.apply(this,arguments);var item=this._getItemByFileId(id);var size=this._find(item,'size');size.style.display='inline';var text;if(loaded!=total){text=Math.round(loaded/total*100)+'% from '+this._formatSize(total);}else{text=this._formatSize(total);}
qq.setText(size,text);},_onComplete:function(id,fileName,result){qq.FileUploaderBasic.prototype._onComplete.apply(this,arguments);var item=this._getItemByFileId(id);qq.remove(this._find(item,'cancel'));qq.remove(this._find(item,'spinner'));if(result.success){qq.addClass(item,this._classes.success);}else{qq.addClass(item,this._classes.fail);}},_addToList:function(id,fileName){var item=qq.toElement(this._options.fileTemplate);item.qqFileId=id;var fileElement=this._find(item,'file');qq.setText(fileElement,this._formatFileName(fileName));this._find(item,'size').style.display='none';this._listElement.appendChild(item);},_getItemByFileId:function(id){var item=this._listElement.firstChild;while(item){if(item.qqFileId==id)return item;item=item.nextSibling;}},_bindCancelEvent:function(){var self=this,list=this._listElement;qq.attach(list,'click',function(e){e=e||window.event;var target=e.target||e.srcElement;if(qq.hasClass(target,self._classes.cancel)){qq.preventDefault(e);var item=target.parentNode;self._handler.cancel(item.qqFileId);qq.remove(item);}});}});qq.UploadDropZone=function(o){this._options={element:null,onEnter:function(e){},onLeave:function(e){},onLeaveNotDescendants:function(e){},onDrop:function(e){}};qq.extend(this._options,o);this._element=this._options.element;this._disableDropOutside();this._attachEvents();};qq.UploadDropZone.prototype={_disableDropOutside:function(e){if(!qq.UploadDropZone.dropOutsideDisabled){qq.attach(document,'dragover',function(e){if(e.dataTransfer){e.dataTransfer.dropEffect='none';e.preventDefault();}});qq.UploadDropZone.dropOutsideDisabled=true;}},_attachEvents:function(){var self=this;qq.attach(self._element,'dragover',function(e){if(!self._isValidFileDrag(e))return;var effect=e.dataTransfer.effectAllowed;if(effect=='move'||effect=='linkMove'){e.dataTransfer.dropEffect='move';}else{e.dataTransfer.dropEffect='copy';}
e.stopPropagation();e.preventDefault();});qq.attach(self._element,'dragenter',function(e){if(!self._isValidFileDrag(e))return;self._options.onEnter(e);});qq.attach(self._element,'dragleave',function(e){if(!self._isValidFileDrag(e))return;self._options.onLeave(e);var relatedTarget=document.elementFromPoint(e.clientX,e.clientY);if(qq.contains(this,relatedTarget))return;self._options.onLeaveNotDescendants(e);});qq.attach(self._element,'drop',function(e){if(!self._isValidFileDrag(e))return;e.preventDefault();self._options.onDrop(e);});},_isValidFileDrag:function(e){var dt=e.dataTransfer,isWebkit=navigator.userAgent.indexOf("AppleWebKit")>-1;return dt&&dt.effectAllowed!='none'&&(dt.files||(!isWebkit&&dt.types.contains&&dt.types.contains('Files')));}};qq.UploadButton=function(o){this._options={element:null,multiple:false,name:'file',onChange:function(input){},hoverClass:'qq-upload-button-hover',focusClass:'qq-upload-button-focus'};qq.extend(this._options,o);this._element=this._options.element;qq.css(this._element,{position:'relative',overflow:'hidden',direction:'ltr'});this._input=this._createInput();};qq.UploadButton.prototype={getInput:function(){return this._input;},reset:function(){if(this._input.parentNode){qq.remove(this._input);}
qq.removeClass(this._element,this._options.focusClass);this._input=this._createInput();},_createInput:function(){var input=document.createElement("input");if(this._options.multiple){input.setAttribute("multiple","multiple");}
input.setAttribute("type","file");input.setAttribute("name",this._options.name);qq.css(input,{position:'absolute',right:0,top:0,fontFamily:'Arial',fontSize:'118px',margin:0,padding:0,cursor:'pointer',opacity:0});this._element.appendChild(input);var self=this;qq.attach(input,'change',function(){self._options.onChange(input);});qq.attach(input,'mouseover',function(){qq.addClass(self._element,self._options.hoverClass);});qq.attach(input,'mouseout',function(){qq.removeClass(self._element,self._options.hoverClass);});qq.attach(input,'focus',function(){qq.addClass(self._element,self._options.focusClass);});qq.attach(input,'blur',function(){qq.removeClass(self._element,self._options.focusClass);});if(window.attachEvent){input.setAttribute('tabIndex',"-1");}
return input;}};qq.UploadHandlerAbstract=function(o){this._options={debug:false,action:'/upload.php',maxConnections:999,onProgress:function(id,fileName,loaded,total){},onComplete:function(id,fileName,response){},onAllComplete:function(completed_files){},onCancel:function(id,fileName){}};qq.extend(this._options,o);this._queue=[];this._params=[];this._completed_files=[];};qq.UploadHandlerAbstract.prototype={log:function(str){if(this._options.debug&&window.console)console.log('[uploader] '+str);},add:function(file){},upload:function(id,params){var len=this._queue.push(id);var copy={};qq.extend(copy,params);this._params[id]=copy;if(len<=this._options.maxConnections){this._upload(id,this._params[id]);}},cancel:function(id){this._cancel(id);this._dequeue(id);},cancelAll:function(){for(var i=0;i<this._queue.length;i++){this._cancel(this._queue[i]);}
this._queue=[];},getName:function(id){},getSize:function(id){},getQueue:function(){return this._queue;},_upload:function(id){},_cancel:function(id){},_dequeue:function(id){var i=qq.indexOf(this._queue,id);this._queue.splice(i,1);var max=this._options.maxConnections;if(this._queue.length>=max){var nextId=this._queue[max-1];this._upload(nextId,this._params[nextId]);}
if(this._queue.length==0){this._onAllComplete();}},_onAllComplete:function(){this._options.onAllComplete(this._completed_files);}};qq.UploadHandlerForm=function(o){qq.UploadHandlerAbstract.apply(this,arguments);this._inputs={};};qq.extend(qq.UploadHandlerForm.prototype,qq.UploadHandlerAbstract.prototype);qq.extend(qq.UploadHandlerForm.prototype,{add:function(fileInput){fileInput.setAttribute('name','qqfile');var id='qq-upload-handler-iframe'+qq.getUniqueId();this._inputs[id]=fileInput;if(fileInput.parentNode){qq.remove(fileInput);}
return id;},getName:function(id){return this._inputs[id].value.replace(/.*(\/|\\)/,"");},_cancel:function(id){this._options.onCancel(id,this.getName(id));delete this._inputs[id];var iframe=document.getElementById(id);if(iframe){iframe.setAttribute('src','javascript:false;');qq.remove(iframe);}},_upload:function(id,params){var input=this._inputs[id];if(!input){throw new Error('file with passed id was not added, or already uploaded or cancelled');}
var fileName=this.getName(id);var iframe=this._createIframe(id);var form=this._createForm(iframe,params);form.appendChild(input);var self=this;this._attachLoadEvent(iframe,function(){self.log('iframe loaded');var response=self._getIframeContentJSON(iframe);self._options.onComplete(id,fileName,response);self._dequeue(id);delete self._inputs[id];setTimeout(function(){qq.remove(iframe);},1);});form.submit();qq.remove(form);return id;},_attachLoadEvent:function(iframe,callback){qq.attach(iframe,'load',function(){if(!iframe.parentNode){return;}
if(iframe.contentDocument&&iframe.contentDocument.body&&iframe.contentDocument.body.innerHTML=="false"){return;}
callback();});},_getIframeContentJSON:function(iframe){var doc=iframe.contentDocument?iframe.contentDocument:iframe.contentWindow.document,response;this.log("converting iframe's innerHTML to JSON");this.log("innerHTML = "+doc.body.innerHTML);try{response=eval("("+doc.body.innerHTML+")");}catch(err){response={};}
return response;},_createIframe:function(id){var iframe=qq.toElement('<iframe src="javascript:false;" name="'+id+'" />');iframe.setAttribute('id',id);iframe.style.display='none';document.body.appendChild(iframe);return iframe;},_createForm:function(iframe,params){var form=null;if(params.csrf_token&&params.csrf_name)
{var csrf='<input type="hidden" name="'+params.csrf_name+'" value="'+params.csrf_token+'" />';form=qq.toElement('<form method="post" enctype="multipart/form-data">'+csrf+'</form>');}
else
form=qq.toElement('<form method="post" enctype="multipart/form-data"></form>');delete params.csrf_token;delete params.csrf_name;delete params.csrf_xname;var queryString=qq.obj2url(params,this._options.action);form.setAttribute('action',queryString);form.setAttribute('target',iframe.name);form.style.display='none';document.body.appendChild(form);return form;}});qq.UploadHandlerXhr=function(o){qq.UploadHandlerAbstract.apply(this,arguments);this._files=[];this._xhrs=[];this._loaded=[];};qq.UploadHandlerXhr.isSupported=function(){var input=document.createElement('input');input.type='file';return('multiple'in input&&typeof File!="undefined"&&typeof(new XMLHttpRequest()).upload!="undefined");};qq.extend(qq.UploadHandlerXhr.prototype,qq.UploadHandlerAbstract.prototype)
qq.extend(qq.UploadHandlerXhr.prototype,{add:function(file){if(!(file instanceof File)){throw new Error('Passed obj is not a File (in qq.UploadHandlerXhr)');}
return this._files.push(file)-1;},getName:function(id){var file=this._files[id];return file.fileName!=null?file.fileName:file.name;},getSize:function(id){var file=this._files[id];return file.fileSize!=null?file.fileSize:file.size;},getLoaded:function(id){return this._loaded[id]||0;},_upload:function(id,params){var file=this._files[id],name=this.getName(id),size=this.getSize(id);this._loaded[id]=0;var xhr=this._xhrs[id]=new XMLHttpRequest();var self=this;xhr.upload.onprogress=function(e){if(e.lengthComputable){self._loaded[id]=e.loaded;self._options.onProgress(id,name,e.loaded,e.total);}};xhr.onreadystatechange=function(){if(xhr.readyState==4){self._onComplete(id,xhr);}};params=params||{};var token=false;var xname=false;if(params.csrf_token&&params.csrf_xname)
{token=params.csrf_token;xname=params.csrf_xname;delete params.csrf_token;delete params.csrf_xname;delete params.csrf_name;}
params['qqfile']=name;var queryString=qq.obj2url(params,this._options.action);xhr.open("POST",queryString,true);xhr.setRequestHeader("X-Requested-With","XMLHttpRequest");xhr.setRequestHeader("X-File-Name",encodeURIComponent(name));xhr.setRequestHeader("Content-Type","application/octet-stream");if(token)
xhr.setRequestHeader(xname,token);xhr.send(file);},_onComplete:function(id,xhr){if(!this._files[id])return;var name=this.getName(id);var size=this.getSize(id);this._options.onProgress(id,name,size,size);if(xhr.status==200||xhr.status==201){this.log("xhr - server response received");this.log("responseText = "+xhr.responseText);var response;try{response=eval("("+xhr.responseText+")");}catch(err){response={};}
this._completed_files.push({file:this._files[id],response:response})
this._options.onComplete(id,name,response);}else{this._completed_files.push({file:this._files[id],response:{}})
this._options.onComplete(id,name,{});}
this._files[id]=null;this._xhrs[id]=null;this._dequeue(id);},_cancel:function(id){this._options.onCancel(id,this.getName(id));this._files[id]=null;if(this._xhrs[id]){this._xhrs[id].abort();this._xhrs[id]=null;}}});;(function($){var lib=window.lib=new function()
{this.center=function(element,container)
{var containerWidth=$(container).outerWidth();var containerHeight=$(container).outerHeight();var width=$(element).width();var height=$(element).height();var top=(containerHeight-height)/2;var left=(containerWidth-width)/2;$(element).css({'top':top+'px','left':left+'px'});},this.editUrl=function(targetUrl)
{var self=this;var base=window.location.href;var baseArray=new Array();baseArray=base.split('/');var urlPath=base.replace(currentPage,targetUrl);if(history.pushState){window.history.pushState({'page':self.subpage,'mirror':self.mirror},"",urlPath);}
window.onpopstate=function(e)
{}},this.postAjaxCalls=function()
{},this.customScrollbars=function()
{$("#story").mCustomScrollbar("vertical",400,"easeOutCirc",1.05,"auto","yes","yes",10);$("#previewedSoundComments").mCustomScrollbar("vertical",400,"easeOutCirc",1.05,"auto","yes","no",10);},this.cycle=function(items,intervalMs)
{var count=$(items).size();$(items).css({'opacity':0});$(items).eq(0).css({'opacity':1});var i=0;var interval=setInterval(function()
{var next=(i<count-1)?i+1:0;$(items).eq(i).animate({opacity:0},1000);$(items).eq(next).animate({opacity:1},1000);i=(i<count-1)?i+1:0;},intervalMs);},this.ajax=function(url,data,dataType,container,successCallback)
{var self=this;$.ajax({type:'post',dataType:dataType,url:url,data:data,success:function(data)
{successCallback(data);self.postAjaxCalls();}});},this.lightbox=function(openCallback,closeCallback)
{var self=this;$('#screen').fadeIn(300,function(){$(this).addClass('open');openCallback();$('#screen').click(function(e){closeCallback();self.hideLightbox();});});},this.hideLightbox=function()
{$('#screen').fadeOut(200);},this.getController=function(controllers){var self=this;var pathname=window.location.pathname;var controller;for(var i=0;i<controllers.length;i++){var query=new RegExp(controllers[i],'i');if(pathname.search(query)>0){controller=controllers[i];}}
return controller;},this.isLoaded=function(elementId)
{var element=document.getElementById(elementId).contentDocument;return(element==null)?false:true;},this.inArray=function(needle,haystack){var length=haystack.length;for(var i=0;i<length;i++){if(haystack[i]==needle)return true;}
return false;},this.log=function(s){if(window.console){console.log(s);}},this.random=function(max,add){return Math.floor(Math.random()*max+add);},this.isEmail=function isEmail(email){return/^[\w-+\.]+@([\w-]+\.)+[\w-]{2,}$/i.test(email);},this.getId=function(idString){return idString.substring((idString.search('_')+1));},this.partial=function(func){var args=Array.prototype.slice.call(arguments,1);return function(){var allArguments=args.concat(Array.prototype.slice.call(arguments));return func.apply(this,allArguments);};},this.include=function(script,callback){$.getScript(script,function(){if(typeof callback=='function')
callback.apply({},arguments);});};};})(jQuery);$.ajaxSetup({beforeSend:function(xhr,settings){function getCookie(name){var cookieValue=null;if(document.cookie&&document.cookie!=''){var cookies=document.cookie.split(';');for(var i=0;i<cookies.length;i++){var cookie=jQuery.trim(cookies[i]);if(cookie.substring(0,name.length+1)==(name+'=')){cookieValue=decodeURIComponent(cookie.substring(name.length+1));break;}}}
return cookieValue;}
if(!(/^http:.*/.test(settings.url)||/^https:.*/.test(settings.url))){xhr.setRequestHeader("X-CSRFToken",getCookie('csrftoken'));}}});;(function($){var site=window.site=new function(){this.WIDTH;this.HEIGHT;this.csrvToken;this.init=function()
{this.menus();this.constellationMenuScroll();this.searchForm();this.WIDTH=$('#interface').width();this.HEIGHT=$('#interface').height();site.ajaxUpload.init();site.map.init();this.debug();};this.debug=function()
{};this.searchForm=function()
{var self=this;$('#search input[name=q]').live('input paste',function()
{var value=$(this).val();if(value.length>1)
{Dajaxice.futures.autocomplete(self.autocomplete_callback,{'q':value});}
else
{site.ffinterface.search_results={'Geosounds':[],'Constellations':[]};}});};this.autocomplete_callback=function(data)
{var self=this;if(data.success==true)
{site.ffinterface.search_results=data.results;}};this.constellationMenuScroll=function()
{if($.browser.mozilla){speed=10;}else{speed=3;}
$('#scrollUp').live('mouseenter',function(){this.iid=setInterval(function(){$('#constellationMenuContent').scrollTo('-='+speed+'px',{axis:'y'});},25);}).live('mouseleave',function(){this.iid&&clearInterval(this.iid);});$('#scrollDown').live('mouseenter',function(){this.iid=setInterval(function(){$('#constellationMenuContent').scrollTo('+='+speed+'px',{axis:'y'});},25);}).live('mouseleave',function(){this.iid&&clearInterval(this.iid);});};this.menus=function()
{var self=this;$("#clickLayer").click(function(){if($("#map").css("opacity")>0){$("#map").fadeOut(1000);$("#interface").fadeIn(1000);}
$(".tran1").fadeOut(1000);$("#clickLayer").hide();$('#feedback').animate({right:-322},1000);});$("#logo").click(function(){$("#about").fadeToggle("fast","linear");$("#clickLayer").fadeToggle("fast","linear");});$("#addSoundText").click(function(){$("#addSound").fadeToggle("fast","linear");$("#clickLayer").fadeToggle("fast","linear");site.ffinterface.resetRotation();});$("#addConstellationText").click(function(){$("#addConstellation").fadeToggle("fast","linear");$("#clickLayer").fadeToggle("fast","linear");});$("#errorText").click(function(){$("#error").fadeToggle("fast","linear");});$("#constellationMenu h2").live('click',function(){$("#constellationMenuContent").fadeToggle("fast","linear");$("#constellationMenu #scrollUp").fadeToggle("fast","linear");$("#constellationMenu #scrollDown").fadeToggle("fast","linear");});$("#toggleLanguage").click(function(){$("#about .description.arabic").fadeToggle("fast","linear");$("#about .description.english").fadeToggle("fast","linear");$("#aboutLinks #toggleAr").fadeToggle("fast","linear");$("#aboutLinks #toggleEn").fadeToggle("fast","linear");});$('#constellationMenuContent a').live('mouseenter',function(e)
{e.preventDefault();var id=lib.getId($(this).attr('id'));site.ffinterface.loadConstellation(id,true);});$('#constellationMenuContent a').live('mouseleave',function(e)
{clearInterval(site.ffinterface.rotation_interval);site.ffinterface.clearConnections();});$('#contactUs a').click(function(e)
{e.preventDefault();$('#feedback').animate({right:0},1000);});$('#feedbackForm').submit(function(e)
{e.preventDefault();var data=$(this).serialize();Dajaxice.futures.submit_feedback(self.feedback_callback,{'form':data});});$('#addSoundForm .time').click(function(e)
{e.preventDefault();if($(this).val()==0)
{$(this).addClass('selected').val(1);}
else
{$(this).removeClass('selected').val(0);}});$('#addSoundForm').submit(function(e)
{e.preventDefault();$('input[name=lat]').val('');$('input[name=lon]').val('');$('#addSoundForm input, #addSoundForm textarea').removeClass('error');$('#addSoundForm .errors').empty();var address=$('input[name=location]').val();var geocoder=new google.maps.Geocoder();geocoder.geocode({'address':address},function(results,status)
{if(status==google.maps.GeocoderStatus.OK)
{$('input[name=lat]').val(results[0].geometry.location.lat());$('input[name=lon]').val(results[0].geometry.location.lng());}
var data=$('#addSoundForm').serialize();var tags=[];for(var i=0;i<$('.time').size();i++)
{var button=$('.time').eq(i);if($(button).val()==1)
{tags.push($(button).attr('name'));}}
Dajaxice.futures.submit_sound(self.addSound_callback,{'form':data,'tags':tags});});});$('#addConstellationForm').submit(function(e)
{e.preventDefault();$('#addConstellationForm input, #addConstellationForm textarea').removeClass('error');$('#addConstellationForm .errors').empty();var connections=site.ffinterface.getActiveConnections();$('#addConstellationForm input[name=connection_count]').val(connections.length);$('#addConstellationForm input[name=zoom]').val(site.ffinterface.zoom);var data=$(this).serialize();Dajaxice.futures.submit_constellation(self.addConstellation_callback,{'form':data,'connections':connections,'rotation':site.ffinterface.rotation});});$('#customZoomIn').live('click',function(e)
{e.preventDefault();site.ffinterface.changeZoom(0.2);});$('#customZoomOut').live('click',function(e)
{e.preventDefault();site.ffinterface.changeZoom(-0.2);});};this.addSound_callback=function(data)
{if(data.success==true)
{$('#addSoundForm').fadeOut(800,function()
{$('#addSoundCheck').fadeIn(500,function()
{setTimeout(function()
{$('#addSound').fadeOut(1000,function()
{$('#addSoundCheck').hide();$('#addSoundForm').show();$('#addSoundForm input, #addSoundForm textarea').not('.formSubmit').val('');lib.log(data.geojson);site.map.addSound(data.geojson);});},1500);});});}
else
{for(field in data.errors)
{var error=data.errors[field][0];$('#addSoundForm .errors').append('<p>'+error+'</p>');$('#id_'+field).addClass('error');}}};this.addConstellation_callback=function(data)
{if(data.success==true)
{$('#constellationMenuContainer').html(data.constellations);$('#addConstellationForm').fadeOut(800,function()
{$('#addConstellationCheck').fadeIn(500,function()
{setTimeout(function()
{$('#addConstellation').fadeOut(1000,function()
{$('#addConstellationCheck').hide();$('#addConstellationForm').show();$('#addConstellationForm input, #addConstellationForm textarea').not('.formSubmit').val('');});},1500);});});}
else
{for(field in data.errors)
{var error=data.errors[field][0];$('#addConstellationForm .errors').append('<p>'+error+'</p>');$('#id_'+field).addClass('error');}}};this.feedback_callback=function(data)
{$('#feedbackForm input, #feedbackForm textarea').removeClass('error');if(data.success==true)
{$('#feedbackForm').fadeOut(300,function()
{$('#feedbackCheck').fadeIn(300,function()
{setTimeout(function()
{$('#feedback').animate({right:-322},1000,function()
{$('#feedbackCheck').hide();$('#feedbackForm input, #feedbackForm textarea').not('.formSubmit').val('');$('#feedbackForm').show();});},1000);});});}
else
{for(field in data.errors)
{$('#id_'+field).addClass('error');}}};this.appendFormError=function(form,message)
{$('.errors',form).append('<p>'+message+'</p>');};this.outputError=function(message)
{$('#error #errorMessage').html('<p>'+message+'</p>');$('#error').fadeIn(1000);};};})(jQuery);$(document).ready(function(){site.init();});;(function($){var ajaxUpload=window.site.ajaxUpload=new function(){this.csrfToken;this.init=function(){this.csrfToken=$('#addSoundForm input[name="csrfmiddlewaretoken"]').val();this.fileUpload();},this.debug=function(){},this.fileUpload=function()
{var self=this;var uploader=new qq.FileUploader({action:"/ajax-upload",element:$('#file-uploader')[0],multiple:false,debug:false,allowedExtensions:['mp3'],onSubmit:function(id,fileName)
{$('.progressBarContainer').show();$('#uploadText').text(fileName).show();},onProgress:function(id,fileName,loaded,total)
{$('.qq-upload-file, .qq-upload-size, .qq-upload-cancel').hide();var percentage=Math.round((loaded/total)*100);lib.log(percentage);$('#ajaxUploadContainer').addClass('progress');$('.progressBarContainer .progress').css({'width':percentage+'%'});},onCancel:function(id,fileName)
{$('.qq-upload-file, .qq-upload-size, .qq-upload-cancel').hide();$('#ajaxUploadContainer').removeClass();},onComplete:function(id,fileName,responseJSON)
{$('.qq-upload-file, .qq-upload-size, .qq-upload-cancel').hide();$('.progressBarContainer').fadeOut(200);$('#id_filename').val('uploads/'+fileName);$('.progressBarContainer .progress').html("YAY! WE HAZ THE FILE:"+fileName);},onAllComplete:function(uploads){$('#ajaxUploadContainer').removeClass().addClass('complete');},params:{'csrf_token':self.csrfToken,'csrf_name':'csrfmiddlewaretoken','csrf_xname':'X-CSRFToken',},});$('#uploadText').live('click',function(e)
{e.preventDefault();});};};})(jQuery);var Kinetic={};Kinetic.Filters={};Kinetic.Plugins={};Kinetic.Global={BUBBLE_WHITELIST:['mousedown','mousemove','mouseup','mouseover','mouseout','click','dblclick','touchstart','touchmove','touchend','tap','dbltap','dragstart','dragmove','dragend'],stages:[],idCounter:0,tempNodes:{},maxDragTimeInterval:20,drag:{moving:false,offset:{x:0,y:0},lastDrawTime:0},warn:function(str){if(console&&console.warn){console.warn('Kinetic warning: '+str);}},_pullNodes:function(stage){var tempNodes=this.tempNodes;for(var key in tempNodes){var node=tempNodes[key];if(node.getStage()!==undefined&&node.getStage()._id===stage._id){stage._addId(node);stage._addName(node);this._removeTempNode(node);}}},_addTempNode:function(node){this.tempNodes[node._id]=node;},_removeTempNode:function(node){delete this.tempNodes[node._id];}};Kinetic.Transition=function(node,config){this.node=node;this.config=config;this.tweens=[];var that=this;function addTween(c,attrs,obj,rootObj){for(var key in c){if(key!=='duration'&&key!=='easing'&&key!=='callback'){if(Kinetic.Type._isObject(c[key])){obj[key]={};addTween(c[key],attrs[key],obj[key],rootObj);}
else{that._add(that._getTween(attrs,key,c[key],obj,rootObj));}}}}
var obj={};addTween(config,node.attrs,obj,obj);var finishedTweens=0;for(var n=0;n<this.tweens.length;n++){var tween=this.tweens[n];tween.onFinished=function(){finishedTweens++;if(finishedTweens>=that.tweens.length){that.onFinished();}};}};Kinetic.Transition.prototype={start:function(){for(var n=0;n<this.tweens.length;n++){this.tweens[n].start();}},stop:function(){for(var n=0;n<this.tweens.length;n++){this.tweens[n].stop();}},resume:function(){for(var n=0;n<this.tweens.length;n++){this.tweens[n].resume();}},_onEnterFrame:function(){for(var n=0;n<this.tweens.length;n++){this.tweens[n].onEnterFrame();}},_add:function(tween){this.tweens.push(tween);},_getTween:function(attrs,prop,val,obj,rootObj){var config=this.config;var node=this.node;var easing=config.easing;if(easing===undefined){easing='linear';}
var tween=new Kinetic.Tween(node,function(i){obj[prop]=i;node.setAttrs(rootObj);},Kinetic.Tweens[easing],attrs[prop],val,config.duration);return tween;}};Kinetic.Filters.Grayscale=function(){var data=this.imageData.data;for(var i=0;i<data.length;i+=4){var brightness=0.34*data[i]+0.5*data[i+1]+0.16*data[i+2];data[i]=brightness;data[i+1]=brightness;data[i+2]=brightness;}};Kinetic.Type={_isElement:function(obj){return!!(obj&&obj.nodeType==1);},_isFunction:function(obj){return!!(obj&&obj.constructor&&obj.call&&obj.apply);},_isObject:function(obj){return(!!obj&&obj.constructor==Object);},_isArray:function(obj){return Object.prototype.toString.call(obj)=='[object Array]';},_isNumber:function(obj){return Object.prototype.toString.call(obj)=='[object Number]';},_isString:function(obj){return Object.prototype.toString.call(obj)=='[object String]';},_hasMethods:function(obj){var names=[];for(var key in obj){if(this._isFunction(obj[key]))
names.push(key);}
return names.length>0;},_getXY:function(arg){if(this._isNumber(arg)){return{x:arg,y:arg};}
else if(this._isArray(arg)){if(arg.length===1){var val=arg[0];if(this._isNumber(val)){return{x:val,y:val};}
else if(this._isArray(val)){return{x:val[0],y:val[1]};}
else if(this._isObject(val)){return val;}}
else if(arg.length>=2){return{x:arg[0],y:arg[1]};}}
else if(this._isObject(arg)){return arg;}
return{x:0,y:0};},_getSize:function(arg){if(this._isNumber(arg)){return{width:arg,height:arg};}
else if(this._isArray(arg)){if(arg.length===1){var val=arg[0];if(this._isNumber(val)){return{width:val,height:val};}
else if(this._isArray(val)){if(val.length>=4){return{width:val[2],height:val[3]};}
else if(val.length>=2){return{width:val[0],height:val[1]};}}
else if(this._isObject(val)){return val;}}
else if(arg.length>=4){return{width:arg[2],height:arg[3]};}
else if(arg.length>=2){return{width:arg[0],height:arg[1]};}}
else if(this._isObject(arg)){return arg;}
return{width:0,height:0};},_getPoints:function(arg){if(arg===undefined){return[];}
if(this._isObject(arg[0])){return arg;}
else{var arr=[];for(var n=0;n<arg.length;n+=2){arr.push({x:arg[n],y:arg[n+1]});}
return arr;}},_getImage:function(arg,callback){if(!arg){callback(null);}
else if(this._isElement(arg)){callback(arg);}
else if(this._isString(arg)){var imageObj=new Image();imageObj.onload=function(){callback(imageObj);}
imageObj.src=arg;}
else if(arg.data){var canvas=document.createElement('canvas');canvas.width=arg.width;canvas.height=arg.height;var context=canvas.getContext('2d');context.putImageData(arg,0,0);var dataUrl=canvas.toDataURL();var imageObj=new Image();imageObj.onload=function(){callback(imageObj);}
imageObj.src=dataUrl;}
else{callback(null);}}};Kinetic.Canvas=function(width,height){this.element=document.createElement('canvas');this.context=this.element.getContext('2d');this.element.width=width;this.element.height=height;};Kinetic.Canvas.prototype={clear:function(){var context=this.getContext();var el=this.getElement();context.clearRect(0,0,el.width,el.height);},getElement:function(){return this.element;},getContext:function(){return this.context;},setWidth:function(width){this.element.width=width;},setHeight:function(height){this.element.height=height;},getWidth:function(){return this.element.width;},getHeight:function(){return this.element.height;},setSize:function(width,height){this.setWidth(width);this.setHeight(height);},strip:function(){var context=this.context;context.stroke=function(){};context.fill=function(){};context.fillRect=function(x,y,width,height){context.rect(x,y,width,height);};context.strokeRect=function(x,y,width,height){context.rect(x,y,width,height);};context.drawImage=function(){};context.fillText=function(){};context.strokeText=function(){};},toDataURL:function(mimeType,quality){try{return this.element.toDataURL(mimeType,quality);}
catch(e){return this.element.toDataURL();}}};(function(){var initializing=false;Kinetic.Class=function(){};Kinetic.Class.extend=function(prop){var _super=this.prototype;initializing=true;var prototype=new this();initializing=false;for(var name in prop){prototype[name]=typeof prop[name]=="function"&&typeof _super[name]=="function"?(function(name,fn){return function(){var tmp=this._super;this._super=_super[name];var ret=fn.apply(this,arguments);this._super=tmp;return ret;};})(name,prop[name]):prop[name];}
function Class(){if(!initializing&&this.init)
this.init.apply(this,arguments);}
Class.prototype=prototype;Class.prototype.constructor=Class;Class.extend=arguments.callee;return Class;};})();Kinetic.Tween=function(obj,propFunc,func,begin,finish,duration){this._listeners=[];this.addListener(this);this.obj=obj;this.propFunc=propFunc;this.begin=begin;this._pos=begin;this.setDuration(duration);this.isPlaying=false;this._change=0;this.prevTime=0;this.prevPos=0;this.looping=false;this._time=0;this._position=0;this._startTime=0;this._finish=0;this.name='';this.func=func;this.setFinish(finish);};Kinetic.Tween.prototype={setTime:function(t){this.prevTime=this._time;if(t>this.getDuration()){if(this.looping){this.rewind(t-this._duration);this.update();this.broadcastMessage('onLooped',{target:this,type:'onLooped'});}
else{this._time=this._duration;this.update();this.stop();this.broadcastMessage('onFinished',{target:this,type:'onFinished'});}}
else if(t<0){this.rewind();this.update();}
else{this._time=t;this.update();}},getTime:function(){return this._time;},setDuration:function(d){this._duration=(d===null||d<=0)?100000:d;},getDuration:function(){return this._duration;},setPosition:function(p){this.prevPos=this._pos;this.propFunc(p);this._pos=p;this.broadcastMessage('onChanged',{target:this,type:'onChanged'});},getPosition:function(t){if(t===undefined){t=this._time;}
return this.func(t,this.begin,this._change,this._duration);},setFinish:function(f){this._change=f-this.begin;},getFinish:function(){return this.begin+this._change;},start:function(){this.rewind();this.startEnterFrame();this.broadcastMessage('onStarted',{target:this,type:'onStarted'});},rewind:function(t){this.stop();this._time=(t===undefined)?0:t;this.fixTime();this.update();},fforward:function(){this._time=this._duration;this.fixTime();this.update();},update:function(){this.setPosition(this.getPosition(this._time));},startEnterFrame:function(){this.stopEnterFrame();this.isPlaying=true;this.onEnterFrame();},onEnterFrame:function(){if(this.isPlaying){this.nextFrame();}},nextFrame:function(){this.setTime((this.getTimer()-this._startTime)/1000);},stop:function(){this.stopEnterFrame();this.broadcastMessage('onStopped',{target:this,type:'onStopped'});},stopEnterFrame:function(){this.isPlaying=false;},continueTo:function(finish,duration){this.begin=this._pos;this.setFinish(finish);if(this._duration!==undefined){this.setDuration(duration);}
this.start();},resume:function(){this.fixTime();this.startEnterFrame();this.broadcastMessage('onResumed',{target:this,type:'onResumed'});},yoyo:function(){this.continueTo(this.begin,this._time);},addListener:function(o){this.removeListener(o);return this._listeners.push(o);},removeListener:function(o){var a=this._listeners;var i=a.length;while(i--){if(a[i]==o){a.splice(i,1);return true;}}
return false;},broadcastMessage:function(){var arr=[];for(var i=0;i<arguments.length;i++){arr.push(arguments[i]);}
var e=arr.shift();var a=this._listeners;var l=a.length;for(var i=0;i<l;i++){if(a[i][e]){a[i][e].apply(a[i],arr);}}},fixTime:function(){this._startTime=this.getTimer()-this._time*1000;},getTimer:function(){return new Date().getTime()-this._time;}};Kinetic.Tweens={'back-ease-in':function(t,b,c,d,a,p){var s=1.70158;return c*(t/=d)*t*((s+1)*t-s)+b;},'back-ease-out':function(t,b,c,d,a,p){var s=1.70158;return c*((t=t/d-1)*t*((s+1)*t+s)+1)+b;},'back-ease-in-out':function(t,b,c,d,a,p){var s=1.70158;if((t/=d/2)<1){return c/2*(t*t*(((s*=(1.525))+1)*t-s))+b;}
return c/2*((t-=2)*t*(((s*=(1.525))+1)*t+s)+2)+b;},'elastic-ease-in':function(t,b,c,d,a,p){var s=0;if(t===0){return b;}
if((t/=d)==1){return b+c;}
if(!p){p=d*0.3;}
if(!a||a<Math.abs(c)){a=c;s=p/4;}
else{s=p/(2*Math.PI)*Math.asin(c/a);}
return-(a*Math.pow(2,10*(t-=1))*Math.sin((t*d-s)*(2*Math.PI)/p))+b;},'elastic-ease-out':function(t,b,c,d,a,p){var s=0;if(t===0){return b;}
if((t/=d)==1){return b+c;}
if(!p){p=d*0.3;}
if(!a||a<Math.abs(c)){a=c;s=p/4;}
else{s=p/(2*Math.PI)*Math.asin(c/a);}
return(a*Math.pow(2,-10*t)*Math.sin((t*d-s)*(2*Math.PI)/p)+c+b);},'elastic-ease-in-out':function(t,b,c,d,a,p){var s=0;if(t===0){return b;}
if((t/=d/2)==2){return b+c;}
if(!p){p=d*(0.3*1.5);}
if(!a||a<Math.abs(c)){a=c;s=p/4;}
else{s=p/(2*Math.PI)*Math.asin(c/a);}
if(t<1){return-0.5*(a*Math.pow(2,10*(t-=1))*Math.sin((t*d-s)*(2*Math.PI)/p))+b;}
return a*Math.pow(2,-10*(t-=1))*Math.sin((t*d-s)*(2*Math.PI)/p)*0.5+c+b;},'bounce-ease-out':function(t,b,c,d){if((t/=d)<(1/2.75)){return c*(7.5625*t*t)+b;}
else if(t<(2/2.75)){return c*(7.5625*(t-=(1.5/2.75))*t+0.75)+b;}
else if(t<(2.5/2.75)){return c*(7.5625*(t-=(2.25/2.75))*t+0.9375)+b;}
else{return c*(7.5625*(t-=(2.625/2.75))*t+0.984375)+b;}},'bounce-ease-in':function(t,b,c,d){return c-Kinetic.Tweens['bounce-ease-out'](d-t,0,c,d)+b;},'bounce-ease-in-out':function(t,b,c,d){if(t<d/2){return Kinetic.Tweens['bounce-ease-in'](t*2,0,c,d)*0.5+b;}
else{return Kinetic.Tweens['bounce-ease-out'](t*2-d,0,c,d)*0.5+c*0.5+b;}},'ease-in':function(t,b,c,d){return c*(t/=d)*t+b;},'ease-out':function(t,b,c,d){return-c*(t/=d)*(t-2)+b;},'ease-in-out':function(t,b,c,d){if((t/=d/2)<1){return c/2*t*t+b;}
return-c/2*((--t)*(t-2)-1)+b;},'strong-ease-in':function(t,b,c,d){return c*(t/=d)*t*t*t*t+b;},'strong-ease-out':function(t,b,c,d){return c*((t=t/d-1)*t*t*t*t+1)+b;},'strong-ease-in-out':function(t,b,c,d){if((t/=d/2)<1){return c/2*t*t*t*t*t+b;}
return c/2*((t-=2)*t*t*t*t+2)+b;},'linear':function(t,b,c,d){return c*t/d+b;}};Kinetic.Transform=function(){this.m=[1,0,0,1,0,0];}
Kinetic.Transform.prototype={translate:function(x,y){this.m[4]+=this.m[0]*x+this.m[2]*y;this.m[5]+=this.m[1]*x+this.m[3]*y;},scale:function(sx,sy){this.m[0]*=sx;this.m[1]*=sx;this.m[2]*=sy;this.m[3]*=sy;},rotate:function(rad){var c=Math.cos(rad);var s=Math.sin(rad);var m11=this.m[0]*c+this.m[2]*s;var m12=this.m[1]*c+this.m[3]*s;var m21=this.m[0]*-s+this.m[2]*c;var m22=this.m[1]*-s+this.m[3]*c;this.m[0]=m11;this.m[1]=m12;this.m[2]=m21;this.m[3]=m22;},getTranslation:function(){return{x:this.m[4],y:this.m[5]};},multiply:function(matrix){var m11=this.m[0]*matrix.m[0]+this.m[2]*matrix.m[1];var m12=this.m[1]*matrix.m[0]+this.m[3]*matrix.m[1];var m21=this.m[0]*matrix.m[2]+this.m[2]*matrix.m[3];var m22=this.m[1]*matrix.m[2]+this.m[3]*matrix.m[3];var dx=this.m[0]*matrix.m[4]+this.m[2]*matrix.m[5]+this.m[4];var dy=this.m[1]*matrix.m[4]+this.m[3]*matrix.m[5]+this.m[5];this.m[0]=m11;this.m[1]=m12;this.m[2]=m21;this.m[3]=m22;this.m[4]=dx;this.m[5]=dy;},invert:function(){var d=1/(this.m[0]*this.m[3]-this.m[1]*this.m[2]);var m0=this.m[3]*d;var m1=-this.m[1]*d;var m2=-this.m[2]*d;var m3=this.m[0]*d;var m4=d*(this.m[2]*this.m[5]-this.m[3]*this.m[4]);var m5=d*(this.m[1]*this.m[4]-this.m[0]*this.m[5]);this.m[0]=m0;this.m[1]=m1;this.m[2]=m2;this.m[3]=m3;this.m[4]=m4;this.m[5]=m5;},getMatrix:function(){return this.m;}};Kinetic.Animation=function(config){if(!config){config={};}
for(var key in config){this[key]=config[key];}
this.id=Kinetic.Animation.animIdCounter++;};Kinetic.Animation.animations=[];Kinetic.Animation.animIdCounter=0;Kinetic.Animation.animRunning=false;Kinetic.Animation.frame={time:0,timeDiff:0,lastTime:new Date().getTime()};Kinetic.Animation._addAnimation=function(anim){this.animations.push(anim);};Kinetic.Animation._removeAnimation=function(anim){var id=anim.id;var animations=this.animations;for(var n=0;n<animations.length;n++){if(animations[n].id===id){this.animations.splice(n,1);return false;}}};Kinetic.Animation._runFrames=function(){var nodes={};for(var n=0;n<this.animations.length;n++){var anim=this.animations[n];if(anim.node&&anim.node._id!==undefined){nodes[anim.node._id]=anim.node;}
if(anim.func){anim.func(this.frame);}}
for(var key in nodes){nodes[key].draw();}};Kinetic.Animation._updateFrameObject=function(){var time=new Date().getTime();this.frame.timeDiff=time-this.frame.lastTime;this.frame.lastTime=time;this.frame.time+=this.frame.timeDiff;};Kinetic.Animation._animationLoop=function(){if(this.animations.length>0){this._updateFrameObject();this._runFrames();var that=this;requestAnimFrame(function(){that._animationLoop();});}
else{this.animRunning=false;this.frame.lastTime=0;}};Kinetic.Animation._handleAnimation=function(){var that=this;if(!this.animRunning){this.animRunning=true;that._animationLoop();}
else{this.frame.lastTime=0;}};requestAnimFrame=(function(callback){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(callback){window.setTimeout(callback,1000/60);};})();Kinetic.Node=Kinetic.Class.extend({init:function(config){this.defaultNodeAttrs={visible:true,listening:true,name:undefined,alpha:1,x:0,y:0,scale:{x:1,y:1},rotation:0,offset:{x:0,y:0},dragConstraint:'none',dragBounds:{},draggable:false,dragThrottle:80};this.setDefaultAttrs(this.defaultNodeAttrs);this.eventListeners={};this.lastDragTime=0;this.transAnim=new Kinetic.Animation();this.setAttrs(config);this.on('draggableChange.kinetic',function(){this._onDraggableChange();});var that=this;this.on('idChange.kinetic',function(evt){var stage=that.getStage();if(stage){stage._removeId(evt.oldVal);stage._addId(that);}});this.on('nameChange.kinetic',function(evt){var stage=that.getStage();if(stage){stage._removeName(evt.oldVal,that._id);stage._addName(that);}});this._onDraggableChange();},on:function(typesStr,handler){var types=typesStr.split(' ');for(var n=0;n<types.length;n++){var type=types[n];var event=type;var parts=event.split('.');var baseEvent=parts[0];var name=parts.length>1?parts[1]:'';if(!this.eventListeners[baseEvent]){this.eventListeners[baseEvent]=[];}
this.eventListeners[baseEvent].push({name:name,handler:handler});}},off:function(typesStr){var types=typesStr.split(' ');for(var n=0;n<types.length;n++){var type=types[n];var event=type;var parts=event.split('.');var baseEvent=parts[0];if(this.eventListeners[baseEvent]&&parts.length>1){var name=parts[1];for(var i=0;i<this.eventListeners[baseEvent].length;i++){if(this.eventListeners[baseEvent][i].name===name){this.eventListeners[baseEvent].splice(i,1);if(this.eventListeners[baseEvent].length===0){delete this.eventListeners[baseEvent];break;}
i--;}}}
else{delete this.eventListeners[baseEvent];}}},getAttrs:function(){return this.attrs;},setDefaultAttrs:function(config){if(this.attrs===undefined){this.attrs={};}
if(config){for(var key in config){if(this.attrs[key]===undefined){this.attrs[key]=config[key];}}}},setAttrs:function(config){var type=Kinetic.Type;var that=this;if(config!==undefined){function setAttrs(obj,c,level){for(var key in c){var val=c[key];var oldVal=obj[key];if(level===0){that._fireBeforeChangeEvent(key,oldVal,val);}
if(obj[key]===undefined&&val!==undefined){obj[key]={};}
if(type._isObject(val)&&!type._isArray(val)&&!type._isElement(val)&&!type._hasMethods(val)){if(!Kinetic.Type._isObject(obj[key])){obj[key]={};}
setAttrs(obj[key],val,level+1);}
else{switch(key){case'rotationDeg':that._setAttr(obj,'rotation',c[key]*Math.PI/180);key='rotation';break;case'offset':var pos=type._getXY(val);that._setAttr(obj[key],'x',pos.x);that._setAttr(obj[key],'y',pos.y);break;case'scale':var pos=type._getXY(val);that._setAttr(obj[key],'x',pos.x);that._setAttr(obj[key],'y',pos.y);break;case'points':that._setAttr(obj,key,type._getPoints(val));break;case'crop':var pos=type._getXY(val);var size=type._getSize(val);that._setAttr(obj[key],'x',pos.x);that._setAttr(obj[key],'y',pos.y);that._setAttr(obj[key],'width',size.width);that._setAttr(obj[key],'height',size.height);break;default:that._setAttr(obj,key,val);break;}}
if(level===0){that._fireChangeEvent(key,oldVal,val);}}}
setAttrs(this.attrs,config,0);}},isVisible:function(){if(this.attrs.visible&&this.getParent()&&!this.getParent().isVisible()){return false;}
return this.attrs.visible;},show:function(){this.setAttrs({visible:true});},hide:function(){this.setAttrs({visible:false});},getZIndex:function(){return this.index;},getAbsoluteZIndex:function(){var level=this.getLevel();var stage=this.getStage();var that=this;var index=0;function addChildren(children){var nodes=[];for(var n=0;n<children.length;n++){var child=children[n];index++;if(child.nodeType!=='Shape'){nodes=nodes.concat(child.getChildren());}
if(child._id===that._id){n=children.length;}}
if(nodes.length>0&&nodes[0].getLevel()<=level){addChildren(nodes);}}
if(that.nodeType!=='Stage'){addChildren(that.getStage().getChildren());}
return index;},getLevel:function(){var level=0;var parent=this.parent;while(parent){level++;parent=parent.parent;}
return level;},setPosition:function(){var pos=Kinetic.Type._getXY(Array.prototype.slice.call(arguments));this.setAttrs(pos);},getPosition:function(){return{x:this.attrs.x,y:this.attrs.y};},getAbsolutePosition:function(){var trans=this.getAbsoluteTransform();var o=this.getOffset();trans.translate(o.x,o.y);return trans.getTranslation();},setAbsolutePosition:function(){var pos=Kinetic.Type._getXY(Array.prototype.slice.call(arguments));var trans=this._clearTransform();this.attrs.x=trans.x;this.attrs.y=trans.y;delete trans.x;delete trans.y;var it=this.getAbsoluteTransform();it.invert();it.translate(pos.x,pos.y);pos={x:this.attrs.x+it.getTranslation().x,y:this.attrs.y+it.getTranslation().y};this.setPosition(pos.x,pos.y);this._setTransform(trans);},move:function(){var pos=Kinetic.Type._getXY(Array.prototype.slice.call(arguments));var x=this.getX();var y=this.getY();if(pos.x!==undefined){x+=pos.x;}
if(pos.y!==undefined){y+=pos.y;}
this.setAttrs({x:x,y:y});},getRotationDeg:function(){return this.attrs.rotation*180/Math.PI;},rotate:function(theta){this.setAttrs({rotation:this.getRotation()+theta});},rotateDeg:function(deg){this.setAttrs({rotation:this.getRotation()+(deg*Math.PI/180)});},moveToTop:function(){var index=this.index;this.parent.children.splice(index,1);this.parent.children.push(this);this.parent._setChildrenIndices();},moveUp:function(){var index=this.index;this.parent.children.splice(index,1);this.parent.children.splice(index+1,0,this);this.parent._setChildrenIndices();},moveDown:function(){var index=this.index;if(index>0){this.parent.children.splice(index,1);this.parent.children.splice(index-1,0,this);this.parent._setChildrenIndices();}},moveToBottom:function(){var index=this.index;this.parent.children.splice(index,1);this.parent.children.unshift(this);this.parent._setChildrenIndices();},setZIndex:function(zIndex){var index=this.index;this.parent.children.splice(index,1);this.parent.children.splice(zIndex,0,this);this.parent._setChildrenIndices();},getAbsoluteAlpha:function(){var absAlpha=1;var node=this;while(node.nodeType!=='Stage'){absAlpha*=node.attrs.alpha;node=node.parent;}
return absAlpha;},isDragging:function(){var go=Kinetic.Global;return go.drag.node!==undefined&&go.drag.node._id===this._id&&go.drag.moving;},moveTo:function(newContainer){var parent=this.parent;parent.children.splice(this.index,1);parent._setChildrenIndices();newContainer.children.push(this);this.index=newContainer.children.length-1;this.parent=newContainer;newContainer._setChildrenIndices();},getParent:function(){return this.parent;},getLayer:function(){if(this.nodeType==='Layer'){return this;}
else{return this.getParent().getLayer();}},getStage:function(){if(this.nodeType!=='Stage'&&this.getParent()){return this.getParent().getStage();}
else if(this.nodeType==='Stage'){return this;}
else{return undefined;}},simulate:function(eventType){this._handleEvent(eventType,{});},transitionTo:function(config){var a=Kinetic.Animation;a._removeAnimation(this.transAnim);var node=this.nodeType==='Stage'?this:this.getLayer();var that=this;var trans=new Kinetic.Transition(this,config);this.transAnim.func=function(){trans._onEnterFrame();};this.transAnim.node=node;a._addAnimation(this.transAnim);trans.onFinished=function(){a._removeAnimation(that.transAnim);that.transAnim.node.draw();if(config.callback){config.callback();}};trans.start();a._handleAnimation();return trans;},getAbsoluteTransform:function(){var am=new Kinetic.Transform();var family=[];var parent=this.parent;family.unshift(this);while(parent){family.unshift(parent);parent=parent.parent;}
for(var n=0;n<family.length;n++){var node=family[n];var m=node.getTransform();am.multiply(m);}
return am;},getTransform:function(){var m=new Kinetic.Transform();if(this.attrs.x!==0||this.attrs.y!==0){m.translate(this.attrs.x,this.attrs.y);}
if(this.attrs.rotation!==0){m.rotate(this.attrs.rotation);}
if(this.attrs.scale.x!==1||this.attrs.scale.y!==1){m.scale(this.attrs.scale.x,this.attrs.scale.y);}
if(this.attrs.offset&&(this.attrs.offset.x!==0||this.attrs.offset.y!==0)){m.translate(-1*this.attrs.offset.x,-1*this.attrs.offset.y);}
return m;},clone:function(obj){var classType=this.shapeType||this.nodeType;var node=new Kinetic[classType](this.attrs);for(var key in this.eventListeners){var allListeners=this.eventListeners[key];for(var n=0;n<allListeners.length;n++){var listener=allListeners[n];if(listener.name.indexOf('kinetic')<0){if(!node.eventListeners[key]){node.eventListeners[key]=[];}
node.eventListeners[key].push(listener);}}}
node.setAttrs(obj);return node;},saveImageData:function(width,height){try{var canvas;if(width&&height){canvas=new Kinetic.Canvas(width,height);}
else{var stage=this.getStage();canvas=stage.bufferCanvas;}
var context=canvas.getContext();canvas.clear();this._draw(canvas);var imageData=context.getImageData(0,0,canvas.getWidth(),canvas.getHeight());this.imageData=imageData;}
catch(e){Kinetic.Global.warn('Image data could not saved because canvas is dirty.');}},clearImageData:function(){delete this.imageData;},getImageData:function(){return this.imageData;},toDataURL:function(config){var mimeType=config&&config.mimeType?config.mimeType:null;var quality=config&&config.quality?config.quality:null;var canvas;if(config&&config.width&&config.height){canvas=new Kinetic.Canvas(config.width,config.height);}
else{canvas=this.getStage().bufferCanvas;}
var context=canvas.getContext();canvas.clear();this._draw(canvas);return canvas.toDataURL(mimeType,quality);},toImage:function(config){Kinetic.Type._getImage(this.toDataURL(config),function(img){config.callback(img);});},_clearTransform:function(){var trans={x:this.attrs.x,y:this.attrs.y,rotation:this.attrs.rotation,scale:{x:this.attrs.scale.x,y:this.attrs.scale.y},offset:{x:this.attrs.offset.x,y:this.attrs.offset.y}};this.attrs.x=0;this.attrs.y=0;this.attrs.rotation=0;this.attrs.scale={x:1,y:1};this.attrs.offset={x:0,y:0};return trans;},_setTransform:function(trans){for(var key in trans){this.attrs[key]=trans[key];}},_setImageData:function(imageData){if(imageData&&imageData.data){this.imageData=imageData;}},_fireBeforeChangeEvent:function(attr,oldVal,newVal){this._handleEvent('before'+attr.toUpperCase()+'Change',{oldVal:oldVal,newVal:newVal});},_fireChangeEvent:function(attr,oldVal,newVal){this._handleEvent(attr+'Change',{oldVal:oldVal,newVal:newVal});},_setAttr:function(obj,attr,val){if(val!==undefined){if(obj===undefined){obj={};}
obj[attr]=val;}},_listenDrag:function(){this._dragCleanup();var go=Kinetic.Global;var that=this;this.on('mousedown.kinetic touchstart.kinetic',function(evt){that._initDrag();});},_initDrag:function(){var go=Kinetic.Global;var stage=this.getStage();var pos=stage.getUserPosition();if(pos){var m=this.getTransform().getTranslation();var am=this.getAbsoluteTransform().getTranslation();var ap=this.getAbsolutePosition();go.drag.node=this;go.drag.offset.x=pos.x-ap.x;go.drag.offset.y=pos.y-ap.y;}},_onDraggableChange:function(){if(this.attrs.draggable){this._listenDrag();}
else{this._dragCleanup();var stage=this.getStage();var go=Kinetic.Global;if(stage&&go.drag.node&&go.drag.node._id===this._id){stage._endDrag();}}},_dragCleanup:function(){this.off('mousedown.kinetic');this.off('touchstart.kinetic');},_handleEvent:function(eventType,evt){if(this.nodeType==='Shape'){evt.shape=this;}
var stage=this.getStage();var mover=stage?stage.mouseoverShape:null;var mout=stage?stage.mouseoutShape:null;var el=this.eventListeners;var okayToRun=true;if(eventType==='mouseover'&&mout&&mout._id===this._id){okayToRun=false;}
else if(eventType==='mouseout'&&mover&&mover._id===this._id){okayToRun=false;}
if(okayToRun){if(el[eventType]){var events=el[eventType];for(var i=0;i<events.length;i++){events[i].handler.apply(this,[evt]);}}
if(stage&&mover&&mout){stage.mouseoverShape=mover.parent;stage.mouseoutShape=mout.parent;}
if(Kinetic.Global.BUBBLE_WHITELIST.indexOf(eventType)>=0&&!evt.cancelBubble&&this.parent){this._handleEvent.call(this.parent,eventType,evt);}}}});Kinetic.Node.addSetters=function(constructor,arr){for(var n=0;n<arr.length;n++){var attr=arr[n];this._addSetter(constructor,attr);}};Kinetic.Node.addGetters=function(constructor,arr){for(var n=0;n<arr.length;n++){var attr=arr[n];this._addGetter(constructor,attr);}};Kinetic.Node.addGettersSetters=function(constructor,arr){this.addSetters(constructor,arr);this.addGetters(constructor,arr);};Kinetic.Node._addSetter=function(constructor,attr){var that=this;var method='set'+attr.charAt(0).toUpperCase()+attr.slice(1);constructor.prototype[method]=function(){if(arguments.length==1){arg=arguments[0];}
else{arg=Array.prototype.slice.call(arguments);}
var obj={};obj[attr]=arg;this.setAttrs(obj);};};Kinetic.Node._addGetter=function(constructor,attr){var that=this;var method='get'+attr.charAt(0).toUpperCase()+attr.slice(1);constructor.prototype[method]=function(arg){return this.attrs[attr];};};Kinetic.Node.addGettersSetters(Kinetic.Node,['x','y','scale','detectionType','rotation','alpha','name','id','offset','draggable','dragConstraint','dragBounds','listening','dragThrottle']);Kinetic.Node.addSetters(Kinetic.Node,['rotationDeg']);Kinetic.Container=Kinetic.Node.extend({init:function(config){this.children=[];this._super(config);},getChildren:function(){return this.children;},removeChildren:function(){while(this.children.length>0){this.remove(this.children[0]);}},add:function(child){child._id=Kinetic.Global.idCounter++;child.index=this.children.length;child.parent=this;this.children.push(child);var stage=child.getStage();if(!stage){Kinetic.Global._addTempNode(child);}
else{stage._addId(child);stage._addName(child);var go=Kinetic.Global;go._pullNodes(stage);}
if(this._add!==undefined){this._add(child);}
return this;},remove:function(child){if(child&&child.index!==undefined&&this.children[child.index]._id==child._id){var stage=this.getStage();if(stage){stage._removeId(child.getId());stage._removeName(child.getName(),child._id);}
Kinetic.Global._removeTempNode(child);this.children.splice(child.index,1);this._setChildrenIndices();while(child.children&&child.children.length>0){child.remove(child.children[0]);}
if(this._remove!==undefined){this._remove(child);}}
return this;},get:function(selector){var stage=this.getStage();var arr;var key=selector.slice(1);if(selector.charAt(0)==='#'){arr=stage.ids[key]!==undefined?[stage.ids[key]]:[];}
else if(selector.charAt(0)==='.'){arr=stage.names[key]!==undefined?stage.names[key]:[];}
else if(selector==='Shape'||selector==='Group'||selector==='Layer'){return this._getNodes(selector);}
else{return false;}
var retArr=[];for(var n=0;n<arr.length;n++){var node=arr[n];if(this.isAncestorOf(node)){retArr.push(node);}}
return retArr;},isAncestorOf:function(node){if(this.nodeType==='Stage'){return true;}
var parent=node.getParent();while(parent){if(parent._id===this._id){return true;}
parent=parent.getParent();}
return false;},getIntersections:function(){var pos=Kinetic.Type._getXY(Array.prototype.slice.call(arguments));var arr=[];var shapes=this.get('Shape');for(var n=0;n<shapes.length;n++){var shape=shapes[n];if(shape.isVisible()&&shape.intersects(pos)){arr.push(shape);}}
return arr;},_getNodes:function(sel){var arr=[];function traverse(cont){var children=cont.getChildren();for(var n=0;n<children.length;n++){var child=children[n];if(child.nodeType===sel){arr.push(child);}
else if(child.nodeType!=='Shape'){traverse(child);}}}
traverse(this);return arr;},_drawChildren:function(canvas){var stage=this.getStage();var children=this.children;for(var n=0;n<children.length;n++){var child=children[n];if(child.nodeType==='Shape'){if(child.isVisible()&&stage.isVisible()){child._draw(canvas);}}
else{child.draw(canvas);}}},_setChildrenIndices:function(){for(var n=0;n<this.children.length;n++){this.children[n].index=n;}}});Kinetic.Stage=Kinetic.Container.extend({init:function(config){this.setDefaultAttrs({width:400,height:200});if(typeof config.container==='string'){config.container=document.getElementById(config.container);}
this._super(config);this._setStageDefaultProperties();this._id=Kinetic.Global.idCounter++;this._buildDOM();this._bindContentEvents();this.on('widthChange.kinetic',function(){this._resizeDOM();});this.on('heightChange.kinetic',function(){this._resizeDOM();});var go=Kinetic.Global;go.stages.push(this);this._addId(this);this._addName(this);},onFrame:function(func){this.anim.func=func;},start:function(){if(!this.animRunning){var a=Kinetic.Animation;a._addAnimation(this.anim);a._handleAnimation();this.animRunning=true;}},stop:function(){Kinetic.Animation._removeAnimation(this.anim);this.animRunning=false;},draw:function(canvas){this._draw(canvas);},setSize:function(){var size=Kinetic.Type._getSize(Array.prototype.slice.call(arguments));this.setAttrs(size);},getSize:function(){return{width:this.attrs.width,height:this.attrs.height};},clear:function(){var layers=this.children;for(var n=0;n<layers.length;n++){layers[n].clear();}},toJSON:function(){var type=Kinetic.Type;function addNode(node){var obj={};obj.attrs={};for(var key in node.attrs){var val=node.attrs[key];if(!type._isFunction(val)&&!type._isElement(val)&&!type._hasMethods(val)){obj.attrs[key]=val;}}
obj.nodeType=node.nodeType;obj.shapeType=node.shapeType;if(node.nodeType!=='Shape'){obj.children=[];var children=node.getChildren();for(var n=0;n<children.length;n++){var child=children[n];obj.children.push(addNode(child));}}
return obj;}
return JSON.stringify(addNode(this));},reset:function(){this.removeChildren();this._setStageDefaultProperties();this.setAttrs(this.defaultNodeAttrs);},load:function(json){this.reset();function loadNode(node,obj){var children=obj.children;if(children!==undefined){for(var n=0;n<children.length;n++){var child=children[n];var type;if(child.nodeType==='Shape'){if(child.shapeType===undefined){type='Shape';}
else{type=child.shapeType;}}
else{type=child.nodeType;}
var no=new Kinetic[type](child.attrs);node.add(no);loadNode(no,child);}}}
var obj=JSON.parse(json);this.attrs=obj.attrs;loadNode(this,obj);this.draw();},getMousePosition:function(evt){return this.mousePos;},getTouchPosition:function(evt){return this.touchPos;},getUserPosition:function(evt){return this.getTouchPosition()||this.getMousePosition();},getContainer:function(){return this.attrs.container;},getStage:function(){return this;},getDOM:function(){return this.content;},toDataURL:function(config){var mimeType=config&&config.mimeType?config.mimeType:null;var quality=config&&config.quality?config.quality:null;var width=config&&config.width?config.width:this.attrs.width;var height=config&&config.height?config.height:this.attrs.height;var canvas=new Kinetic.Canvas(width,height);var context=canvas.getContext();var layers=this.children;function drawLayer(n){var layer=layers[n];var layerUrl=layer.getCanvas().toDataURL(mimeType,quality);var imageObj=new Image();imageObj.onload=function(){context.drawImage(imageObj,0,0);if(n<layers.length-1){drawLayer(n+1);}
else{config.callback(canvas.toDataURL(mimeType,quality));}};imageObj.src=layerUrl;}
drawLayer(0);},toImage:function(config){this.toDataURL({callback:function(dataUrl){Kinetic.Type._getImage(dataUrl,function(img){config.callback(img);});}});},_resizeDOM:function(){var width=this.attrs.width;var height=this.attrs.height;this.content.style.width=width+'px';this.content.style.height=height+'px';this.bufferCanvas.setSize(width,height);this.pathCanvas.setSize(width,height);var layers=this.children;for(var n=0;n<layers.length;n++){var layer=layers[n];layer.getCanvas().setSize(width,height);layer.draw();}},_remove:function(layer){try{this.content.removeChild(layer.canvas.element);}
catch(e){}},_add:function(layer){layer.canvas.setSize(this.attrs.width,this.attrs.height);layer.draw();this.content.appendChild(layer.canvas.element);layer.lastDrawTime=0;},_detectEvent:function(shape,evt){var isDragging=Kinetic.Global.drag.moving;var go=Kinetic.Global;var pos=this.getUserPosition();var el=shape.eventListeners;var that=this;if(this.targetShape&&shape._id===this.targetShape._id){this.targetFound=true;}
if(shape.isVisible()&&pos!==undefined&&shape.intersects(pos)){if(!isDragging&&this.mouseDown){this.mouseDown=false;this.clickStart=true;shape._handleEvent('mousedown',evt);return true;}
else if(this.mouseUp){this.mouseUp=false;shape._handleEvent('mouseup',evt);if(this.clickStart){if((!go.drag.moving)||!go.drag.node){shape._handleEvent('click',evt);if(this.inDoubleClickWindow){shape._handleEvent('dblclick',evt);}
this.inDoubleClickWindow=true;setTimeout(function(){that.inDoubleClickWindow=false;},this.dblClickWindow);}}
return true;}
else if(!isDragging&&this.touchStart&&!this.touchMove){this.touchStart=false;this.tapStart=true;shape._handleEvent('touchstart',evt);return true;}
else if(this.touchEnd){this.touchEnd=false;shape._handleEvent('touchend',evt);if(this.tapStart){if((!go.drag.moving)||!go.drag.node){shape._handleEvent('tap',evt);if(this.inDoubleClickWindow){shape._handleEvent('dbltap',evt);}
this.inDoubleClickWindow=true;setTimeout(function(){that.inDoubleClickWindow=false;},this.dblClickWindow);}}
return true;}
else if(!isDragging&&this.touchMove){shape._handleEvent('touchmove',evt);return true;}
else if(!isDragging&&this._isNewTarget(shape,evt)){if(this.mouseoutShape){this.mouseoverShape=shape;this.mouseoutShape._handleEvent('mouseout',evt);this.mouseoverShape=undefined;}
shape._handleEvent('mouseover',evt);this._setTarget(shape);return true;}
else{if(!isDragging&&this.mouseMove){shape._handleEvent('mousemove',evt);return true;}}}
else if(!isDragging&&this.targetShape&&this.targetShape._id===shape._id){this._setTarget(undefined);this.mouseoutShape=shape;return true;}
return false;},_setTarget:function(shape){this.targetShape=shape;this.targetFound=true;},_isNewTarget:function(shape,evt){if(!this.targetShape||(!this.targetFound&&shape._id!==this.targetShape._id)){if(this.targetShape){var oldEl=this.targetShape.eventListeners;if(oldEl){this.mouseoutShape=this.targetShape;}}
return true;}
else{return false;}},_traverseChildren:function(obj,evt){var children=obj.children;for(var i=children.length-1;i>=0;i--){var child=children[i];if(child.getListening()){if(child.nodeType==='Shape'){var exit=this._detectEvent(child,evt);if(exit){return true;}}
else{var exit=this._traverseChildren(child,evt);if(exit){return true;}}}}
return false;},_handleStageEvent:function(evt){var go=Kinetic.Global;if(!evt){evt=window.event;}
this._setMousePosition(evt);this._setTouchPosition(evt);this.pathCanvas.clear();this.targetFound=false;var shapeDetected=false;for(var n=this.children.length-1;n>=0;n--){var layer=this.children[n];if(layer.isVisible()&&n>=0&&layer.getListening()){if(this._traverseChildren(layer,evt)){shapeDetected=true;break;}}}
if(!shapeDetected&&this.mouseoutShape){this.mouseoutShape._handleEvent('mouseout',evt);this.mouseoutShape=undefined;}},_bindContentEvents:function(){var go=Kinetic.Global;var that=this;var events=['mousedown','mousemove','mouseup','mouseover','mouseout','touchstart','touchmove','touchend'];for(var n=0;n<events.length;n++){var pubEvent=events[n];(function(){var event=pubEvent;that.content.addEventListener(event,function(evt){that['_'+event](evt);},false);}());}},_mouseover:function(evt){this._handleStageEvent(evt);},_mouseout:function(evt){var targetShape=this.targetShape;if(targetShape){targetShape._handleEvent('mouseout',evt);this.targetShape=undefined;}
this.mousePos=undefined;this._endDrag(evt);},_mousemove:function(evt){this.mouseDown=false;this.mouseUp=false;this.mouseMove=true;this._handleStageEvent(evt);this._startDrag(evt);},_mousedown:function(evt){this.mouseDown=true;this.mouseUp=false;this.mouseMove=false;this._handleStageEvent(evt);if(this.attrs.draggable){this._initDrag();}},_mouseup:function(evt){this.mouseDown=false;this.mouseUp=true;this.mouseMove=false;this._handleStageEvent(evt);this.clickStart=false;this._endDrag(evt);},_touchstart:function(evt){evt.preventDefault();this.touchStart=true;this.touchEnd=false;this.touchMove=false;this._handleStageEvent(evt);if(this.attrs.draggable){this._initDrag();}},_touchend:function(evt){this.touchStart=false;this.touchEnd=true;this.touchMove=false;this._handleStageEvent(evt);this.tapStart=false;this._endDrag(evt);},_touchmove:function(evt){evt.preventDefault();this.touchEnd=false;this.touchMove=true;this._handleStageEvent(evt);this._startDrag(evt);},_setMousePosition:function(evt){var mouseX=evt.offsetX||(evt.clientX-this._getContentPosition().left+window.pageXOffset);var mouseY=evt.offsetY||(evt.clientY-this._getContentPosition().top+window.pageYOffset);this.mousePos={x:mouseX,y:mouseY};},_setTouchPosition:function(evt){if(evt.touches!==undefined&&evt.touches.length===1){var touch=evt.touches[0];var touchX=touch.clientX-this._getContentPosition().left+window.pageXOffset;var touchY=touch.clientY-this._getContentPosition().top+window.pageYOffset;this.touchPos={x:touchX,y:touchY};}},_getContentPosition:function(){var rect=this.content.getBoundingClientRect(),root=document.documentElement;return{top:rect.top+root.scrollTop,left:rect.left+root.scrollLeft};},_endDrag:function(evt){var go=Kinetic.Global;if(go.drag.node){if(go.drag.moving){go.drag.moving=false;go.drag.node._handleEvent('dragend',evt);}}
go.drag.node=undefined;},_startDrag:function(evt){var that=this;var go=Kinetic.Global;var node=go.drag.node;if(node){var dragThrottle=node.attrs.dragThrottle;var time=new Date().getTime();var timeDiff=time-node.lastDragTime;var tt=1000/dragThrottle;if((timeDiff>=tt||dragThrottle>200)){var pos=that.getUserPosition();var dc=node.attrs.dragConstraint;var db=node.attrs.dragBounds;var lastNodePos={x:node.attrs.x,y:node.attrs.y};var newNodePos={x:pos.x-go.drag.offset.x,y:pos.y-go.drag.offset.y};if(db.left!==undefined&&newNodePos.x<db.left){newNodePos.x=db.left;}
if(db.right!==undefined&&newNodePos.x>db.right){newNodePos.x=db.right;}
if(db.top!==undefined&&newNodePos.y<db.top){newNodePos.y=db.top;}
if(db.bottom!==undefined&&newNodePos.y>db.bottom){newNodePos.y=db.bottom;}
node.setAbsolutePosition(newNodePos);if(dc==='horizontal'){node.attrs.y=lastNodePos.y;}
else if(dc==='vertical'){node.attrs.x=lastNodePos.x;}
if(go.drag.node.nodeType==='Stage'){go.drag.node.draw();}
else{go.drag.node.getLayer().draw();}
if(!go.drag.moving){go.drag.moving=true;go.drag.node._handleEvent('dragstart',evt);}
go.drag.node._handleEvent('dragmove',evt);node.lastDragTime=new Date().getTime();}}},_buildDOM:function(){this.content=document.createElement('div');this.content.style.position='relative';this.content.style.display='inline-block';this.content.className='kineticjs-content';this.attrs.container.appendChild(this.content);this.bufferCanvas=new Kinetic.Canvas({width:this.attrs.width,height:this.attrs.height});this.pathCanvas=new Kinetic.Canvas({width:this.attrs.width,height:this.attrs.height});this.pathCanvas.strip();this._resizeDOM();},_addId:function(node){if(node.attrs.id!==undefined){this.ids[node.attrs.id]=node;}},_removeId:function(id){if(id!==undefined){delete this.ids[id];}},_addName:function(node){var name=node.attrs.name;if(name!==undefined){if(this.names[name]===undefined){this.names[name]=[];}
this.names[name].push(node);}},_removeName:function(name,_id){if(name!==undefined){var nodes=this.names[name];if(nodes!==undefined){for(var n=0;n<nodes.length;n++){var no=nodes[n];if(no._id===_id){nodes.splice(n,1);}}
if(nodes.length===0){delete this.names[name];}}}},_onContent:function(typesStr,handler){var types=typesStr.split(' ');for(var n=0;n<types.length;n++){var baseEvent=types[n];this.content.addEventListener(baseEvent,handler,false);}},_setStageDefaultProperties:function(){this.nodeType='Stage';this.dblClickWindow=400;this.targetShape=undefined;this.targetFound=false;this.mouseoverShape=undefined;this.mouseoutShape=undefined;this.mousePos=undefined;this.mouseDown=false;this.mouseUp=false;this.mouseMove=false;this.clickStart=false;this.touchPos=undefined;this.touchStart=false;this.touchEnd=false;this.touchMove=false;this.tapStart=false;this.ids={};this.names={};this.anim=new Kinetic.Animation();this.animRunning=false;},_draw:function(canvas){this._drawChildren(canvas);}});Kinetic.Node.addGettersSetters(Kinetic.Stage,['width','height']);Kinetic.Layer=Kinetic.Container.extend({init:function(config){this.setDefaultAttrs({clearBeforeDraw:true});this.nodeType='Layer';this.lastDrawTime=0;this.beforeDrawFunc=undefined;this.afterDrawFunc=undefined;this.canvas=new Kinetic.Canvas();this.canvas.getElement().style.position='absolute';this._super(config);},draw:function(canvas){this._draw(canvas);},beforeDraw:function(func){this.beforeDrawFunc=func;},afterDraw:function(func){this.afterDrawFunc=func;},getCanvas:function(){return this.canvas;},getContext:function(){return this.canvas.context;},clear:function(){this.getCanvas().clear();},toDataURL:function(config){var canvas;var mimeType=config&&config.mimeType?config.mimeType:null;var quality=config&&config.quality?config.quality:null;if(config&&config.width&&config.height){canvas=new Kinetic.Canvas(config.width,config.height);}
else{canvas=this.getCanvas();}
return canvas.toDataURL(mimeType,quality);},_draw:function(canvas){if(!canvas){canvas=this.getCanvas();}
var time=new Date().getTime();this.lastDrawTime=time;if(this.beforeDrawFunc!==undefined){this.beforeDrawFunc.call(this);}
if(this.attrs.clearBeforeDraw){canvas.clear();}
if(this.isVisible()){if(this.attrs.drawFunc!==undefined){this.attrs.drawFunc.call(this);}
this._drawChildren(canvas);}
if(this.afterDrawFunc!==undefined){this.afterDrawFunc.call(this);}}});Kinetic.Node.addGettersSetters(Kinetic.Layer,['clearBeforeDraw']);Kinetic.Group=Kinetic.Container.extend({init:function(config){this.nodeType='Group';this._super(config);},draw:function(canvas){this._draw(canvas);},_draw:function(canvas){if(this.attrs.visible){this._drawChildren(canvas);}}});Kinetic.Shape=Kinetic.Node.extend({init:function(config){this.setDefaultAttrs({detectionType:'path'});this.nodeType='Shape';this.appliedShadow=false;this._super(config);},getContext:function(){return this.getLayer().getContext();},getCanvas:function(){return this.getLayer().getCanvas();},stroke:function(context){var strokeWidth=this.getStrokeWidth();var stroke=this.getStroke();if(stroke||strokeWidth){var go=Kinetic.Global;var appliedShadow=false;context.save();if(this.attrs.shadow&&!this.appliedShadow){appliedShadow=this._applyShadow(context);}
context.lineWidth=strokeWidth||2;context.strokeStyle=stroke||'black';context.stroke(context);context.restore();if(appliedShadow){this.stroke(context);}}},fill:function(context){var appliedShadow=false;var fill=this.attrs.fill;if(fill){context.save();if(this.attrs.shadow&&!this.appliedShadow){appliedShadow=this._applyShadow(context);}
var s=fill.start;var e=fill.end;var f=null;if(Kinetic.Type._isString(fill)){context.fillStyle=fill;context.fill(context);}
else if(fill.image){var repeat=!fill.repeat?'repeat':fill.repeat;if(fill.scale){context.scale(fill.scale.x,fill.scale.y);}
if(fill.offset){context.translate(fill.offset.x,fill.offset.y);}
context.fillStyle=context.createPattern(fill.image,repeat);context.fill(context);}
else if(!s.radius&&!e.radius){var grd=context.createLinearGradient(s.x,s.y,e.x,e.y);var colorStops=fill.colorStops;for(var n=0;n<colorStops.length;n+=2){grd.addColorStop(colorStops[n],colorStops[n+1]);}
context.fillStyle=grd;context.fill(context);}
else if((s.radius||s.radius===0)&&(e.radius||e.radius===0)){var grd=context.createRadialGradient(s.x,s.y,s.radius,e.x,e.y,e.radius);var colorStops=fill.colorStops;for(var n=0;n<colorStops.length;n+=2){grd.addColorStop(colorStops[n],colorStops[n+1]);}
context.fillStyle=grd;context.fill(context);}
else{context.fillStyle='black';context.fill(context);}
context.restore();}
if(appliedShadow){this.fill(context);}},fillText:function(context,text){var appliedShadow=false;if(this.attrs.textFill){context.save();if(this.attrs.shadow&&!this.appliedShadow){appliedShadow=this._applyShadow(context);}
context.fillStyle=this.attrs.textFill;context.fillText(text,0,0);context.restore();}
if(appliedShadow){this.fillText(context,text,0,0);}},strokeText:function(context,text){var appliedShadow=false;if(this.attrs.textStroke||this.attrs.textStrokeWidth){context.save();if(this.attrs.shadow&&!this.appliedShadow){appliedShadow=this._applyShadow(context);}
var textStroke=this.attrs.textStroke?this.attrs.textStroke:'black';var textStrokeWidth=this.attrs.textStrokeWidth?this.attrs.textStrokeWidth:2;context.lineWidth=textStrokeWidth;context.strokeStyle=textStroke;context.strokeText(text,0,0);context.restore();}
if(appliedShadow){this.strokeText(context,text,0,0);}},drawImage:function(){var appliedShadow=false;var context=arguments[0];context.save();var a=Array.prototype.slice.call(arguments);if(a.length===6||a.length===10){if(this.attrs.shadow&&!this.appliedShadow){appliedShadow=this._applyShadow(context);}
if(a.length===6){context.drawImage(a[1],a[2],a[3],a[4],a[5]);}
else{context.drawImage(a[1],a[2],a[3],a[4],a[5],a[6],a[7],a[8],a[9]);}}
context.restore();if(appliedShadow){this.drawImage.apply(this,a);}},applyLineJoin:function(context){if(this.attrs.lineJoin){context.lineJoin=this.attrs.lineJoin;}},_applyShadow:function(context){var s=this.attrs.shadow;if(s){var aa=this.getAbsoluteAlpha();var color=s.color?s.color:'black';var blur=s.blur?s.blur:5;var offset=s.offset?s.offset:{x:0,y:0};if(s.alpha){context.globalAlpha=s.alpha*aa;}
context.shadowColor=color;context.shadowBlur=blur;context.shadowOffsetX=offset.x;context.shadowOffsetY=offset.y;this.appliedShadow=true;return true;}
return false;},intersects:function(){var pos=Kinetic.Type._getXY(Array.prototype.slice.call(arguments));var stage=this.getStage();if(this.attrs.detectionType==='path'){var pathCanvas=stage.pathCanvas;var pathCanvasContext=pathCanvas.getContext();this._draw(pathCanvas);return pathCanvasContext.isPointInPath(pos.x,pos.y);}
if(this.imageData){var w=stage.attrs.width;var alpha=this.imageData.data[((w*pos.y)+pos.x)*4+3];return(alpha);}
return false;},_draw:function(canvas){if(this.attrs.drawFunc){var stage=this.getStage();var context=canvas.getContext();var family=[];var parent=this.parent;family.unshift(this);while(parent){family.unshift(parent);parent=parent.parent;}
context.save();for(var n=0;n<family.length;n++){var node=family[n];var t=node.getTransform();var m=t.getMatrix();context.transform(m[0],m[1],m[2],m[3],m[4],m[5]);}
var absAlpha=this.getAbsoluteAlpha();if(absAlpha!==1){context.globalAlpha=absAlpha;}
this.applyLineJoin(context);this.appliedShadow=false;this.attrs.drawFunc.call(this,canvas.getContext());context.restore();}}});Kinetic.Node.addGettersSetters(Kinetic.Shape,['fill','stroke','lineJoin','strokeWidth','shadow','drawFunc','filter']);Kinetic.Rect=Kinetic.Shape.extend({init:function(config){this.setDefaultAttrs({width:0,height:0,cornerRadius:0});this.shapeType="Rect";config.drawFunc=this.drawFunc;this._super(config);},drawFunc:function(context){context.beginPath();if(this.attrs.cornerRadius===0){context.rect(0,0,this.attrs.width,this.attrs.height);}
else{context.moveTo(this.attrs.cornerRadius,0);context.lineTo(this.attrs.width-this.attrs.cornerRadius,0);context.arc(this.attrs.width-this.attrs.cornerRadius,this.attrs.cornerRadius,this.attrs.cornerRadius,Math.PI*3/2,0,false);context.lineTo(this.attrs.width,this.attrs.height-this.attrs.cornerRadius);context.arc(this.attrs.width-this.attrs.cornerRadius,this.attrs.height-this.attrs.cornerRadius,this.attrs.cornerRadius,0,Math.PI/2,false);context.lineTo(this.attrs.cornerRadius,this.attrs.height);context.arc(this.attrs.cornerRadius,this.attrs.height-this.attrs.cornerRadius,this.attrs.cornerRadius,Math.PI/2,Math.PI,false);context.lineTo(0,this.attrs.cornerRadius);context.arc(this.attrs.cornerRadius,this.attrs.cornerRadius,this.attrs.cornerRadius,Math.PI,Math.PI*3/2,false);}
context.closePath();this.fill(context);this.stroke(context);},setSize:function(){var size=Kinetic.Type._getSize(Array.prototype.slice.call(arguments));this.setAttrs(size);},getSize:function(){return{width:this.attrs.width,height:this.attrs.height};}});Kinetic.Node.addGettersSetters(Kinetic.Rect,['width','height','cornerRadius']);Kinetic.Ellipse=Kinetic.Shape.extend({init:function(config){this.setDefaultAttrs({radius:{x:0,y:0}});this.shapeType="Ellipse";config.drawFunc=this.drawFunc;this._super(config);this._convertRadius();var that=this;this.on('radiusChange.kinetic',function(){that._convertRadius();});},drawFunc:function(context){var r=this.getRadius();context.beginPath();context.save();if(r.x!==r.y){context.scale(1,r.y/r.x);}
context.arc(0,0,r.x,0,Math.PI*2,true);context.restore();context.closePath();this.fill(context);this.stroke(context);},_convertRadius:function(){var type=Kinetic.Type;var radius=this.getRadius();if(type._isObject(radius)){return false;}
this.attrs.radius=type._getXY(radius);}});Kinetic.Circle=Kinetic.Ellipse;Kinetic.Node.addGettersSetters(Kinetic.Ellipse,['radius']);Kinetic.Image=Kinetic.Shape.extend({init:function(config){this.shapeType="Image";config.drawFunc=this.drawFunc;this._super(config);},drawFunc:function(context){if(this.attrs.image){var width=this.getWidth();var height=this.getHeight();context.beginPath();context.rect(0,0,width,height);context.closePath();this.fill(context);this.stroke(context);if(this.attrs.crop&&this.attrs.crop.width&&this.attrs.crop.height){var cropX=this.attrs.crop.x?this.attrs.crop.x:0;var cropY=this.attrs.crop.y?this.attrs.crop.y:0;var cropWidth=this.attrs.crop.width;var cropHeight=this.attrs.crop.height;this.drawImage(context,this.attrs.image,cropX,cropY,cropWidth,cropHeight,0,0,width,height);}
else{this.drawImage(context,this.attrs.image,0,0,width,height);}}},setSize:function(){var size=Kinetic.Type._getSize(Array.prototype.slice.call(arguments));this.setAttrs(size);},getSize:function(){return{width:this.attrs.width,height:this.attrs.height};},getWidth:function(){if(this.attrs.width){return this.attrs.width;}
if(this.attrs.image){return this.attrs.image.width;}
return 0;},getHeight:function(){if(this.attrs.height){return this.attrs.height;}
if(this.attrs.image){return this.attrs.image.height;}
return 0;},applyFilter:function(config){try{var trans=this._clearTransform();this.saveImageData(this.getWidth(),this.getHeight());this._setTransform(trans);config.filter.call(this,config);var that=this;Kinetic.Type._getImage(this.getImageData(),function(imageObj){that.setImage(imageObj);if(config.callback){config.callback();}});}
catch(e){Kinetic.Global.warn('Unable to apply filter.');}}});Kinetic.Node.addGettersSetters(Kinetic.Image,['image','crop','filter']);Kinetic.Node.addSetters(Kinetic.Image,['width','height']);Kinetic.Polygon=Kinetic.Shape.extend({init:function(config){this.setDefaultAttrs({points:[]});this.shapeType="Polygon";config.drawFunc=this.drawFunc;this._super(config);},drawFunc:function(context){context.beginPath();context.moveTo(this.attrs.points[0].x,this.attrs.points[0].y);for(var n=1;n<this.attrs.points.length;n++){context.lineTo(this.attrs.points[n].x,this.attrs.points[n].y);}
context.closePath();this.fill(context);this.stroke(context);}});Kinetic.Node.addGettersSetters(Kinetic.Polygon,['points']);Kinetic.Text=Kinetic.Shape.extend({init:function(config){this.setDefaultAttrs({fontFamily:'Calibri',text:'',fontSize:12,align:'left',verticalAlign:'top',fontStyle:'normal',padding:0,width:'auto',height:'auto',detectionType:'path',cornerRadius:0,lineHeight:1.2});this.dummyCanvas=document.createElement('canvas');this.shapeType="Text";config.drawFunc=this.drawFunc;this._super(config);var attrs=['fontFamily','fontSize','fontStyle','padding','align','lineHeight','text','width','height'];var that=this;for(var n=0;n<attrs.length;n++){var attr=attrs[n];this.on(attr+'Change.kinetic',that._setTextData);}
that._setTextData();},drawFunc:function(context){context.beginPath();var boxWidth=this.getBoxWidth();var boxHeight=this.getBoxHeight();if(this.attrs.cornerRadius===0){context.rect(0,0,boxWidth,boxHeight);}
else{context.moveTo(this.attrs.cornerRadius,0);context.lineTo(boxWidth-this.attrs.cornerRadius,0);context.arc(boxWidth-this.attrs.cornerRadius,this.attrs.cornerRadius,this.attrs.cornerRadius,Math.PI*3/2,0,false);context.lineTo(boxWidth,boxHeight-this.attrs.cornerRadius);context.arc(boxWidth-this.attrs.cornerRadius,boxHeight-this.attrs.cornerRadius,this.attrs.cornerRadius,0,Math.PI/2,false);context.lineTo(this.attrs.cornerRadius,boxHeight);context.arc(this.attrs.cornerRadius,boxHeight-this.attrs.cornerRadius,this.attrs.cornerRadius,Math.PI/2,Math.PI,false);context.lineTo(0,this.attrs.cornerRadius);context.arc(this.attrs.cornerRadius,this.attrs.cornerRadius,this.attrs.cornerRadius,Math.PI,Math.PI*3/2,false);}
context.closePath();this.fill(context);this.stroke(context);var p=this.attrs.padding;var lineHeightPx=this.attrs.lineHeight*this.getTextHeight();var textArr=this.textArr;context.font=this.attrs.fontStyle+' '+this.attrs.fontSize+'pt '+this.attrs.fontFamily;context.textBaseline='middle';context.textAlign='left';context.save();context.translate(p,0);context.translate(0,p+this.getTextHeight()/2);for(var n=0;n<textArr.length;n++){var text=textArr[n];context.save();if(this.attrs.align==='right'){context.translate(this.getBoxWidth()-this._getTextSize(text).width-p*2,0);}
else if(this.attrs.align==='center'){context.translate((this.getBoxWidth()-this._getTextSize(text).width-p*2)/2,0);}
this.fillText(context,text);this.strokeText(context,text);context.restore();context.translate(0,lineHeightPx);}
context.restore();},getBoxWidth:function(){return this.attrs.width==='auto'?this.getTextWidth()+this.attrs.padding*2:this.attrs.width;},getBoxHeight:function(){return this.attrs.height==='auto'?(this.getTextHeight()*this.textArr.length*this.attrs.lineHeight)+this.attrs.padding*2:this.attrs.height;},getTextWidth:function(){return this.textWidth;},getTextHeight:function(){return this.textHeight;},_getTextSize:function(text){var dummyCanvas=this.dummyCanvas;var context=dummyCanvas.getContext('2d');context.save();context.font=this.attrs.fontStyle+' '+this.attrs.fontSize+'pt '+this.attrs.fontFamily;var metrics=context.measureText(text);context.restore();return{width:metrics.width,height:parseInt(this.attrs.fontSize,10)};},_setTextData:function(){var charArr=this.attrs.text.split('');var arr=[];var row=0;var addLine=true;this.textWidth=0;this.textHeight=this._getTextSize(this.attrs.text).height;var lineHeightPx=this.attrs.lineHeight*this.textHeight;while(charArr.length>0&&addLine&&(this.attrs.height==='auto'||lineHeightPx*(row+1)<this.attrs.height-this.attrs.padding*2)){var index=0;var line=undefined;addLine=false;while(index<charArr.length){if(charArr.indexOf('\n')===index){charArr.splice(index,1);line=charArr.splice(0,index).join('');break;}
var lineArr=charArr.slice(0,index);if(this.attrs.width!=='auto'&&this._getTextSize(lineArr.join('')).width>this.attrs.width-this.attrs.padding*2){if(index==0){break;}
var lastSpace=lineArr.lastIndexOf(' ');var lastDash=lineArr.lastIndexOf('-');var wrapIndex=Math.max(lastSpace,lastDash);if(wrapIndex>=0){line=charArr.splice(0,1+wrapIndex).join('');break;}
line=charArr.splice(0,index).join('');break;}
index++;if(index===charArr.length){line=charArr.splice(0,index).join('');}}
this.textWidth=Math.max(this.textWidth,this._getTextSize(line).width);if(line!==undefined){arr.push(line);addLine=true;}
row++;}
this.textArr=arr;}});Kinetic.Node.addGettersSetters(Kinetic.Text,['fontFamily','fontSize','fontStyle','textFill','textStroke','textStrokeWidth','padding','align','lineHeight','text','width','height','cornerRadius','fill','stroke','strokeWidth','shadow']);Kinetic.Line=Kinetic.Shape.extend({init:function(config){this.setDefaultAttrs({points:[],lineCap:'butt',dashArray:[],detectionType:'pixel'});this.shapeType="Line";config.drawFunc=this.drawFunc;this._super(config);},drawFunc:function(context){var lastPos={};context.beginPath();context.moveTo(this.attrs.points[0].x,this.attrs.points[0].y);for(var n=1;n<this.attrs.points.length;n++){var x=this.attrs.points[n].x;var y=this.attrs.points[n].y;if(this.attrs.dashArray.length>0){var lastX=this.attrs.points[n-1].x;var lastY=this.attrs.points[n-1].y;this._dashedLine(context,lastX,lastY,x,y,this.attrs.dashArray);}
else{context.lineTo(x,y);}}
if(!!this.attrs.lineCap){context.lineCap=this.attrs.lineCap;}
this.stroke(context);},_dashedLine:function(context,x,y,x2,y2,dashArray){var dashCount=dashArray.length;var dx=(x2-x),dy=(y2-y);var xSlope=dx>dy;var slope=(xSlope)?dy/dx:dx/dy;if(slope>9999){slope=9999;}
else if(slope<-9999){slope=-9999;}
var distRemaining=Math.sqrt(dx*dx+dy*dy);var dashIndex=0,draw=true;while(distRemaining>=0.1&&dashIndex<10000){var dashLength=dashArray[dashIndex++%dashCount];if(dashLength===0){dashLength=0.001;}
if(dashLength>distRemaining){dashLength=distRemaining;}
var step=Math.sqrt(dashLength*dashLength/(1+slope*slope));if(xSlope){x+=dx<0&&dy<0?step*-1:step;y+=dx<0&&dy<0?slope*step*-1:slope*step;}
else{x+=dx<0&&dy<0?slope*step*-1:slope*step;y+=dx<0&&dy<0?step*-1:step;}
context[draw?'lineTo':'moveTo'](x,y);distRemaining-=dashLength;draw=!draw;}
context.moveTo(x2,y2);}});Kinetic.Node.addGettersSetters(Kinetic.Line,['dashArray','lineCap','points']);Kinetic.Sprite=Kinetic.Shape.extend({init:function(config){this.setDefaultAttrs({index:0,frameRate:17});config.drawFunc=this.drawFunc;this._super(config);this.anim=new Kinetic.Animation();var that=this;this.on('animationChange.kinetic',function(){that.setIndex(0);});},drawFunc:function(context){if(this.attrs.image){var anim=this.attrs.animation;var index=this.attrs.index;var f=this.attrs.animations[anim][index];context.beginPath();context.rect(0,0,f.width,f.height);context.closePath();this.drawImage(context,this.attrs.image,f.x,f.y,f.width,f.height,0,0,f.width,f.height);}},start:function(){var that=this;var layer=this.getLayer();var ka=Kinetic.Animation;ka._removeAnimation(this.anim);this.anim.node=layer;ka._addAnimation(this.anim);this.interval=setInterval(function(){var index=that.attrs.index;that._updateIndex();if(that.afterFrameFunc&&index===that.afterFrameIndex){that.afterFrameFunc();}},1000/this.attrs.frameRate);ka._handleAnimation();},stop:function(){Kinetic.Animation._removeAnimation(this.anim);clearInterval(this.interval);},afterFrame:function(index,func){this.afterFrameIndex=index;this.afterFrameFunc=func;},_updateIndex:function(){var i=this.attrs.index;var a=this.attrs.animation;if(i<this.attrs.animations[a].length-1){this.attrs.index++;}
else{this.attrs.index=0;}}});Kinetic.Node.addGettersSetters(Kinetic.Sprite,['animation','animations','index']);Kinetic.Star=Kinetic.Shape.extend({init:function(config){this.setDefaultAttrs({numPoints:0,innerRadius:0,outerRadius:0});this.shapeType="Star";config.drawFunc=this.drawFunc;this._super(config);},drawFunc:function(context){context.beginPath();context.moveTo(0,0-this.attrs.outerRadius);for(var n=1;n<this.attrs.numPoints*2;n++){var radius=n%2===0?this.attrs.outerRadius:this.attrs.innerRadius;var x=radius*Math.sin(n*Math.PI/this.attrs.numPoints);var y=-1*radius*Math.cos(n*Math.PI/this.attrs.numPoints);context.lineTo(x,y);}
context.closePath();this.fill(context);this.stroke(context);}});Kinetic.Node.addGettersSetters(Kinetic.Star,['numPoints','innerRadius','outerRadius']);Kinetic.RegularPolygon=Kinetic.Shape.extend({init:function(config){this.setDefaultAttrs({radius:0,sides:0});this.shapeType="RegularPolygon";config.drawFunc=this.drawFunc;this._super(config);},drawFunc:function(context){context.beginPath();context.moveTo(0,0-this.attrs.radius);for(var n=1;n<this.attrs.sides;n++){var x=this.attrs.radius*Math.sin(n*2*Math.PI/this.attrs.sides);var y=-1*this.attrs.radius*Math.cos(n*2*Math.PI/this.attrs.sides);context.lineTo(x,y);}
context.closePath();this.fill(context);this.stroke(context);}});Kinetic.Node.addGettersSetters(Kinetic.RegularPolygon,['radius','sides']);Kinetic.Path=Kinetic.Shape.extend({init:function(config){this.shapeType="Path";this.dataArray=[];var that=this;config.drawFunc=this.drawFunc;this._super(config);this.dataArray=Kinetic.Path.parsePathData(this.attrs.data);this.on('dataChange',function(){that.dataArray=Kinetic.Path.parsePathData(that.attrs.data);});},drawFunc:function(context){var ca=this.dataArray;context.beginPath();for(var n=0;n<ca.length;n++){var c=ca[n].command;var p=ca[n].points;switch(c){case'L':context.lineTo(p[0],p[1]);break;case'M':context.moveTo(p[0],p[1]);break;case'C':context.bezierCurveTo(p[0],p[1],p[2],p[3],p[4],p[5]);break;case'Q':context.quadraticCurveTo(p[0],p[1],p[2],p[3]);break;case'A':var cx=p[0],cy=p[1],rx=p[2],ry=p[3],theta=p[4],dTheta=p[5],psi=p[6],fs=p[7];var r=(rx>ry)?rx:ry;var scaleX=(rx>ry)?1:rx/ry;var scaleY=(rx>ry)?ry/rx:1;context.translate(cx,cy);context.rotate(psi);context.scale(scaleX,scaleY);context.arc(0,0,r,theta,theta+dTheta,1-fs);context.scale(1/scaleX,1/scaleY);context.rotate(-psi);context.translate(-cx,-cy);break;case'z':context.closePath();break;}}
this.fill(context);this.stroke(context);}});Kinetic.Path.getLineLength=function(x1,y1,x2,y2){return Math.sqrt((x2-x1)*(x2-x1)+(y2-y1)*(y2-y1));};Kinetic.Path.getPointOnLine=function(dist,P1x,P1y,P2x,P2y,fromX,fromY){if(fromX===undefined){fromX=P1x;}
if(fromY===undefined){fromY=P1y;}
var m=(P2y-P1y)/((P2x-P1x)+0.00000001);var run=Math.sqrt(dist*dist/(1+m*m));var rise=m*run;var pt;if((fromY-P1y)/((fromX-P1x)+0.00000001)===m){pt={x:fromX+run,y:fromY+rise};}
else{var ix,iy;var len=this.getLineLength(P1x,P1y,P2x,P2y);if(len<0.00000001){return undefined;}
var u=(((fromX-P1x)*(P2x-P1x))+((fromY-P1y)*(P2y-P1y)));u=u/(len*len);ix=P1x+u*(P2x-P1x);iy=P1y+u*(P2y-P1y);var pRise=this.getLineLength(fromX,fromY,ix,iy);var pRun=Math.sqrt(dist*dist-pRise*pRise);run=Math.sqrt(pRun*pRun/(1+m*m));rise=m*run;pt={x:ix+run,y:iy+rise};}
return pt;};Kinetic.Path.getPointOnCubicBezier=function(pct,P1x,P1y,P2x,P2y,P3x,P3y,P4x,P4y){function CB1(t){return t*t*t;}
function CB2(t){return 3*t*t*(1-t);}
function CB3(t){return 3*t*(1-t)*(1-t);}
function CB4(t){return(1-t)*(1-t)*(1-t);}
var x=P4x*CB1(pct)+P3x*CB2(pct)+P2x*CB3(pct)+P1x*CB4(pct);var y=P4y*CB1(pct)+P3y*CB2(pct)+P2y*CB3(pct)+P1y*CB4(pct);return{x:x,y:y};};Kinetic.Path.getPointOnQuadraticBezier=function(pct,P1x,P1y,P2x,P2y,P3x,P3y){function QB1(t){return t*t;}
function QB2(t){return 2*t*(1-t);}
function QB3(t){return(1-t)*(1-t);}
var x=P3x*QB1(pct)+P2x*QB2(pct)+P1x*QB3(pct);var y=P3y*QB1(pct)+P2y*QB2(pct)+P1y*QB3(pct);return{x:x,y:y};};Kinetic.Path.getPointOnEllipticalArc=function(cx,cy,rx,ry,theta,psi){var cosPsi=Math.cos(psi),sinPsi=Math.sin(psi);var pt={x:rx*Math.cos(theta),y:ry*Math.sin(theta)};return{x:cx+(pt.x*cosPsi-pt.y*sinPsi),y:cy+(pt.x*sinPsi+pt.y*cosPsi)};};Kinetic.Path.parsePathData=function(data){if(!data){return[];}
var cs=data;var cc=['m','M','l','L','v','V','h','H','z','Z','c','C','q','Q','t','T','s','S','a','A'];cs=cs.replace(new RegExp(' ','g'),',');for(var n=0;n<cc.length;n++){cs=cs.replace(new RegExp(cc[n],'g'),'|'+cc[n]);}
var arr=cs.split('|');var ca=[];var cpx=0;var cpy=0;for(var n=1;n<arr.length;n++){var str=arr[n];var c=str.charAt(0);str=str.slice(1);str=str.replace(new RegExp(',-','g'),'-');str=str.replace(new RegExp('-','g'),',-');str=str.replace(new RegExp('e,-','g'),'e-');var p=str.split(',');if(p.length>0&&p[0]===''){p.shift();}
for(var i=0;i<p.length;i++){p[i]=parseFloat(p[i]);}
while(p.length>0){if(isNaN(p[0]))
break;var cmd=null;var points=[];var startX=cpx,startY=cpy;switch(c){case'l':cpx+=p.shift();cpy+=p.shift();cmd='L';points.push(cpx,cpy);break;case'L':cpx=p.shift();cpy=p.shift();points.push(cpx,cpy);break;case'm':cpx+=p.shift();cpy+=p.shift();cmd='M';points.push(cpx,cpy);c='l';break;case'M':cpx=p.shift();cpy=p.shift();cmd='M';points.push(cpx,cpy);c='L';break;case'h':cpx+=p.shift();cmd='L';points.push(cpx,cpy);break;case'H':cpx=p.shift();cmd='L';points.push(cpx,cpy);break;case'v':cpy+=p.shift();cmd='L';points.push(cpx,cpy);break;case'V':cpy=p.shift();cmd='L';points.push(cpx,cpy);break;case'C':points.push(p.shift(),p.shift(),p.shift(),p.shift());cpx=p.shift();cpy=p.shift();points.push(cpx,cpy);break;case'c':points.push(cpx+p.shift(),cpy+p.shift(),cpx+p.shift(),cpy+p.shift());cpx+=p.shift();cpy+=p.shift();cmd='C';points.push(cpx,cpy);break;case'S':var ctlPtx=cpx,ctlPty=cpy;var prevCmd=ca[ca.length-1];if(prevCmd.command==='C'){ctlPtx=cpx+(cpx-prevCmd.points[2]);ctlPty=cpy+(cpy-prevCmd.points[3]);}
points.push(ctlPtx,ctlPty,p.shift(),p.shift());cpx=p.shift();cpy=p.shift();cmd='C';points.push(cpx,cpy);break;case's':var ctlPtx=cpx,ctlPty=cpy;var prevCmd=ca[ca.length-1];if(prevCmd.command==='C'){ctlPtx=cpx+(cpx-prevCmd.points[2]);ctlPty=cpy+(cpy-prevCmd.points[3]);}
points.push(ctlPtx,ctlPty,cpx+p.shift(),cpy+p.shift());cpx+=p.shift();cpy+=p.shift();cmd='C';points.push(cpx,cpy);break;case'Q':points.push(p.shift(),p.shift());cpx=p.shift();cpy=p.shift();points.push(cpx,cpy);break;case'q':points.push(cpx+p.shift(),cpy+p.shift());cpx+=p.shift();cpy+=p.shift();cmd='Q';points.push(cpx,cpy);break;case'T':var ctlPtx=cpx,ctlPty=cpy;var prevCmd=ca[ca.length-1];if(prevCmd.command==='Q'){ctlPtx=cpx+(cpx-prevCmd.points[0]);ctlPty=cpy+(cpy-prevCmd.points[1]);}
cpx=p.shift();cpy=p.shift();cmd='Q';points.push(ctlPtx,ctlPty,cpx,cpy);break;case't':var ctlPtx=cpx,ctlPty=cpy;var prevCmd=ca[ca.length-1];if(prevCmd.command==='Q'){ctlPtx=cpx+(cpx-prevCmd.points[0]);ctlPty=cpy+(cpy-prevCmd.points[1]);}
cpx+=p.shift();cpy+=p.shift();cmd='Q';points.push(ctlPtx,ctlPty,cpx,cpy);break;case'A':var rx=p.shift(),ry=p.shift(),psi=p.shift(),fa=p.shift(),fs=p.shift();var x1=cpx,y1=cpy;cpx=p.shift(),cpy=p.shift();cmd='A';points=this.convertEndpointToCenterParameterization(x1,y1,cpx,cpy,fa,fs,rx,ry,psi);break;case'a':var rx=p.shift(),ry=p.shift(),psi=p.shift(),fa=p.shift(),fs=p.shift();var x1=cpx,y1=cpy;cpx+=p.shift(),cpy+=p.shift();cmd='A';points=this.convertEndpointToCenterParameterization(x1,y1,cpx,cpy,fa,fs,rx,ry,psi);break;}
ca.push({command:cmd||c,points:points,start:{x:startX,y:startY},pathLength:this.calcLength(startX,startY,cmd||c,points)});}
if(c==='z'||c==='Z'){ca.push({command:'z',points:[],start:undefined,pathLength:0});}}
return ca;};Kinetic.Path.calcLength=function(x,y,cmd,points){var len,p1,p2;var path=Kinetic.Path;switch(cmd){case'L':return path.getLineLength(x,y,points[0],points[1]);case'C':len=0.0;p1=path.getPointOnCubicBezier(0,x,y,points[0],points[1],points[2],points[3],points[4],points[5]);for(t=0.01;t<=1;t+=0.01){p2=path.getPointOnCubicBezier(t,x,y,points[0],points[1],points[2],points[3],points[4],points[5]);len+=path.getLineLength(p1.x,p1.y,p2.x,p2.y);p1=p2;}
return len;case'Q':len=0.0;p1=path.getPointOnQuadraticBezier(0,x,y,points[0],points[1],points[2],points[3]);for(t=0.01;t<=1;t+=0.01){p2=path.getPointOnQuadraticBezier(t,x,y,points[0],points[1],points[2],points[3]);len+=path.getLineLength(p1.x,p1.y,p2.x,p2.y);p1=p2;}
return len;case'A':len=0.0;var start=points[4];var dTheta=points[5];var end=points[4]+dTheta;var inc=Math.PI/180.0;if(Math.abs(start-end)<inc){inc=Math.abs(start-end);}
p1=path.getPointOnEllipticalArc(points[0],points[1],points[2],points[3],start,0);if(dTheta<0){for(t=start-inc;t>end;t-=inc){p2=path.getPointOnEllipticalArc(points[0],points[1],points[2],points[3],t,0);len+=path.getLineLength(p1.x,p1.y,p2.x,p2.y);p1=p2;}}
else{for(t=start+inc;t<end;t+=inc){p2=path.getPointOnEllipticalArc(points[0],points[1],points[2],points[3],t,0);len+=path.getLineLength(p1.x,p1.y,p2.x,p2.y);p1=p2;}}
p2=path.getPointOnEllipticalArc(points[0],points[1],points[2],points[3],end,0);len+=path.getLineLength(p1.x,p1.y,p2.x,p2.y);return len;}
return 0;};Kinetic.Path.convertEndpointToCenterParameterization=function(x1,y1,x2,y2,fa,fs,rx,ry,psiDeg){var psi=psiDeg*(Math.PI/180.0);var xp=Math.cos(psi)*(x1-x2)/2.0+Math.sin(psi)*(y1-y2)/2.0;var yp=-1*Math.sin(psi)*(x1-x2)/2.0+Math.cos(psi)*(y1-y2)/2.0;var lambda=(xp*xp)/(rx*rx)+(yp*yp)/(ry*ry);if(lambda>1){rx*=Math.sqrt(lambda);ry*=Math.sqrt(lambda);}
var f=Math.sqrt((((rx*rx)*(ry*ry))-((rx*rx)*(yp*yp))-((ry*ry)*(xp*xp)))/((rx*rx)*(yp*yp)+(ry*ry)*(xp*xp)));if(fa==fs){f*=-1;}
if(isNaN(f)){f=0;}
var cxp=f*rx*yp/ry;var cyp=f*-ry*xp/rx;var cx=(x1+x2)/2.0+Math.cos(psi)*cxp-Math.sin(psi)*cyp;var cy=(y1+y2)/2.0+Math.sin(psi)*cxp+Math.cos(psi)*cyp;var vMag=function(v){return Math.sqrt(v[0]*v[0]+v[1]*v[1]);};var vRatio=function(u,v){return(u[0]*v[0]+u[1]*v[1])/(vMag(u)*vMag(v));};var vAngle=function(u,v){return(u[0]*v[1]<u[1]*v[0]?-1:1)*Math.acos(vRatio(u,v));};var theta=vAngle([1,0],[(xp-cxp)/rx,(yp-cyp)/ry]);var u=[(xp-cxp)/rx,(yp-cyp)/ry];var v=[(-1*xp-cxp)/rx,(-1*yp-cyp)/ry];var dTheta=vAngle(u,v);if(vRatio(u,v)<=-1){dTheta=Math.PI;}
if(vRatio(u,v)>=1){dTheta=0;}
if(fs===0&&dTheta>0){dTheta=dTheta-2*Math.PI;}
if(fs==1&&dTheta<0){dTheta=dTheta+2*Math.PI;}
return[cx,cy,rx,ry,theta,dTheta,psi,fs];};Kinetic.Node.addGettersSetters(Kinetic.Path,['data']);Kinetic.TextPath=Kinetic.Shape.extend({init:function(config){this.setDefaultAttrs({fontFamily:'Calibri',fontSize:12,fontStyle:'normal',detectionType:'path',text:''});this.dummyCanvas=document.createElement('canvas');this.shapeType="TextPath";this.dataArray=[];var that=this;config.drawFunc=this.drawFunc;this._super(config);this.dataArray=Kinetic.Path.parsePathData(this.attrs.data);this.on('dataChange',function(){that.dataArray=Kinetic.Path.parsePathData(this.attrs.data);});var attrs=['text','textStroke','textStrokeWidth'];for(var n=0;n<attrs.length;n++){var attr=attrs[n];this.on(attr+'Change',that._setTextData);}
that._setTextData();},drawFunc:function(context){var charArr=this.charArr;context.font=this.attrs.fontStyle+' '+this.attrs.fontSize+'pt '+this.attrs.fontFamily;context.textBaseline='middle';context.textAlign='left';context.save();var glyphInfo=this.glyphInfo;for(var i=0;i<glyphInfo.length;i++){context.save();var p0=glyphInfo[i].p0;var p1=glyphInfo[i].p1;var ht=parseFloat(this.attrs.fontSize);context.translate(p0.x,p0.y);context.rotate(glyphInfo[i].rotation);this.fillText(context,glyphInfo[i].text);this.strokeText(context,glyphInfo[i].text);context.restore();}
context.restore();},getTextWidth:function(){return this.textWidth;},getTextHeight:function(){return this.textHeight;},_getTextSize:function(text){var dummyCanvas=this.dummyCanvas;var context=dummyCanvas.getContext('2d');context.save();context.font=this.attrs.fontStyle+' '+this.attrs.fontSize+'pt '+this.attrs.fontFamily;var metrics=context.measureText(text);context.restore();return{width:metrics.width,height:parseInt(this.attrs.fontSize,10)};},_setTextData:function(){var that=this;var size=this._getTextSize(this.attrs.text);this.textWidth=size.width;this.textHeight=size.height;this.glyphInfo=[];var charArr=this.attrs.text.split('');var p0,p1,pathCmd;var pIndex=-1;var currentT=0;var getNextPathSegment=function(){currentT=0;var pathData=that.dataArray;for(var i=pIndex+1;i<pathData.length;i++){if(pathData[i].pathLength>0){pIndex=i;return pathData[i];}
else if(pathData[i].command=='M'){p0={x:pathData[i].points[0],y:pathData[i].points[1]};}}
return{};};var findSegmentToFitCharacter=function(c,before){var glyphWidth=that._getTextSize(c).width;var currLen=0;var attempts=0;var needNextSegment=false;p1=undefined;while(Math.abs(glyphWidth-currLen)/glyphWidth>0.01&&attempts<25){attempts++;var cumulativePathLength=currLen;while(pathCmd===undefined){pathCmd=getNextPathSegment();if(pathCmd&&cumulativePathLength+pathCmd.pathLength<glyphWidth){cumulativePathLength+=pathCmd.pathLength;pathCmd=undefined;}}
if(pathCmd==={}||p0===undefined)
return undefined;var needNewSegment=false;switch(pathCmd.command){case'L':if(Kinetic.Path.getLineLength(p0.x,p0.y,pathCmd.points[0],pathCmd.points[1])>glyphWidth){p1=Kinetic.Path.getPointOnLine(glyphWidth,p0.x,p0.y,pathCmd.points[0],pathCmd.points[1],p0.x,p0.y);}
else
pathCmd=undefined;break;case'A':var start=pathCmd.points[4];var dTheta=pathCmd.points[5];var end=pathCmd.points[4]+dTheta;if(currentT===0)
currentT=start+0.00000001;else if(glyphWidth>currLen)
currentT+=(Math.PI/180.0)*dTheta/Math.abs(dTheta);else
currentT-=Math.PI/360.0*dTheta/Math.abs(dTheta);if(Math.abs(currentT)>Math.abs(end)){currentT=end;needNewSegment=true;}
p1=Kinetic.Path.getPointOnEllipticalArc(pathCmd.points[0],pathCmd.points[1],pathCmd.points[2],pathCmd.points[3],currentT,pathCmd.points[6]);break;case'C':if(currentT===0){if(glyphWidth>pathCmd.pathLength)
currentT=0.00000001;else
currentT=glyphWidth/pathCmd.pathLength;}
else if(glyphWidth>currLen)
currentT+=(glyphWidth-currLen)/pathCmd.pathLength;else
currentT-=(currLen-glyphWidth)/pathCmd.pathLength;if(currentT>1.0){currentT=1.0;needNewSegment=true;}
p1=Kinetic.Path.getPointOnCubicBezier(currentT,pathCmd.start.x,pathCmd.start.y,pathCmd.points[0],pathCmd.points[1],pathCmd.points[2],pathCmd.points[3],pathCmd.points[4],pathCmd.points[5]);break;case'Q':if(currentT===0)
currentT=glyphWidth/pathCmd.pathLength;else if(glyphWidth>currLen)
currentT+=(glyphWidth-currLen)/pathCmd.pathLength;else
currentT-=(currLen-glyphWidth)/pathCmd.pathLength;if(currentT>1.0){currentT=1.0;needNewSegment=true;}
p1=Kinetic.Path.getPointOnQuadraticBezier(currentT,pathCmd.start.x,pathCmd.start.y,pathCmd.points[0],pathCmd.points[1],pathCmd.points[2],pathCmd.points[3]);break;}
if(p1!==undefined){currLen=Kinetic.Path.getLineLength(p0.x,p0.y,p1.x,p1.y);}
if(needNewSegment){needNewSegment=false;pathCmd=undefined;}}};for(var i=0;i<charArr.length;i++){findSegmentToFitCharacter(charArr[i]);if(p0===undefined||p1===undefined)
break;var width=Kinetic.Path.getLineLength(p0.x,p0.y,p1.x,p1.y);var kern=0;var midpoint=Kinetic.Path.getPointOnLine(kern+width/2.0,p0.x,p0.y,p1.x,p1.y);var rotation=Math.atan2((p1.y-p0.y),(p1.x-p0.x));this.glyphInfo.push({transposeX:midpoint.x,transposeY:midpoint.y,text:charArr[i],rotation:rotation,p0:p0,p1:p1});p0=p1;}}});Kinetic.Node.addGettersSetters(Kinetic.TextPath,['fontFamily','fontSize','fontStyle','textFill','textStroke','textStrokeWidth','text']);const SQRT_3=Math.sqrt(3);const SQRT_5=Math.sqrt(5);const SQRT_8=Math.sqrt(8);const SQRT_10=Math.sqrt(10);const SQRT_15=Math.sqrt(15);var v_x=new Array(13);var v_y=new Array(13);var v_z=new Array(13);var center_x=new Array(21);var center_y=new Array(21);var center_z=new Array(21);var garc,gt,gdve,gel;var last_lng=100000;var last_lat=100000;var last_point;function convert_s_t_p_cache(lng,lat){if(last_lng==lng&&last_lat==lat){return last_point;}else{last_lng=lng;last_lat=lat;last_point=convert_s_t_p(lng,lat);return last_point;}}
function convert_s_t_p(lng,lat){var sc=conv_ll_t_sc(lng,lat);var h=s_to_c(sc.theta,sc.phi);var info=s_tri_info(h.x,h.y,h.z);return dymax_point(info.tri,info.hlcd,h.x,h.y,h.z);}
function convert_i_t_p(i,t){var x=0;var y=0;var z=0;for(var j=0;j<3;j++){if(t[j]==i){x+=v_x[i]*0.9999;y+=v_y[i]*0.9999;z+=v_z[i]*0.9999;}else{x+=v_x[t[j]]*0.00005;y+=v_y[t[j]]*0.00005;z+=v_z[t[j]]*0.00005;}}
var info=s_tri_info(x,y,z);return dymax_point(info.tri,info.hlcd,x,y,z);}
function conv_ll_t_sc(lng,lat){var sc=new Object();var h_theta,h_phi;h_theta=90.0-lat;h_phi=lng;if(lng<0.0){h_phi=lng+360.0;}
sc.theta=radians(h_theta);sc.phi=radians(h_phi);return sc;}
function radians(degrees){return(Math.PI*degrees/180);}
function init_stuff(){var i,hold_x,hold_y,hold_z,magn;var theta,phi;v_x[1]=0.420152426708710003;v_y[1]=0.078145249402782959;v_z[1]=0.904082550615019298;v_x[2]=0.995009439436241649;v_y[2]=-0.091347795276427931;v_z[2]=0.040147175877166645;v_x[3]=0.518836730327364437;v_y[3]=0.835420380378235850;v_z[3]=0.181331837557262454;v_x[4]=-0.414682225320335218;v_y[4]=0.655962405434800777;v_z[4]=0.630675807891475371;v_x[5]=-0.515455959944041808;v_y[5]=-0.381716898287133011;v_z[5]=0.767200992517747538;v_x[6]=0.355781402532944713;v_y[6]=-0.843580002466178147;v_z[6]=0.402234226602925571;v_x[7]=0.414682225320335218;v_y[7]=-0.655962405434800777;v_z[7]=-0.630675807891475371;v_x[8]=0.515455959944041808;v_y[8]=0.381716898287133011;v_z[8]=-0.767200992517747538;v_x[9]=-0.355781402532944713;v_y[9]=0.843580002466178147;v_z[9]=-0.402234226602925571;v_x[10]=-0.995009439436241649;v_y[10]=0.091347795276427931;v_z[10]=-0.040147175877166645;v_x[11]=-0.518836730327364437;v_y[11]=-0.835420380378235850;v_z[11]=-0.181331837557262454;v_x[12]=-0.420152426708710003;v_y[12]=-0.078145249402782959;v_z[12]=-0.904082550615019298;hold_x=(v_x[1]+v_x[2]+v_x[3])/3.0;hold_y=(v_y[1]+v_y[2]+v_y[3])/3.0;hold_z=(v_z[1]+v_z[2]+v_z[3])/3.0;magn=Math.sqrt(hold_x*hold_x+hold_y*hold_y+hold_z*hold_z);center_x[1]=hold_x/magn;center_y[1]=hold_y/magn;center_z[1]=hold_z/magn;hold_x=(v_x[1]+v_x[3]+v_x[4])/3.0;hold_y=(v_y[1]+v_y[3]+v_y[4])/3.0;hold_z=(v_z[1]+v_z[3]+v_z[4])/3.0;magn=Math.sqrt(hold_x*hold_x+hold_y*hold_y+hold_z*hold_z);center_x[2]=hold_x/magn;center_y[2]=hold_y/magn;center_z[2]=hold_z/magn;hold_x=(v_x[1]+v_x[4]+v_x[5])/3.0;hold_y=(v_y[1]+v_y[4]+v_y[5])/3.0;hold_z=(v_z[1]+v_z[4]+v_z[5])/3.0;magn=Math.sqrt(hold_x*hold_x+hold_y*hold_y+hold_z*hold_z);center_x[3]=hold_x/magn;center_y[3]=hold_y/magn;center_z[3]=hold_z/magn;hold_x=(v_x[1]+v_x[5]+v_x[6])/3.0;hold_y=(v_y[1]+v_y[5]+v_y[6])/3.0;hold_z=(v_z[1]+v_z[5]+v_z[6])/3.0;magn=Math.sqrt(hold_x*hold_x+hold_y*hold_y+hold_z*hold_z);center_x[4]=hold_x/magn;center_y[4]=hold_y/magn;center_z[4]=hold_z/magn;hold_x=(v_x[1]+v_x[2]+v_x[6])/3.0;hold_y=(v_y[1]+v_y[2]+v_y[6])/3.0;hold_z=(v_z[1]+v_z[2]+v_z[6])/3.0;magn=Math.sqrt(hold_x*hold_x+hold_y*hold_y+hold_z*hold_z);center_x[5]=hold_x/magn;center_y[5]=hold_y/magn;center_z[5]=hold_z/magn;hold_x=(v_x[2]+v_x[3]+v_x[8])/3.0;hold_y=(v_y[2]+v_y[3]+v_y[8])/3.0;hold_z=(v_z[2]+v_z[3]+v_z[8])/3.0;magn=Math.sqrt(hold_x*hold_x+hold_y*hold_y+hold_z*hold_z);center_x[6]=hold_x/magn;center_y[6]=hold_y/magn;center_z[6]=hold_z/magn;hold_x=(v_x[8]+v_x[3]+v_x[9])/3.0;hold_y=(v_y[8]+v_y[3]+v_y[9])/3.0;hold_z=(v_z[8]+v_z[3]+v_z[9])/3.0;magn=Math.sqrt(hold_x*hold_x+hold_y*hold_y+hold_z*hold_z);center_x[7]=hold_x/magn;center_y[7]=hold_y/magn;center_z[7]=hold_z/magn;hold_x=(v_x[9]+v_x[3]+v_x[4])/3.0;hold_y=(v_y[9]+v_y[3]+v_y[4])/3.0;hold_z=(v_z[9]+v_z[3]+v_z[4])/3.0;magn=Math.sqrt(hold_x*hold_x+hold_y*hold_y+hold_z*hold_z);center_x[8]=hold_x/magn;center_y[8]=hold_y/magn;center_z[8]=hold_z/magn;hold_x=(v_x[10]+v_x[9]+v_x[4])/3.0;hold_y=(v_y[10]+v_y[9]+v_y[4])/3.0;hold_z=(v_z[10]+v_z[9]+v_z[4])/3.0;magn=Math.sqrt(hold_x*hold_x+hold_y*hold_y+hold_z*hold_z);center_x[9]=hold_x/magn;center_y[9]=hold_y/magn;center_z[9]=hold_z/magn;hold_x=(v_x[5]+v_x[10]+v_x[4])/3.0;hold_y=(v_y[5]+v_y[10]+v_y[4])/3.0;hold_z=(v_z[5]+v_z[10]+v_z[4])/3.0;magn=Math.sqrt(hold_x*hold_x+hold_y*hold_y+hold_z*hold_z);center_x[10]=hold_x/magn;center_y[10]=hold_y/magn;center_z[10]=hold_z/magn;hold_x=(v_x[5]+v_x[11]+v_x[10])/3.0;hold_y=(v_y[5]+v_y[11]+v_y[10])/3.0;hold_z=(v_z[5]+v_z[11]+v_z[10])/3.0;magn=Math.sqrt(hold_x*hold_x+hold_y*hold_y+hold_z*hold_z);center_x[11]=hold_x/magn;center_y[11]=hold_y/magn;center_z[11]=hold_z/magn;hold_x=(v_x[5]+v_x[6]+v_x[11])/3.0;hold_y=(v_y[5]+v_y[6]+v_y[11])/3.0;hold_z=(v_z[5]+v_z[6]+v_z[11])/3.0;magn=Math.sqrt(hold_x*hold_x+hold_y*hold_y+hold_z*hold_z);center_x[12]=hold_x/magn;center_y[12]=hold_y/magn;center_z[12]=hold_z/magn;hold_x=(v_x[11]+v_x[6]+v_x[7])/3.0;hold_y=(v_y[11]+v_y[6]+v_y[7])/3.0;hold_z=(v_z[11]+v_z[6]+v_z[7])/3.0;magn=Math.sqrt(hold_x*hold_x+hold_y*hold_y+hold_z*hold_z);center_x[13]=hold_x/magn;center_y[13]=hold_y/magn;center_z[13]=hold_z/magn;hold_x=(v_x[7]+v_x[6]+v_x[2])/3.0;hold_y=(v_y[7]+v_y[6]+v_y[2])/3.0;hold_z=(v_z[7]+v_z[6]+v_z[2])/3.0;magn=Math.sqrt(hold_x*hold_x+hold_y*hold_y+hold_z*hold_z);center_x[14]=hold_x/magn;center_y[14]=hold_y/magn;center_z[14]=hold_z/magn;hold_x=(v_x[8]+v_x[7]+v_x[2])/3.0;hold_y=(v_y[8]+v_y[7]+v_y[2])/3.0;hold_z=(v_z[8]+v_z[7]+v_z[2])/3.0;magn=Math.sqrt(hold_x*hold_x+hold_y*hold_y+hold_z*hold_z);center_x[15]=hold_x/magn;center_y[15]=hold_y/magn;center_z[15]=hold_z/magn;hold_x=(v_x[12]+v_x[9]+v_x[8])/3.0;hold_y=(v_y[12]+v_y[9]+v_y[8])/3.0;hold_z=(v_z[12]+v_z[9]+v_z[8])/3.0;magn=Math.sqrt(hold_x*hold_x+hold_y*hold_y+hold_z*hold_z);center_x[16]=hold_x/magn;center_y[16]=hold_y/magn;center_z[16]=hold_z/magn;hold_x=(v_x[12]+v_x[9]+v_x[10])/3.0;hold_y=(v_y[12]+v_y[9]+v_y[10])/3.0;hold_z=(v_z[12]+v_z[9]+v_z[10])/3.0;magn=Math.sqrt(hold_x*hold_x+hold_y*hold_y+hold_z*hold_z);center_x[17]=hold_x/magn;center_y[17]=hold_y/magn;center_z[17]=hold_z/magn;hold_x=(v_x[12]+v_x[11]+v_x[10])/3.0;hold_y=(v_y[12]+v_y[11]+v_y[10])/3.0;hold_z=(v_z[12]+v_z[11]+v_z[10])/3.0;magn=Math.sqrt(hold_x*hold_x+hold_y*hold_y+hold_z*hold_z);center_x[18]=hold_x/magn;center_y[18]=hold_y/magn;center_z[18]=hold_z/magn;hold_x=(v_x[12]+v_x[11]+v_x[7])/3.0;hold_y=(v_y[12]+v_y[11]+v_y[7])/3.0;hold_z=(v_z[12]+v_z[11]+v_z[7])/3.0;magn=Math.sqrt(hold_x*hold_x+hold_y*hold_y+hold_z*hold_z);center_x[19]=hold_x/magn;center_y[19]=hold_y/magn;center_z[19]=hold_z/magn;hold_x=(v_x[12]+v_x[8]+v_x[7])/3.0;hold_y=(v_y[12]+v_y[8]+v_y[7])/3.0;hold_z=(v_z[12]+v_z[8]+v_z[7])/3.0;magn=Math.sqrt(hold_x*hold_x+hold_y*hold_y+hold_z*hold_z);center_x[20]=hold_x/magn;center_y[20]=hold_y/magn;center_z[20]=hold_z/magn;garc=2.0*Math.asin(Math.sqrt(5-SQRT_5)/SQRT_10);gt=garc/2.0;gdve=Math.sqrt(3+SQRT_5)/Math.sqrt(5+SQRT_5);gel=SQRT_8/Math.sqrt(5+SQRT_5);}
function s_to_c(theta,phi){var c=new Object();c.x=Math.sin(theta)*Math.cos(phi);c.y=Math.sin(theta)*Math.sin(phi);c.z=Math.cos(theta);return c;}
function c_to_s(x,y,z){var s=new Object();var a;if(x>0.0&&y>0.0){a=radians(0.0);}
if(x<0.0&&y>0.0){a=radians(180.0);}
if(x<0.0&&y<0.0){a=radians(180.0);}
if(x>0.0&&y<0.0){a=radians(360.0);}
s.lat=Math.acos(z);if(x==0.0&&y>0.0){s.lng=radians(90.0);}
if(x==0.0&&y<0.0){s.lng=radians(270.0);}
if(x>0.0&&y==0.0){s.lng=radians(0.0);}
if(x<0.0&&y==0.0){s.lng=radians(180.0);}
if(x!=0.0&&y!=0.0){s.lng=Math.atan(y/x)+a;}
return s;}
function s_tri_info(x,y,z){var h_dist1,h_dist2,h_dist3,h1,h2,h3;var i,h_tri,h_lcd;var v1,v2,v3;var info=new Object();h_tri=0;h_dist1=9999.0;for(i=1;i<=20;i=i+1){h1=center_x[i]-x;h2=center_y[i]-y;h3=center_z[i]-z;h_dist2=Math.sqrt(h1*h1+h2*h2+h3*h3);if(h_dist2<h_dist1){h_tri=i;h_dist1=h_dist2;}}
info.tri=h_tri;switch(h_tri)
{case 1:v1=1;v2=3;v3=2;break;case 2:v1=1;v2=4;v3=3;break;case 3:v1=1;v2=5;v3=4;break;case 4:v1=1;v2=6;v3=5;break;case 5:v1=1;v2=2;v3=6;break;case 6:v1=2;v2=3;v3=8;break;case 7:v1=3;v2=9;v3=8;break;case 8:v1=3;v2=4;v3=9;break;case 9:v1=4;v2=10;v3=9;break;case 10:v1=4;v2=5;v3=10;break;case 11:v1=5;v2=11;v3=10;break;case 12:v1=5;v2=6;v3=11;break;case 13:v1=6;v2=7;v3=11;break;case 14:v1=2;v2=7;v3=6;break;case 15:v1=2;v2=8;v3=7;break;case 16:v1=8;v2=9;v3=12;break;case 17:v1=9;v2=10;v3=12;break;case 18:v1=10;v2=11;v3=12;break;case 19:v1=11;v2=7;v3=12;break;case 20:v1=8;v2=12;v3=7;break;}
h1=x-v_x[v1];h2=y-v_y[v1];h3=z-v_z[v1];h_dist1=Math.sqrt(h1*h1+h2*h2+h3*h3);h1=x-v_x[v2];h2=y-v_y[v2];h3=z-v_z[v2];h_dist2=Math.sqrt(h1*h1+h2*h2+h3*h3);h1=x-v_x[v3];h2=y-v_y[v3];h3=z-v_z[v3];h_dist3=Math.sqrt(h1*h1+h2*h2+h3*h3);if((h_dist1<=h_dist2)&&(h_dist2<=h_dist3)){h_lcd=1;}
if((h_dist1<=h_dist3)&&(h_dist3<=h_dist2)){h_lcd=6;}
if((h_dist2<=h_dist1)&&(h_dist1<=h_dist3)){h_lcd=2;}
if((h_dist2<=h_dist3)&&(h_dist3<=h_dist1)){h_lcd=3;}
if((h_dist3<=h_dist1)&&(h_dist1<=h_dist2)){h_lcd=5;}
if((h_dist3<=h_dist2)&&(h_dist2<=h_dist1)){h_lcd=4;}
info.hlcd=h_lcd;return info;}
function dymax_point(tri,lcd,x,y,z){var axis,v1;var h;var gs;var gx,gy,gz,ga1,ga2,ga3,ga1p,ga2p,ga3p,gxp,gyp,gzp;switch(tri)
{case 1:v1=1;break;case 2:v1=1;break;case 3:v1=1;break;case 4:v1=1;break;case 5:v1=1;break;case 6:v1=2;break;case 7:v1=3;break;case 8:v1=3;break;case 9:v1=4;break;case 10:v1=4;break;case 11:v1=5;break;case 12:v1=5;break;case 13:v1=6;break;case 14:v1=2;break;case 15:v1=2;break;case 16:v1=8;break;case 17:v1=9;break;case 18:v1=10;break;case 19:v1=11;break;case 20:v1=8;break;}
var h0=new Object();h0.x=x;h0.y=y;h0.z=z;var h1=new Object();h1.x=v_x[v1];h1.y=v_y[v1];h1.z=v_z[v1];h=c_to_s(center_x[tri],center_y[tri],center_z[tri]);axis=3;rotate3d(axis,h.lng,h0);rotate3d(axis,h.lng,h1);axis=2;rotate3d(axis,h.lat,h0);rotate3d(axis,h.lat,h1);h=c_to_s(h1.x,h1.y,h1.z);h.lng=h.lng-radians(90.0);axis=3;rotate3d(axis,h.lng,h0);gz=Math.sqrt(1-h0.x*h0.x-h0.y*h0.y);gs=Math.sqrt(5+2*SQRT_5)/(gz*SQRT_15);gxp=h0.x*gs;gyp=h0.y*gs;ga1p=2.0*gyp/SQRT_3+(gel/3.0);ga2p=gxp-(gyp/SQRT_3)+(gel/3.0);ga3p=(gel/3.0)-gxp-(gyp/SQRT_3);ga1=gt+Math.atan((ga1p-0.5*gel)/gdve);ga2=gt+Math.atan((ga2p-0.5*gel)/gdve);ga3=gt+Math.atan((ga3p-0.5*gel)/gdve);gx=0.5*(ga2-ga3);gy=(1.0/(2.0*SQRT_3))*(2*ga1-ga2-ga3);var pt=new Object();pt.x=gx/garc;pt.y=gy/garc;var point2d=new Object();switch(tri)
{case 1:rotate2d(240.0,pt);point2d.x=pt.x+2.0;point2d.y=pt.y+7.0/(2.0*SQRT_3);break;case 2:rotate2d(300.0,pt);point2d.x=pt.x+2.0;point2d.y=pt.y+5.0/(2.0*SQRT_3);break;case 3:rotate2d(0.0,pt);point2d.x=pt.x+2.5;point2d.y=pt.y+2.0/SQRT_3;break;case 4:rotate2d(60.0,pt);point2d.x=pt.x+3.0;point2d.y=pt.y+5.0/(2.0*SQRT_3);break;case 5:rotate2d(180.0,pt);point2d.x=pt.x+2.5;point2d.y=pt.y+4.0*SQRT_3/3.0;break;case 6:rotate2d(300.0,pt);point2d.x=pt.x+1.5;point2d.y=pt.y+4.0*SQRT_3/3.0;break;case 7:rotate2d(300.0,pt);point2d.x=pt.x+1.0;point2d.y=pt.y+5.0/(2.0*SQRT_3);break;case 8:rotate2d(0.0,pt);point2d.x=pt.x+1.5;point2d.y=pt.y+2.0/SQRT_3;break;case 9:if(lcd>2)
{rotate2d(300.0,pt);point2d.x=pt.x+1.5;point2d.y=pt.y+1.0/SQRT_3;}
else
{rotate2d(0.0,pt);point2d.x=pt.x+2.0;point2d.y=pt.y+1.0/(2.0*SQRT_3);}
break;case 10:rotate2d(60.0,pt);point2d.x=pt.x+2.5;point2d.y=pt.y+1.0/SQRT_3;break;case 11:rotate2d(60.0,pt);point2d.x=pt.x+3.5;point2d.y=pt.y+1.0/SQRT_3;break;case 12:rotate2d(120.0,pt);point2d.x=pt.x+3.5;point2d.y=pt.y+2.0/SQRT_3;break;case 13:rotate2d(60.0,pt);point2d.x=pt.x+4.0;point2d.y=pt.y+5.0/(2.0*SQRT_3);break;case 14:rotate2d(0.0,pt);point2d.x=pt.x+4.0;point2d.y=pt.y+7.0/(2.0*SQRT_3);break;case 15:rotate2d(0.0,pt);point2d.x=pt.x+5.0;point2d.y=pt.y+7.0/(2.0*SQRT_3);break;case 16:if(lcd<4)
{rotate2d(60.0,pt);point2d.x=pt.x+0.5;point2d.y=pt.y+1.0/SQRT_3;}
else
{rotate2d(0.0,pt);point2d.x=pt.x+5.5;point2d.y=pt.y+2.0/SQRT_3;}
break;case 17:rotate2d(0.0,pt);point2d.x=pt.x+1.0;point2d.y=pt.y+1.0/(2.0*SQRT_3);break;case 18:rotate2d(120.0,pt);point2d.x=pt.x+4.0;point2d.y=pt.y+1.0/(2.0*SQRT_3);break;case 19:rotate2d(120.0,pt);point2d.x=pt.x+4.5;point2d.y=pt.y+2.0/SQRT_3;break;case 20:rotate2d(300.0,pt);point2d.x=pt.x+5.0;point2d.y=pt.y+5.0/(2.0*SQRT_3);break;}
return point2d;}
function rotate2d(angle,point2d){var ha,hx,hy;ha=radians(angle);hx=point2d.x;hy=point2d.y;point2d.x=hx*Math.cos(ha)-hy*Math.sin(ha);point2d.y=hx*Math.sin(ha)+hy*Math.cos(ha);return point2d;}
function rotate3d(axis,alpha,point3d){var a=point3d.x;var b=point3d.y;var c=point3d.z;if(axis==1){point3d.y=b*Math.cos(alpha)+c*Math.sin(alpha);point3d.z=c*Math.cos(alpha)-b*Math.sin(alpha);}
if(axis==2){point3d.x=a*Math.cos(alpha)-c*Math.sin(alpha);point3d.z=a*Math.sin(alpha)+c*Math.cos(alpha);}
if(axis==3){point3d.x=a*Math.cos(alpha)+b*Math.sin(alpha);point3d.y=b*Math.cos(alpha)-a*Math.sin(alpha);}
return point3d;}
init_stuff();;(function($){var map=window.site.map=new function()
{this.width=$('#interface').width();this.height=$('#interface').height();this.map;this.soundLayer;this.init=function()
{var self=this;if(!OpenLayers.CANVAS_SUPPORTED)
{site.outputError('Your browser does not support canvas, nothing to see here!');}
OpenLayers.Projection.addTransform("EPSG:4326","DYMAX",self.projectForward);var countries=self.countriesLayer();var triFill=self.dymaxTriFill();self.map=self.createMap();self.map.addLayers([triFill,countries]);self.map.zoomTo(2.5);self.addDymaxFeaturesToLayer(triFill);self.soundLayer=self.get_data_layers();self.map.addLayers(self.soundLayer);};this.createMap=function()
{var self=this;var map=new OpenLayers.Map("map",{projection:new OpenLayers.Projection("DYMAX"),maxExtent:new OpenLayers.Bounds(-50,50,860,420),allOverlays:true,controls:[new OpenLayers.Control.Navigation({dragPanOptions:{enableKinetic:false,},zoomWheelEnabled:false}),new OpenLayers.Control.Attribution(),],});return map;};this.addSound=function(geojson)
{var self=this;var layer=self.map.getLayersBy('name','sounds')[0];var format=new OpenLayers.Format.GeoJSON();var collection='{"type":"FeatureCollection", "features":'+geojson+'}';var features=format.read(collection);layer.addFeatures(features);layer.refresh();return layer;};this.get_data_layers=function()
{var self=this;var layers=[];for(var key in DATA_LAYERS){var layer_info=DATA_LAYERS[key];var layer=new OpenLayers.Layer.Vector(layer_info['title'],{projection:new OpenLayers.Projection("EPSG:4326"),strategies:[new OpenLayers.Strategy.Fixed()],protocol:new OpenLayers.Protocol.HTTP({url:layer_info['url'],format:new OpenLayers.Format.GeoJSON(),}),style:{'fillColor':'#000000','fillOpacity':1,'pointRadius':2,'stroke':false},renderers:["Canvas"]});layer.events.register("loadend",layer,function()
{site.ffinterface.map_points=[];for(var i=0;i<layer.features.length;i++)
{self.pushPointToInterface(layer.features[i],layer);}
if(site.ffinterface.running==false)
{site.ffinterface.init();}
$('#map').hide();$('#interface').show();});layers.push(layer);}
return layers;};this.pushPointToInterface=function(feature,layer)
{var self=this;var coordinates=self.getGeometryFromFeature(feature,layer);var map_point={x:coordinates[0],y:coordinates[1],id:feature.data.id,title:feature.data.title,location:feature.data.location,created_by:feature.data.created_by,story:feature.data.story,filename:feature.data.filename,volume:feature.data.volume,z:feature.data.z,is_recent:feature.data.is_recent,};site.ffinterface.map_points.push(map_point);};this.getGeometryFromFeature=function(feature,layer)
{return layer.renderer.getLocalXY(feature.geometry);};this.addDymaxFeaturesToLayer=function(layer)
{var self=this;var triData=self.dymaxTriData();var triFeatures=[];var triDashedFeatures=[];for(var i=0;i<triData.length;i++)
{var lineGeom=new OpenLayers.Geometry.LinearRing([new OpenLayers.Geometry.Point(triData[i][0][0],triData[i][0][1]),new OpenLayers.Geometry.Point(triData[i][1][0],triData[i][1][1]),new OpenLayers.Geometry.Point(triData[i][2][0],triData[i][2][1]),new OpenLayers.Geometry.Point(triData[i][0][0],triData[i][0][1])]);triFeatures.push(new OpenLayers.Feature.Vector(new OpenLayers.Geometry.Polygon([lineGeom])));}
layer.addFeatures(triFeatures);};this.dymaxTriData=function()
{var triData=[[[75,0],[225,0],[150,130]],[[225,0],[300,130],[150,130]],[[300,130],[450,130],[375,0]],[[450,130],[600,130],[525,0]],[[600,130],[675,0],[525,0]],[[75,260],[225,260],[150,130]],[[225,260],[300,130],[150,130]],[[225,260],[375,260],[300,130]],[[375,260],[450,130],[300,130]],[[375,260],[525,260],[450,130]],[[525,260],[600,130],[450,130]],[[525,260],[675,260],[600,130]],[[675,260],[750,130],[600,130]],[[675,260],[825,260],[750,130]],[[150,390],[300,390],[225,260]],[[300,390],[375,260],[225,260]],[[300,390],[450,390],[375,260]],[[600,390],[675,260],[525,260]],[[750,390],[825,260],[675,260]]];return triData;};this.dymaxTriStrokes=function()
{var layer=new OpenLayers.Layer.Vector("Triangle strokes",{projection:new OpenLayers.Projection("DYMAX"),style:{'fillColor':'#c8ebff','fillOpacity':0,'strokeColor':'#ededed','strokeWidth':.5,'strokeOpacity':1,'strokeDashstyle':'longdash'},renderers:["Canvas"]});return layer;};this.dymaxTriFill=function()
{var layer=new OpenLayers.Layer.Vector("Triangle fills",{projection:new OpenLayers.Projection("DYMAX"),style:{'fillColor':'transparent','fillOpacity':1,'strokeColor':'#0099cc','strokeWidth':1,'strokeOpacity':0},renderers:["Canvas"]});return layer;};this.citiesLayer=function()
{var layer=new OpenLayers.Layer.Vector("World cities",{projection:new OpenLayers.Projection("EPSG:4326"),strategies:[new OpenLayers.Strategy.Fixed()],protocol:new OpenLayers.Protocol.HTTP({url:MEDIA_URL+"data/93211.kml",format:new OpenLayers.Format.KML()}),style:{'fillColor':'#b2b2b2','fillOpacity':1,'pointRadius':1,'stroke':false},renderers:["Canvas"]});return layer;};this.countriesLayer=function()
{var layer=new OpenLayers.Layer.Vector("World countries",{projection:new OpenLayers.Projection("EPSG:4326"),strategies:[new OpenLayers.Strategy.Fixed()],protocol:new OpenLayers.Protocol.HTTP({url:MEDIA_URL+"data/worldCountries.kml",format:new OpenLayers.Format.KML()}),style:{'fillColor':'#ededed','fillOpacity':1,'strokeColor':'#fff','strokeWidth':0.7},renderers:["Canvas"]});return layer;};this.codeLatLng=function(lat,lon)
{var geocoder=new google.maps.Geocoder();lat=parseFloat(lat);lon=parseFloat(lon);var latlng=new google.maps.LatLng(lat,lon);geocoder.geocode({'latLng':latlng},function(results,status){if(status==google.maps.GeocoderStatus.OK){if(results[1]){lib.log(results);}}else{lib.log(status);}});};this.codeAddress=function(address)
{var geocoder=new google.maps.Geocoder();geocoder.geocode({'address':address},function(results,status)
{if(status==google.maps.GeocoderStatus.OK){var lat=results[0].geometry.location.lat();var lon=results[0].geometry.location.lng();return[lat,lon];}else{lib.log(status);}});};this.projectForward=function(point)
{var convertedPoint=convert_s_t_p(point.x,point.y);point.x=convertedPoint.x*150;point.y=convertedPoint.y*150;return point;};};})(jQuery);;(function($){site.Player=function(id,index,file,volume)
{this.id=id,this.index=index,this.file=MEDIA_URL+file,this.volume=volume;this.playerId='player_'+index+'_'+id;this.$player;this.loaded;this.interval;};site.Player.prototype.init=function()
{var self=this;$('#container').append('<div id="'+self.playerId+'"></div>');self.$player=$('#'+self.playerId);self.$player.jPlayer({ready:function(){$(this).jPlayer("setMedia",{mp3:self.file});},volume:self.volume,swfPath:MEDIA_URL+"js/lib",solution:"flash, html",supplied:"mp3",preload:'auto',wmode:"window"});};site.Player.prototype.updateVolume=function(volume)
{var self=this;self.volume=volume;self.$player.jPlayer('volume',self.volume);};site.Player.prototype.updatePlayhead=function(position)
{var self=this;self.$player.jPlayer('playHead',position);};site.Player.prototype.play=function()
{var self=this;self.$player.jPlayer("playHead",0).jPlayer("play");};site.Player.prototype.stop=function()
{var self=this;self.$player.jPlayer('stop');};site.Player.prototype.pause=function()
{var self=this;self.$player.jPlayer('pause');};site.Player.prototype.destroy=function()
{var self=this;self.$player.jPlayer('destory');};})(jQuery);;(function($){var ffinterface=window.site.ffinterface=new function()
{this.running=false;this.frameRate;this.width;this.height;this.lastClick=-1;this.sphere;this.rotation;this.rotation_interval;this.base_distance=2000;this.distance=2000;this.map_points=[];this.points_2D=[];this.connections_2D=[];this.constellation;this.map_points_count;this.stage;this.points_layer;this.connections_layer;this.playhead_layer;this.rotation_layer;this.playhead=0;this.addButton=0;this.is_playing=false;this.playheadCount=0;this.playheadIntervals=20;this.zoom=1.0;this.search_results={'Geosounds':[],'Constellations':[]};this.init=function()
{var self=this;self.rotation={x:0,y:0,z:0};self.width=$('#interface').width();self.height=$('#interface').height();self.sphere=new self.Sphere3D();self.stage=new Kinetic.Stage({container:"interface",width:self.width,height:self.height,});self.rotation_layer=new Kinetic.Layer();self.points_layer=new Kinetic.Layer();self.connections_layer=new Kinetic.Layer();self.playhead_layer=new Kinetic.Layer();self.setup();self.framerate=1000/30;setInterval(function(){self.update();self.draw();},self.framerate);self.running=true;};this.resetRotation=function()
{var self=this;var rotation=self.rotation;self.rotateTo(0,0,0,1.0,function()
{$('#interface').fadeOut(2000);$('#map').css('opacity','1');$('#map').fadeIn(500);});};this.rotateTo=function(x,y,z,zoom,callback)
{var self=this;clearInterval(self.rotation_interval)
self.rotation_interval=setInterval(function()
{self.rotation.x=self.rotateAxis(self.rotation.x,x,25);self.rotation.y=self.rotateAxis(self.rotation.y,y,25);self.rotation.z=self.rotateAxis(self.rotation.z,z,25);self.zoom=self.rotateAxis(self.zoom,zoom,100);if(self.rotation.x==x&&self.rotation.y==y&&self.rotation.z==z&&self.zoom==zoom)
{clearInterval(self.rotation_interval);callback();}},self.frameRate);};this.rotateAxis=function(current,target,pace)
{var self=this;var difference=Math.abs(current-target);var multiplier=(current>target)?-1:1;return(difference>self.deg_to_rad(1))?current+multiplier*difference/pace:target;};this.changeZoom=function(amount)
{var self=this;self.zoom+=amount;self.zoom=(self.zoom>15.0)?15.0:self.zoom;self.zoom=(self.zoom<1.0)?1.0:self.zoom;};this.setup=function()
{var self=this;for(var i=0;i<self.map_points.length;i++)
{self.mapPointToSpherePoint(self.map_points[i]);}
self.map_points_count=self.map_points.length;self.playhead();self.setupStageDragging();self.sphereRefresh();self.playerToggleControl();self.initPoints();$("#loadingGif").fadeToggle("fast","linear");}
this.mapPointToSpherePoint=function(map_point)
{var self=this;p=new self.Point3D();p.z=map_point.z;p.x=self.reverse_projection(map_point.x,p.z,self.width/2.0,100.0,self.distance);p.y=self.reverse_projection(map_point.y,p.z,self.height/2.0,100.0,self.distance);p.id=map_point.id;p.title=map_point.title;p.created_by=map_point.created_by;p.location=map_point.location;p.story=map_point.story;p.filename=map_point.filename;p.volume=map_point.volume;p.is_recent=map_point.is_recent;self.sphere.point.push(p);var index=self.sphere.point.length-1;self.addSpherePointToPoints2D(p,index);var new_2d_point=self.points_2D[index];self.addPointToLayer(new_2d_point);};this.initPoints=function()
{var self=this;self.stage.add(self.points_layer);for(var i=0;i<self.sphere.connections.length;i++)
{self.addConnectionToLayer(self.sphere.connections[i]);}
self.stage.add(self.connections_layer);}
this.getActiveConnections=function()
{var self=this;return self.sphere.connections;};this.loadConstellation=function(id,rotate)
{var self=this;self.clearConnections();for(var i=0;i<CONSTELLATIONS.length;i++)
{if(CONSTELLATIONS[i].pk==id)
{var constellation=CONSTELLATIONS[i].fields;if(rotate)
{self.rotateTo(constellation.rotation_x,constellation.rotation_y,constellation.rotation_z,constellation.zoom,function(){});}
for(var j=0;j<constellation.connections.length;j++)
{var db_connection=constellation.connections[j].fields;var connection=new self.Connection3D();connection.sound_1=db_connection.sound_1;connection.sound_2=db_connection.sound_2;connection.index_1=self.getPointIndexFromId(db_connection.sound_1);connection.index_2=self.getPointIndexFromId(db_connection.sound_2);self.sphere.connections.push(connection);self.addConnectionToLayer(connection);}}}};this.clearConnections=function()
{var self=this;self.connections_2D=[];self.sphere.connections=[];self.connections_layer.removeChildren();};this.getPointIndexFromId=function(sound_id)
{var self=this;for(var j=0;j<self.points_2D.length;j++)
{var point=self.points_2D[j];if(point.id==sound_id)
{return point.index;}}};this.update=function()
{var self=this;var rotation=self.rotation;var rotation_canvas=self.rotation_layer.getChildren()[0];if(rotation_canvas.isDragging()){clearInterval(self.rotation_interval);var mousePos=self.stage.getMousePosition();var s=10;var x=((mousePos.x*2*s)-self.width*s)/self.width;var y=((mousePos.y*2*s)-self.height*s)/self.height;rotationYAmount=self.deg_to_rad(Math.abs(x))/self.zoom;rotation.y+=rotationYAmount;rotation.y=(rotation.y>=self.deg_to_rad(360))?self.deg_to_rad(0):rotation.y;rotationXAmount=self.deg_to_rad(Math.abs(y))/self.zoom;rotation.x+=rotationXAmount;rotation.x=(rotation.x>=self.deg_to_rad(360))?self.deg_to_rad(0):rotation.x;}
$('#interface').mousewheel(function(event,delta,deltaX,deltaY)
{self.changeZoom(deltaY/10000);});self.distance=self.base_distance*self.zoom;var playhead=self.playhead_layer.getChildren()[0];var radius=playhead.getRadius();if(self.is_playing)
{radius=(radius.x<self.width/2)?radius.x+1:0;playhead.setRadius(radius);}
var sounds=self.points_layer.getChildren();for(var i=0;i<sounds.length;i++)
{var sound=sounds[i];var player=sound.getAttrs().player;var distance_from_center=self.dist(sound.getX(),sound.getY(),self.width/2,self.height/2);if(distance_from_center==radius)
{if(sound.getAttrs().active==true)
{player.stop();player.play();sound.getChildren()[1].setFill("#005fff");}}}
if(self.map_points.length>self.map_points_count)
{lib.log("a sound was added");self.map_points_count=self.map_points.length;self.mapPointToSpherePoint(self.map_points[self.map_points_count-1]);}
self.styleAllSearchedSoundShapes();if(self.search_results.Constellations.length>0)
{var searched_constellations=self.search_results.Constellations;}
self.sphereRefresh();}
this.draw=function()
{var self=this;self.points_layer.clear();self.connections_layer.clear();for(var i=0;i<self.points_layer.getChildren().length;i++)
{var point=self.points_2D[i];var sound=self.points_layer.getChildren()[i];var halo=sound.getChildren()[0];var core=sound.getChildren()[1];sound.setX(point.x);sound.setY(point.y);var attrs=sound.getAttrs();attrs.point_3d.x=point.point_3d.x;attrs.point_3d.y=point.point_3d.y;attrs.point_3d.z=point.point_3d.z;sound.setAttrs(attrs);}
for(var i=0;i<self.connections_layer.getChildren().length;i++)
{var connection=self.sphere.connections[i];var child=self.connections_layer.getChildren()[i];var p1=self.points_2D[connection.index_1];var p2=self.points_2D[connection.index_2];child.setPoints([{x:p1.x,y:p1.y},{x:p2.x,y:p2.y}]);}
self.rotation_layer.draw();self.points_layer.draw();self.connections_layer.draw();self.playhead_layer.clear();self.playhead_layer.draw();}
this.addPointToLayer=function(point)
{var self=this;var radius=self.map(point.sphere_point.volume,0.2,0.8,5,20,true);var sound=new Kinetic.Group({x:point.x,y:point.y,alpha:0.4,point_3d:point.point_3d,data:point.sphere_point,index:point.index,id:point.id,active:false,draggable:true,dragBounds:{top:0,right:0,bottom:0,left:0},start_x:0,start_y:0,name:point.sphere_point.created_by,location:point.sphere_point.location,story:point.sphere_point.story,isNew:point.sphere_point.is_recent,justAdded:false,player:'',timeout:'',interval:'',});sound.on("mouseover",function()
{$('#container').css({'cursor':'pointer'});$('.soundText').html(this.getAttrs().name+'<br/>'+this.getAttrs().location+'<br/><div class="story">'+this.getAttrs().story+'</div>').css({'top':(this.getAttrs().y-110)+'px','left':(this.getAttrs().x-27)+'px'}).fadeIn("400");if(this.getAttrs().story==""){$('.story').css('display','none');}
if(!this.getAttrs().active)
{this.setAlpha(1);}});sound.on("mouseout",function()
{clearTimeout(sound.timeout);clearInterval(sound.interval);$('#container').css({'cursor':'default'});$('.soundText').fadeOut("400");if(!this.getAttrs().active)
{this.setAlpha(0.4);}});sound.on("mouseup",function()
{clearTimeout(sound.timeout);clearInterval(sound.interval);});sound.on("mousedown",function()
{if(self.soundShapeConnectsToExistingConnection(this))
{this.getAttrs().active=true;}
else
{this.getAttrs().active=!this.getAttrs().active;}
if(this.getAttrs().active)
{if(this.getAttrs().player=='')
{var player=new site.Player(this.getAttrs().id,this.getAttrs().index,this.getAttrs().data.filename,0.8);this.setAttrs({player:player});this.getAttrs().player.init();}
this.getChildren()[1].setFill('#005fff');var shape=this;this.timeout=setTimeout(function()
{var halo=shape.getChildren()[0];var radius=halo.getRadius().x;sound.interval=setInterval(function()
{radius=(radius<=20)?radius+0.1:5;halo.setRadius(radius);},self.frameRate);},500);if(self.lastClick==-1)
{if(self.getActiveConnections().length>0)
{self.styleAllOtherActiveSoundShapes(this,'white');}
else
{self.styleAllInactiveSoundShapes('white');}}
else
{if(self.getActiveConnections().length==0)
{c=self.connectTwoSoundShapes(self.lastClick,this);if(self.addButton==0)
{$('#addConstellationText').fadeToggle("fast","linear");self.addButton=1;}
var sound_1_distance_from_center=self.dist(self.lastClick.getX(),self.lastClick.getY(),self.width/2,self.height/2);var sound_2_distance_from_center=self.dist(this.getX(),this.getY(),self.width/2,self.height/2);var closest_distance=(sound_1_distance_from_center<sound_2_distance_from_center)?sound_1_distance_from_center:sound_2_distance_from_center;var playhead=self.playhead_layer.getChildren()[0];playhead.setRadius(closest_distance);self.is_playing=true;}
else
{if(self.soundShapeConnectsToExistingConnection(this)==false&&self.soundShapeConnectsToExistingConnection(self.lastClick)==true)
{c=self.connectTwoSoundShapes(self.lastClick,this);}
if(self.soundShapeConnectsToExistingConnection(this)==true&&self.soundShapeConnectsToExistingConnection(self.lastClick)==false)
{c=self.connectTwoSoundShapes(self.lastClick,this);}
if(self.soundShapeConnectsToExistingConnection(this)==true&&self.soundShapeConnectsToExistingConnection(self.lastClick)==true)
{c=self.connectTwoSoundShapes(self.lastClick,this);}}}
self.lastClick=this;}
else
{this.getChildren()[1].setFill('#000');this.player.destroy();}});var halo=new Kinetic.Circle({radius:radius,fill:"#ccc",stroke:"white",strokeWidth:0,});var core=new Kinetic.Circle({radius:2,fill:"black",stroke:"transparent",strokeWidth:0,});if(sound.getAttrs().isNew){halo.setFill('#666');}
sound.add(halo);sound.add(core);self.points_layer.add(sound);};this.connectTwoSoundShapes=function(soundShape_1,soundShape_2)
{var self=this;c=self.newConnectionFromTwoSoundShapes(soundShape_1,soundShape_2);var sound_1=self.points_layer.getChildren()[c.index_1];var sound_2=self.points_layer.getChildren()[c.index_2];sound_1.getAttrs().player.play();sound_2.getAttrs().player.play();self.styleAllInactiveSoundShapes('white');};this.soundShapeConnectsToExistingConnection=function(soundShape)
{var self=this;for(var i=0;i<self.sphere.connections.length;i++)
{var c=self.sphere.connections[i];if(soundShape.getAttrs().index==c.index_1||soundShape.getAttrs().index==c.index_2)
{return true;}}
return false;};this.styleAllOtherActiveSoundShapes=function(clickedSoundShape,color)
{var self=this;var allSoundsShapes=self.points_layer.getChildren();for(var i=0;i<allSoundsShapes.length;i++)
{var soundShape=allSoundsShapes[i];if(soundShape.getAttrs().active&&i!=clickedSoundShape.getAttrs().index)
{soundShape.getChildren()[1].setFill(color);}
else
{soundShape.getChildren()[1].setFill('black');}}};this.styleAllInactiveSoundShapes=function(color)
{var self=this;var allSoundsShapes=self.points_layer.getChildren();for(var i=0;i<allSoundsShapes.length;i++)
{var soundShape=allSoundsShapes[i];if(!soundShape.getAttrs().active)
{soundShape.getChildren()[1].setFill(color);}
else
{soundShape.getChildren()[1].setFill('black');}}};this.styleAllSearchedSoundShapes=function()
{var self=this;var allSoundsShapes=self.points_layer.getChildren();var searched_sounds=self.search_results.Geosounds;for(var i=0;i<allSoundsShapes.length;i++)
{var soundShape=allSoundsShapes[i];if(searched_sounds.length>0)
{for(var j=0;j<searched_sounds.length;j++)
{var searched_sound=searched_sounds[j];if(soundShape.getAttrs().id==searched_sound.id)
{var searchScore=Math.round((searched_sound.score/5)*255)*10;soundShape.getChildren()[0].setFill('rgb('+searchScore+',0,0)');break;}
else
{soundShape.getChildren()[0].setFill("#ccc");}}}
else
{soundShape.getChildren()[0].setFill("#ccc");}}};this.newConnectionFromTwoSoundShapes=function(soundShape_1,soundShape_2)
{var self=this;c=new self.Connection3D();c.sound_1=soundShape_1.getAttrs().id;c.sound_2=soundShape_2.getAttrs().id;c.index_1=soundShape_1.getAttrs().index;c.index_2=soundShape_2.getAttrs().index;self.sphere.connections.push(c);self.addConnectionToLayer(c);return c;};this.playerToggleControl=function()
{var self=this;$(window).keypress(function(e)
{if(e.keyCode==8||e.keyCode==13||e.keyCode==27||e.keyCode==32)
{self.is_playing=!self.is_playing;var sounds=self.points_layer.getChildren();for(var i=0;i<sounds.length;i++)
{var sound=sounds[i];var player=sound.getAttrs().player;(self.is_playing)?player.play():player.pause();}}});};this.playhead=function()
{var self=this;self.stripes=new Image();self.stripes.src=MEDIA_URL+"images/stripes_5.png";var playhead=new Kinetic.Circle({x:self.width/2,y:self.height/2,alpha:0.8,radius:0,fill:{image:self.stripes,offset:[0,0]},stroke:"#efefef",strokeWidth:.25,});self.playhead_layer.add(playhead);self.stage.add(self.playhead_layer);};this.addConnectionToLayer=function(connection)
{var self=this;var p1=self.points_2D[connection.index_1];var p2=self.points_2D[connection.index_2];var line=new Kinetic.Line({points:[p1.x,p1.y,p2.x,p2.y],stroke:"#005fff",strokeWidth:0.25,lineCap:"round",lineJoin:"round",});self.connections_layer.add(line);};this.setupStageDragging=function()
{var self=this;var rotationCanvas=new Kinetic.Rect({x:0,y:0,width:self.width,height:self.height,fill:"transparent",draggable:true,dragBounds:{top:0,right:0,bottom:0,left:0}});rotationCanvas.on("mousedown",function()
{self.lastClick=-1;lib.log('resetting last click');self.styleAllInactiveSoundShapes('black');$(".soundText").fadeOut(200);});self.rotation_layer.add(rotationCanvas);self.stage.add(self.rotation_layer);}
this.Point3D=function()
{this.x=0;this.y=0;this.z=0;this.id;this.title;this.created_by;this.location;this.story;this.filename;this.volume;this.is_recent;}
this.Connection3D=function()
{this.sound_1=0;this.sound_2=0;this.index_1=0;this.index_2=0;}
this.Sphere3D=function(radius)
{var self=this;this.point=new Array();this.connections=new Array();this.radius=(typeof(radius)=="undefined")?10.0:radius;this.radius=(typeof(radius)!="number")?10.0:radius;}
this.sphereRefresh=function()
{var self=this;self.points_2D=[];for(var i=0;i<self.sphere.point.length;i++)
{var point=self.sphere.point[i];self.addSpherePointToPoints2D(point,i);}}
this.addSpherePointToPoints2D=function(sphere_point,index)
{var self=this;var coordinates=self.project3dPoint(sphere_point);self.points_2D.push({x:coordinates.x_2d,y:coordinates.y_2d,point_3d:coordinates.point_3d,index:index,id:sphere_point.id,sphere_point:sphere_point});};this.project3dPoint=function(point)
{var self=this;var rotation=self.rotation;var p=new self.Point3D();p.x=point.x;p.y=point.y;p.z=point.z;self.rotateX(p,rotation.x);self.rotateY(p,rotation.y);self.rotateZ(p,rotation.z);var x=self.projection(p.x,p.z,self.width/2.0,100.0,self.distance);var y=self.projection(p.y,p.z,self.height/2.0,100.0,self.distance);return{x_2d:x,y_2d:y,point_3d:p};}
this.rotateX=function(point,radians){var y=point.y;point.y=(y*Math.cos(radians))+(point.z*Math.sin(radians)*-1.0);point.z=(y*Math.sin(radians))+(point.z*Math.cos(radians));return point;}
this.rotateY=function(point,radians){var x=point.x;point.x=(x*Math.cos(radians))+(point.z*Math.sin(radians)*-1.0);point.z=(x*Math.sin(radians))+(point.z*Math.cos(radians));return point;}
this.rotateZ=function(point,radians){var x=point.x;point.x=(x*Math.cos(radians))+(point.y*Math.sin(radians)*-1.0);point.y=(x*Math.sin(radians))+(point.y*Math.cos(radians));return point;}
this.projection=function(xy,z,xyOffset,zOffset,distance){return((distance*xy)/(z-zOffset))+xyOffset;}
this.reverse_projection=function(xy_2d,z_3d,xyOffset,zOffset,distance)
{return((xy_2d*z_3d)-(xy_2d*zOffset)-(xyOffset*z_3d)+(xyOffset*zOffset))/distance;}
this.deg_to_rad=function(degrees)
{return degrees*Math.PI/180.0;}
this.map=function(value,istart,istop,ostart,ostop,confine)
{var result=ostart+(ostop-ostart)*((value-istart)/(istop-istart));if(confine)
{result=(result>ostop)?ostop:result;result=(result<ostart)?ostart:result;}
return result;}
this.dist=function(x1,y1,x2,y2)
{return Math.round(Math.sqrt((x2-x1)*(x2-x1)+(y2-y1)*(y2-y1)));}};})(jQuery);